{% extends 'fcp_app/base.html' %}
{% load static %}

{% block title %}Valeurs Liquidatives - FCP Reporting{% endblock %}

{% block extra_css %}
<style>
    /* Tabs Styling */
    .nav-tabs-custom {
        border-bottom: 2px solid var(--border-color);
        gap: 8px;
    }
    
    .nav-tabs-custom .nav-link {
        border: none;
        color: var(--text-secondary);
        font-weight: 500;
        padding: 12px 20px;
        border-radius: 8px 8px 0 0;
        transition: all 0.2s ease;
        position: relative;
    }
    
    .nav-tabs-custom .nav-link:hover {
        color: var(--primary-color);
        background: var(--third-color);
    }
    
    .nav-tabs-custom .nav-link.active {
        color: var(--primary-color);
        background: var(--bg-primary);
        border-bottom: 3px solid var(--primary-color);
    }
    
    /* Filter Pills */
    .filter-pills {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
    }
    
    .filter-pill {
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 500;
        border: 1px solid var(--border-color);
        background: var(--bg-primary);
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .filter-pill:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
    }
    
    .filter-pill.active {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }
    
    /* Chart Container */
    .chart-container {
        position: relative;
        height: 350px;
        width: 100%;
    }
    
    .chart-container-scatter {
        position: relative;
        height: 300px;
        width: 100%;
    }
    
    /* Toggle Switch */
    .toggle-option {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: var(--bg-secondary);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .toggle-option:hover {
        background: var(--third-color);
    }
    
    .toggle-option.active {
        background: var(--primary-light);
        color: var(--primary-color);
    }
    
    .form-check-input:checked {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    /* Metric Cards */
    .metric-card {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        transition: all 0.2s ease;
    }
    
    .metric-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }
    
    .metric-card .metric-label {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-muted);
        margin-bottom: 8px;
    }
    
    .metric-card .metric-value {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-primary);
    }
    
    .metric-card .metric-change {
        font-size: 13px;
        margin-top: 6px;
    }
    
    .metric-card .metric-change.positive {
        color: var(--success-color);
    }
    
    .metric-card .metric-change.negative {
        color: var(--danger-color);
    }
    
    /* Section Headers */
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 16px;
    }
    
    .section-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .section-title i {
        color: var(--primary-color);
    }
    
    /* Options Bar */
    .options-bar {
        display: flex;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
    }
    
    /* Select Custom */
    .select-custom {
        padding: 8px 32px 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 13px;
        color: var(--text-primary);
        background: var(--bg-primary);
        cursor: pointer;
        min-width: 160px;
    }
    
    .select-custom:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(0, 64, 128, 0.1);
    }
    
    /* Legend Custom */
    .chart-legend {
        display: flex;
        justify-content: center;
        gap: 24px;
        margin-top: 16px;
        flex-wrap: wrap;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: var(--text-secondary);
    }
    
    .legend-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }
    
    .legend-line {
        width: 24px;
        height: 3px;
        border-radius: 2px;
    }
    
    /* Scatter Point Labels */
    .scatter-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: var(--bg-secondary);
        border-radius: 8px;
        margin-top: 16px;
    }
    
    .scatter-info-item {
        text-align: center;
    }
    
    .scatter-info-item .label {
        font-size: 11px;
        text-transform: uppercase;
        color: var(--text-muted);
    }
    
    .scatter-info-item .value {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
    }
</style>
{% endblock %}

{% block content %}
<!-- Navigation Tabs -->
<ul class="nav nav-tabs nav-tabs-custom mb-4" id="vlTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
            <i class="bi bi-grid-1x2-fill me-2"></i>Vue d'ensemble
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="performances-tab" data-bs-toggle="tab" data-bs-target="#performances" type="button" role="tab">
            <i class="bi bi-trophy me-2"></i>Performances
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">
            <i class="bi bi-table me-2"></i>Historique
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="analysis-tab" data-bs-toggle="tab" data-bs-target="#analysis" type="button" role="tab">
            <i class="bi bi-bar-chart-line me-2"></i>Analyse
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="risk-tab" data-bs-toggle="tab" data-bs-target="#risk" type="button" role="tab">
            <i class="bi bi-shield-exclamation me-2"></i>Risque
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="vlTabsContent">
    <!-- Vue d'ensemble Tab -->
    <div class="tab-pane fade show active" id="overview" role="tabpanel">
        
        <!-- Évolution VL Section -->
        <div class="card mb-4">
            <div class="card-body">
                <!-- Header with filters -->
                <div class="section-header">
                    <div class="section-title">
                        <i class="bi bi-graph-up"></i>
                        <span>Évolution de la Valeur Liquidative</span>
                    </div>
                    
                    <div class="options-bar">
                        <!-- FCP Selector -->
                        <select class="select-custom" id="fcpSelector">
                            {% for fcp_name in fcp_list %}
                            <option value="{{ fcp_name }}" {% if fcp_name == selected_fcp %}selected{% endif %}>{{ fcp_name }}</option>
                            {% endfor %}
                        </select>
                        
                        <!-- Benchmark Toggle -->
                        <label class="toggle-option" id="benchmarkToggle">
                            <input class="form-check-input" type="checkbox" id="showBenchmark">
                            <span>Benchmark</span>
                        </label>
                        
                        <!-- Cumulative Toggle -->
                        <label class="toggle-option" id="cumulativeToggle">
                            <input class="form-check-input" type="checkbox" id="showCumulative">
                            <span>Vue Cumulée</span>
                        </label>
                    </div>
                </div>
                
                <!-- Period Filters -->
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
                    <div class="filter-pills" id="periodFilters">
                        <button class="filter-pill" data-period="1m">1M</button>
                        <button class="filter-pill" data-period="3m">3M</button>
                        <button class="filter-pill" data-period="6m">6M</button>
                        <button class="filter-pill active" data-period="1y">1A</button>
                        <button class="filter-pill" data-period="5y">5A</button>
                        <button class="filter-pill" data-period="all">Tout</button>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-calendar3 me-1"></i>Personnalisé
                        </button>
                        <button class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-download me-1"></i>Exporter
                        </button>
                    </div>
                </div>
                
                <!-- Chart -->
                <div class="chart-container">
                    <canvas id="vlEvolutionChart"></canvas>
                </div>
                
                <!-- Legend -->
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-line" style="background: #004080;"></div>
                        <span id="legendFcpName">{{ selected_fcp }}</span>
                    </div>
                    <div class="legend-item" id="benchmarkLegend" style="display: none;">
                        <div class="legend-line" style="background: #E0DEDD; border: 1px dashed #333;"></div>
                        <span>Benchmark (BRVM Composite)</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Metric Cards -->
        <div class="row mb-4">
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="metric-card">
                    <div class="metric-label">Dernière VL ({{ stats.derniere_date|default:"--" }})</div>
                    <div class="metric-value" id="metricDerniereVL">{{ stats.derniere_vl|floatformat:2|default:"--" }} <small style="font-size: 14px;">XOF</small></div>
                    <div class="metric-change {% if stats.var_1j >= 0 %}positive{% else %}negative{% endif %}" id="metricVar1J">
                        <i class="bi bi-arrow-{% if stats.var_1j >= 0 %}up{% else %}down{% endif %}"></i> {% if stats.var_1j >= 0 %}+{% endif %}{{ stats.var_1j|default:"0" }}% (1j)
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="metric-card">
                    <div class="metric-label">Rendement YTD</div>
                    <div class="metric-value {% if stats.var_ytd >= 0 %}text-success{% else %}text-danger{% endif %}" id="metricYTD">{% if stats.var_ytd >= 0 %}+{% endif %}{{ stats.var_ytd|default:"0" }}%</div>
                    <div class="metric-change">
                        Depuis début d'année
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="metric-card">
                    <div class="metric-label">Rendement 1 an</div>
                    <div class="metric-value {% if stats.var_1y >= 0 %}text-success{% else %}text-danger{% endif %}" id="metricVar1Y">{% if stats.var_1y >= 0 %}+{% endif %}{{ stats.var_1y|default:"0" }}%</div>
                    <div class="metric-change">
                        Sur 12 mois glissants
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="metric-card">
                    <div class="metric-label">Volatilité</div>
                    <div class="metric-value" id="metricVolatilite">{{ stats.volatilite|default:"0" }}%</div>
                    <div class="metric-change">
                        Écart-type annualisé
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Risk/Return Scatter Plot -->
        <div class="card">
            <div class="card-body">
                <div class="section-header">
                    <div class="section-title">
                        <i class="bi bi-bullseye"></i>
                        <span>Rendement / Risque - Tous les FCP</span>
                    </div>
                    
                    <!-- Period Filters for Scatter -->
                    <div class="filter-pills" id="scatterPeriodFilters">
                        <button class="filter-pill" data-period="wtd">WTD</button>
                        <button class="filter-pill" data-period="mtd">MTD</button>
                        <button class="filter-pill" data-period="qtd">QTD</button>
                        <button class="filter-pill" data-period="std">STD</button>
                        <button class="filter-pill" data-period="ytd">YTD</button>
                        <button class="filter-pill active" data-period="origin">Origine</button>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-lg-8">
                        <div class="chart-container-scatter">
                            <canvas id="riskReturnChart"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="scatter-info flex-column h-100 justify-content-center">
                            <div class="scatter-info-item mb-3">
                                <div class="label">FCP sélectionné</div>
                                <div class="value fw-bold" style="color: var(--primary-color);" id="scatterSelectedFcp">{{ selected_fcp }}</div>
                            </div>
                            <div class="scatter-info-item mb-3">
                                <div class="label">Rendement</div>
                                <div class="value" id="scatterRendement" style="color: var(--success-color);">{{ stats.var_origine|default:"0" }}%</div>
                            </div>
                            <div class="scatter-info-item mb-3">
                                <div class="label">Risque (Volatilité)</div>
                                <div class="value" id="scatterVolatilite">{{ stats.volatilite|default:"0" }}%</div>
                            </div>
                            <div class="scatter-info-item mb-3">
                                <div class="label">Ratio Rendement/Risque</div>
                                <div class="value" id="scatterRatio">--</div>
                            </div>
                            <div class="scatter-info-item">
                                <div class="label">Type de fond</div>
                                <div class="value" id="scatterTypeFond" style="color: var(--primary-color);">
                                    <i class="bi bi-tag-fill me-1"></i>--
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Scatter Legend par Type de Fond -->
                <div class="d-flex justify-content-between align-items-center flex-wrap mt-3">
                    <div class="chart-legend" id="scatterLegend">
                        <div class="legend-item" data-type="Obligataire">
                            <div class="legend-dot" style="background: #004080;"></div>
                            <span>Obligataire</span>
                        </div>
                        <div class="legend-item" data-type="Diversifié">
                            <div class="legend-dot" style="background: #28a745;"></div>
                            <span>Diversifié</span>
                        </div>
                        <div class="legend-item" data-type="Actions">
                            <div class="legend-dot" style="background: #dc3545;"></div>
                            <span>Actions</span>
                        </div>
                        <div class="legend-item" data-type="Monétaire">
                            <div class="legend-dot" style="background: #ffc107;"></div>
                            <span>Monétaire</span>
                        </div>
                    </div>
                    <div class="text-muted small" id="scatterDateNote">
                        <i class="bi bi-info-circle me-1"></i>
                        Données au <strong>{{ stats.derniere_date }}</strong> (dernière date en base)
                    </div>
                </div>
            </div>
        </div>
        
    </div>
    
    <!-- Performances Tab -->
    <div class="tab-pane fade" id="performances" role="tabpanel">
        <div class="row g-4">
            <!-- Sélecteur FCP -->
            <div class="col-12">
                <div class="card">
                    <div class="card-body py-3">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-trophy me-2" style="color: var(--primary-color);"></i>
                                Performances - <span style="color: var(--primary-color);">{{ selected_fcp }}</span>
                            </h5>
                            <div class="d-flex align-items-center gap-2">
                                <label class="text-muted small me-2">Sélectionner un FCP :</label>
                                <select class="select-custom" id="perfFcpSelector" style="min-width: 220px;">
                                    {% for fcp_name in fcp_list %}
                                    <option value="{{ fcp_name }}" {% if fcp_name == selected_fcp %}selected{% endif %}>{{ fcp_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Performances Calendaires -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-calendar3 me-2"></i>Performances Calendaires
                        </h5>
                        <small class="text-muted">Depuis le début de chaque période</small>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th class="px-4 py-3">Période</th>
                                    <th class="px-4 py-3">Description</th>
                                    <th class="px-4 py-3 text-end">Performance</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="px-4 py-3"><span class="badge bg-secondary">WTD</span></td>
                                    <td class="px-4 py-3 text-muted">Week-to-Date</td>
                                    <td class="px-4 py-3 text-end">
                                        {% if perf_calendaires.wtd != None %}
                                        <span class="fw-bold {% if perf_calendaires.wtd >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {% if perf_calendaires.wtd >= 0 %}+{% endif %}{{ perf_calendaires.wtd }}%
                                        </span>
                                        {% else %}<span class="text-muted">N/A</span>{% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3"><span class="badge bg-secondary">MTD</span></td>
                                    <td class="px-4 py-3 text-muted">Month-to-Date</td>
                                    <td class="px-4 py-3 text-end">
                                        {% if perf_calendaires.mtd != None %}
                                        <span class="fw-bold {% if perf_calendaires.mtd >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {% if perf_calendaires.mtd >= 0 %}+{% endif %}{{ perf_calendaires.mtd }}%
                                        </span>
                                        {% else %}<span class="text-muted">N/A</span>{% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3"><span class="badge bg-secondary">QTD</span></td>
                                    <td class="px-4 py-3 text-muted">Quarter-to-Date</td>
                                    <td class="px-4 py-3 text-end">
                                        {% if perf_calendaires.qtd != None %}
                                        <span class="fw-bold {% if perf_calendaires.qtd >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {% if perf_calendaires.qtd >= 0 %}+{% endif %}{{ perf_calendaires.qtd }}%
                                        </span>
                                        {% else %}<span class="text-muted">N/A</span>{% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3"><span class="badge bg-secondary">STD</span></td>
                                    <td class="px-4 py-3 text-muted">Semester-to-Date</td>
                                    <td class="px-4 py-3 text-end">
                                        {% if perf_calendaires.std != None %}
                                        <span class="fw-bold {% if perf_calendaires.std >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {% if perf_calendaires.std >= 0 %}+{% endif %}{{ perf_calendaires.std }}%
                                        </span>
                                        {% else %}<span class="text-muted">N/A</span>{% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3"><span class="badge" style="background: var(--primary-color);">YTD</span></td>
                                    <td class="px-4 py-3 text-muted">Year-to-Date</td>
                                    <td class="px-4 py-3 text-end">
                                        {% if perf_calendaires.ytd != None %}
                                        <span class="fw-bold {% if perf_calendaires.ytd >= 0 %}text-success{% else %}text-danger{% endif %}" style="font-size: 1.1em;">
                                            {% if perf_calendaires.ytd >= 0 %}+{% endif %}{{ perf_calendaires.ytd }}%
                                        </span>
                                        {% else %}<span class="text-muted">N/A</span>{% endif %}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Performances Glissantes -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-arrow-repeat me-2"></i>Performances Glissantes
                        </h5>
                        <small class="text-muted">Sur les X derniers mois/années</small>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th class="px-4 py-3">Période</th>
                                    <th class="px-4 py-3">Description</th>
                                    <th class="px-4 py-3 text-end">Performance</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="px-4 py-3"><span class="badge bg-info">1M</span></td>
                                    <td class="px-4 py-3 text-muted">1 Mois</td>
                                    <td class="px-4 py-3 text-end">
                                        {% if perf_glissantes.perf_1m != None %}
                                        <span class="fw-bold {% if perf_glissantes.perf_1m >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {% if perf_glissantes.perf_1m >= 0 %}+{% endif %}{{ perf_glissantes.perf_1m }}%
                                        </span>
                                        {% else %}<span class="text-muted">N/A</span>{% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3"><span class="badge bg-info">3M</span></td>
                                    <td class="px-4 py-3 text-muted">3 Mois</td>
                                    <td class="px-4 py-3 text-end">
                                        {% if perf_glissantes.perf_3m != None %}
                                        <span class="fw-bold {% if perf_glissantes.perf_3m >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {% if perf_glissantes.perf_3m >= 0 %}+{% endif %}{{ perf_glissantes.perf_3m }}%
                                        </span>
                                        {% else %}<span class="text-muted">N/A</span>{% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3"><span class="badge bg-info">6M</span></td>
                                    <td class="px-4 py-3 text-muted">6 Mois</td>
                                    <td class="px-4 py-3 text-end">
                                        {% if perf_glissantes.perf_6m != None %}
                                        <span class="fw-bold {% if perf_glissantes.perf_6m >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {% if perf_glissantes.perf_6m >= 0 %}+{% endif %}{{ perf_glissantes.perf_6m }}%
                                        </span>
                                        {% else %}<span class="text-muted">N/A</span>{% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3"><span class="badge bg-info">1A</span></td>
                                    <td class="px-4 py-3 text-muted">1 An</td>
                                    <td class="px-4 py-3 text-end">
                                        {% if perf_glissantes.perf_1y != None %}
                                        <span class="fw-bold {% if perf_glissantes.perf_1y >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {% if perf_glissantes.perf_1y >= 0 %}+{% endif %}{{ perf_glissantes.perf_1y }}%
                                        </span>
                                        {% else %}<span class="text-muted">N/A</span>{% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3"><span class="badge bg-info">3A</span></td>
                                    <td class="px-4 py-3 text-muted">3 Ans</td>
                                    <td class="px-4 py-3 text-end">
                                        {% if perf_glissantes.perf_3y != None %}
                                        <span class="fw-bold {% if perf_glissantes.perf_3y >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {% if perf_glissantes.perf_3y >= 0 %}+{% endif %}{{ perf_glissantes.perf_3y }}%
                                        </span>
                                        {% else %}<span class="text-muted">N/A</span>{% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3"><span class="badge bg-info">5A</span></td>
                                    <td class="px-4 py-3 text-muted">5 Ans</td>
                                    <td class="px-4 py-3 text-end">
                                        {% if perf_glissantes.perf_5y != None %}
                                        <span class="fw-bold {% if perf_glissantes.perf_5y >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {% if perf_glissantes.perf_5y >= 0 %}+{% endif %}{{ perf_glissantes.perf_5y }}%
                                        </span>
                                        {% else %}<span class="text-muted">N/A</span>{% endif %}
                                    </td>
                                </tr>
                                <tr style="background: rgba(0, 64, 128, 0.05);">
                                    <td class="px-4 py-3"><span class="badge" style="background: var(--primary-color);">Origine</span></td>
                                    <td class="px-4 py-3 text-muted">Depuis la création</td>
                                    <td class="px-4 py-3 text-end">
                                        {% if perf_glissantes.origine != None %}
                                        <span class="fw-bold {% if perf_glissantes.origine >= 0 %}text-success{% else %}text-danger{% endif %}" style="font-size: 1.1em;">
                                            {% if perf_glissantes.origine >= 0 %}+{% endif %}{{ perf_glissantes.origine }}%
                                        </span>
                                        {% else %}<span class="text-muted">N/A</span>{% endif %}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Note -->
            <div class="col-12">
                <div class="alert alert-light border d-flex align-items-center" role="alert">
                    <i class="bi bi-info-circle me-2" style="color: var(--primary-color);"></i>
                    <div>
                        <small>Données calculées au <strong>{{ stats.derniere_date }}</strong> (dernière VL en base). 
                        Les performances passées ne préjugent pas des performances futures.</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Historique Tab -->
    <div class="tab-pane fade" id="history" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                <h5 class="card-title mb-0">
                    <i class="bi bi-table me-2"></i>Historique des Valeurs Liquidatives - {{ selected_fcp }}
                </h5>
                <div class="d-flex gap-2 align-items-center flex-wrap">
                    <select class="select-custom" id="historyFcpSelector" style="min-width: 200px;">
                        {% for fcp_name in fcp_list %}
                        <option value="{{ fcp_name }}" {% if fcp_name == selected_fcp %}selected{% endif %}>{{ fcp_name }}</option>
                        {% endfor %}
                    </select>
                    <button class="btn btn-sm btn-outline-secondary" id="exportCsvBtn">
                        <i class="bi bi-download me-1"></i>Exporter CSV
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <!-- Stats Summary -->
                <div class="history-stats d-flex justify-content-around flex-wrap py-3 px-4 border-bottom" style="background: var(--bg-secondary);">
                    <div class="text-center px-3">
                        <div class="text-muted small text-uppercase">Nb. Observations</div>
                        <div class="fw-bold fs-5" style="color: var(--primary-color);">{{ stats.nb_vl|default:"0" }}</div>
                    </div>
                    <div class="text-center px-3">
                        <div class="text-muted small text-uppercase">Première Date</div>
                        <div class="fw-bold">{{ stats.premiere_date|default:"--" }}</div>
                    </div>
                    <div class="text-center px-3">
                        <div class="text-muted small text-uppercase">Dernière Date</div>
                        <div class="fw-bold">{{ stats.derniere_date|default:"--" }}</div>
                    </div>
                    <div class="text-center px-3">
                        <div class="text-muted small text-uppercase">Perf. Origine</div>
                        <div class="fw-bold {% if stats.var_origine >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {% if stats.var_origine >= 0 %}+{% endif %}{{ stats.var_origine|default:"0" }}%
                        </div>
                    </div>
                </div>
                
                <!-- Table Container -->
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-hover table-striped mb-0" id="historyTable">
                        <thead class="sticky-top" style="background: var(--bg-primary);">
                            <tr>
                                <th class="px-4 py-3" style="min-width: 120px;">
                                    <span class="d-flex align-items-center gap-2">
                                        <i class="bi bi-calendar3"></i> Date
                                    </span>
                                </th>
                                <th class="px-4 py-3 text-end" style="min-width: 140px;">
                                    <span class="d-flex align-items-center justify-content-end gap-2">
                                        Valeur Liquidative <i class="bi bi-currency-exchange"></i>
                                    </span>
                                </th>
                                <th class="px-4 py-3 text-end" style="min-width: 120px;">
                                    <span class="d-flex align-items-center justify-content-end gap-2">
                                        Var. 1J <i class="bi bi-graph-up-arrow"></i>
                                    </span>
                                </th>
                                <th class="px-4 py-3 text-end" style="min-width: 120px;">
                                    <span class="d-flex align-items-center justify-content-end gap-2">
                                        Var. Cumul <i class="bi bi-bar-chart-line"></i>
                                    </span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <!-- Rempli par JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div class="d-flex justify-content-between align-items-center px-4 py-3 border-top">
                    <div class="text-muted small">
                        Affichage <span id="showingFrom">1</span>-<span id="showingTo">50</span> sur <span id="totalRows">{{ stats.nb_vl|default:"0" }}</span> lignes
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-secondary" id="prevPageBtn" disabled>
                            <i class="bi bi-chevron-left"></i> Précédent
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" id="nextPageBtn">
                            Suivant <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Analyse Tab -->
    <div class="tab-pane fade" id="analysis" role="tabpanel">
        <div class="row g-4">
            <!-- Header -->
            <div class="col-12">
                <div class="card">
                    <div class="card-body py-3">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-bar-chart-line me-2" style="color: var(--primary-color);"></i>
                                Analyse - <span style="color: var(--primary-color);">{{ selected_fcp }}</span>
                            </h5>
                            <div class="d-flex align-items-center gap-2">
                                <label class="text-muted small me-2">Sélectionner un FCP :</label>
                                <select class="select-custom" id="analyseFcpSelector" style="min-width: 220px;">
                                    {% for fcp_name in fcp_list %}
                                    <option value="{{ fcp_name }}" {% if fcp_name == selected_fcp %}selected{% endif %}>{{ fcp_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Statistiques Descriptives -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-calculator me-2"></i>Statistiques Descriptives
                        </h5>
                        <small class="text-muted">Analyse des rendements quotidiens</small>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-hover mb-0">
                            <tbody>
                                <tr>
                                    <td class="px-4 py-3">
                                        <i class="bi bi-hash me-2 text-muted"></i>Nombre d'observations
                                    </td>
                                    <td class="px-4 py-3 text-end fw-bold">{{ analyse_stats.nb_observations|default:"--" }}</td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3">
                                        <i class="bi bi-graph-up me-2 text-muted"></i>Rendement moyen quotidien
                                    </td>
                                    <td class="px-4 py-3 text-end fw-bold">{{ analyse_stats.rendement_moyen|default:"--" }}%</td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3">
                                        <i class="bi bi-graph-up-arrow me-2 text-muted"></i>Rendement annualisé
                                    </td>
                                    <td class="px-4 py-3 text-end">
                                        <span class="fw-bold {% if analyse_stats.rendement_moyen_ann >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {% if analyse_stats.rendement_moyen_ann >= 0 %}+{% endif %}{{ analyse_stats.rendement_moyen_ann|default:"--" }}%
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3">
                                        <i class="bi bi-distribute-vertical me-2 text-muted"></i>Médiane
                                    </td>
                                    <td class="px-4 py-3 text-end fw-bold">{{ analyse_stats.mediane|default:"--" }}%</td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3">
                                        <i class="bi bi-bar-chart me-2 text-muted"></i>Écart-type quotidien
                                    </td>
                                    <td class="px-4 py-3 text-end fw-bold">{{ analyse_stats.ecart_type|default:"--" }}%</td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3">
                                        <i class="bi bi-activity me-2 text-muted"></i>Volatilité annualisée
                                    </td>
                                    <td class="px-4 py-3 text-end fw-bold" style="color: var(--primary-color);">{{ analyse_stats.volatilite_ann|default:"--" }}%</td>
                                </tr>
                                <tr class="table-light">
                                    <td class="px-4 py-3">
                                        <i class="bi bi-arrow-down-circle me-2 text-danger"></i>VL Minimum
                                    </td>
                                    <td class="px-4 py-3 text-end fw-bold">{{ analyse_stats.vl_min|default:"--" }} XOF</td>
                                </tr>
                                <tr class="table-light">
                                    <td class="px-4 py-3">
                                        <i class="bi bi-arrow-up-circle me-2 text-success"></i>VL Maximum
                                    </td>
                                    <td class="px-4 py-3 text-end fw-bold">{{ analyse_stats.vl_max|default:"--" }} XOF</td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3">
                                        <i class="bi bi-chevron-double-down me-2 text-danger"></i>Pire rendement quotidien
                                    </td>
                                    <td class="px-4 py-3 text-end fw-bold text-danger">{{ analyse_stats.rdt_min|default:"--" }}%</td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3">
                                        <i class="bi bi-chevron-double-up me-2 text-success"></i>Meilleur rendement quotidien
                                    </td>
                                    <td class="px-4 py-3 text-end fw-bold text-success">+{{ analyse_stats.rdt_max|default:"--" }}%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Profil de Risque -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-shield-exclamation me-2"></i>Profil de Risque
                        </h5>
                        <small class="text-muted">Indicateurs de risque et ratios</small>
                    </div>
                    <div class="card-body">
                        <!-- Drawdown Max -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted">
                                    <i class="bi bi-graph-down-arrow me-2"></i>Drawdown Maximum
                                </span>
                                <span class="fw-bold text-danger fs-5">-{{ analyse_stats.max_drawdown|default:"--" }}%</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-danger" role="progressbar" 
                                     style="width: {{ analyse_stats.max_drawdown|default:0 }}%"></div>
                            </div>
                            <small class="text-muted">Perte maximale depuis un pic historique</small>
                        </div>
                        
                        <!-- Ratio de Sharpe -->
                        <div class="mb-4 p-3 rounded" style="background: var(--bg-secondary);">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi bi-trophy me-2" style="color: var(--primary-color);"></i>
                                    <span class="fw-medium">Ratio de Sharpe</span>
                                    <br><small class="text-muted">Rendement ajusté du risque (rf=3,25%)</small>
                                </div>
                                <span class="fs-4 fw-bold {% if analyse_stats.sharpe >= 1 %}text-success{% elif analyse_stats.sharpe >= 0 %}text-warning{% else %}text-danger{% endif %}">
                                    {{ analyse_stats.sharpe|default:"--" }}
                                </span>
                            </div>
                        </div>
                        
                        <!-- Ratio de Sortino -->
                        <div class="mb-4 p-3 rounded" style="background: var(--bg-secondary);">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi bi-shield-check me-2" style="color: var(--primary-color);"></i>
                                    <span class="fw-medium">Ratio de Sortino</span>
                                    <br><small class="text-muted">Rendement ajusté du risque baissier</small>
                                </div>
                                <span class="fs-4 fw-bold {% if analyse_stats.sortino >= 1 %}text-success{% elif analyse_stats.sortino >= 0 %}text-warning{% else %}text-danger{% endif %}">
                                    {{ analyse_stats.sortino|default:"--" }}
                                </span>
                            </div>
                        </div>
                        
                        <!-- Jours Positifs/Négatifs -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted">Distribution des jours</span>
                                <span class="fw-bold">{{ analyse_stats.ratio_positif|default:"--" }}% positifs</span>
                            </div>
                            <div class="progress" style="height: 24px;">
                                <div class="progress-bar bg-success" role="progressbar" 
                                     style="width: {{ analyse_stats.ratio_positif|default:50 }}%"
                                     title="{{ analyse_stats.jours_positifs }} jours positifs">
                                    <small>{{ analyse_stats.jours_positifs|default:"--" }} <i class="bi bi-arrow-up"></i></small>
                                </div>
                                <div class="progress-bar bg-danger" role="progressbar" 
                                     style="width: {% widthratio analyse_stats.jours_negatifs analyse_stats.nb_observations 100 %}%"
                                     title="{{ analyse_stats.jours_negatifs }} jours négatifs">
                                    <small>{{ analyse_stats.jours_negatifs|default:"--" }} <i class="bi bi-arrow-down"></i></small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Légende interprétation -->
                        <div class="alert alert-light border-0 mb-0 mt-4">
                            <small>
                                <strong>Interprétation des ratios :</strong><br>
                                <span class="text-success">● &gt; 1</span> = Excellent |
                                <span class="text-warning">● 0-1</span> = Acceptable |
                                <span class="text-danger">● &lt; 0</span> = À éviter
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Note -->
            <div class="col-12">
                <div class="alert alert-light border d-flex align-items-center" role="alert">
                    <i class="bi bi-info-circle me-2" style="color: var(--primary-color);"></i>
                    <div>
                        <small>Analyse basée sur les données du <strong>{{ stats.premiere_date }}</strong> au <strong>{{ stats.derniere_date }}</strong>. 
                        Taux sans risque utilisé : 3,25% annuel.</small>
                    </div>
                </div>
            </div>
            
            <!-- Matrice de Corrélation -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div>
                            <h5 class="card-title mb-0">
                                <i class="bi bi-grid-3x3 me-2"></i>Matrice de Corrélation
                            </h5>
                            <small class="text-muted">Corrélation des rendements entre FCP</small>
                        </div>
                        <div class="filter-pills" id="correlationPeriodFilters">
                            <button class="filter-pill" data-period="wtd">WTD</button>
                            <button class="filter-pill" data-period="mtd">MTD</button>
                            <button class="filter-pill" data-period="qtd">QTD</button>
                            <button class="filter-pill" data-period="std">STD</button>
                            <button class="filter-pill" data-period="ytd">YTD</button>
                            <button class="filter-pill active" data-period="origin">Origine</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-3">
                            <small class="text-muted"><span id="correlationObsCount">--</span> observations communes</small>
                        </div>
                        <div class="table-responsive" id="correlationTableContainer">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Chargement...</span>
                                </div>
                                <p class="text-muted mt-2">Calcul de la matrice de corrélation...</p>
                            </div>
                        </div>
                        <!-- Légende -->
                        <div class="d-flex justify-content-center gap-4 mt-3 flex-wrap">
                            <div class="d-flex align-items-center gap-2">
                                <div style="width: 20px; height: 20px; background: #28a745; border-radius: 4px;"></div>
                                <small class="text-muted">Corrélation positive forte (> 0.7)</small>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <div style="width: 20px; height: 20px; background: #ffc107; border-radius: 4px;"></div>
                                <small class="text-muted">Corrélation modérée (0.3 - 0.7)</small>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <div style="width: 20px; height: 20px; background: #dc3545; border-radius: 4px;"></div>
                                <small class="text-muted">Corrélation négative (< 0)</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Risque Tab -->
    <div class="tab-pane fade" id="risk" role="tabpanel">
        <div class="row g-4">
            <!-- Header -->
            <div class="col-12">
                <div class="card">
                    <div class="card-body py-3">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-shield-exclamation me-2" style="color: var(--primary-color);"></i>
                                Analyse du Risque - <span style="color: var(--primary-color);">{{ selected_fcp }}</span>
                            </h5>
                            <div class="d-flex align-items-center gap-3 flex-wrap">
                                <div class="d-flex align-items-center gap-2">
                                    <label class="text-muted small">FCP :</label>
                                    <select class="select-custom" id="riskFcpSelector" style="min-width: 220px;">
                                        {% for fcp_name in fcp_list %}
                                        <option value="{{ fcp_name }}" {% if fcp_name == selected_fcp %}selected{% endif %}>{{ fcp_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <label class="text-muted small">Fenêtre :</label>
                                    <input type="range" class="form-range" id="volatilityWindow" min="5" max="30" value="20" style="width: 100px;">
                                    <span class="badge bg-primary" id="windowValue">20</span>
                                    <small class="text-muted">jours</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Graphique Volatilité Glissante -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-activity me-2"></i>Volatilité Glissante et Régimes
                        </h5>
                        <small class="text-muted">Clustering en 3 régimes : Faible, Intermédiaire, Élevé</small>
                    </div>
                    <div class="card-body">
                        <div id="volatilityChartContainer" style="height: 350px;">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Chargement...</span>
                                </div>
                                <p class="text-muted mt-2">Calcul du clustering de volatilité...</p>
                            </div>
                        </div>
                        <canvas id="volatilityChart" style="display: none;"></canvas>
                        <!-- Légende régimes -->
                        <div class="d-flex justify-content-center gap-4 mt-3">
                            <div class="d-flex align-items-center gap-2">
                                <div style="width: 16px; height: 16px; background: #28a745; border-radius: 50%;"></div>
                                <small>Régime Faible</small>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <div style="width: 16px; height: 16px; background: #ffc107; border-radius: 50%;"></div>
                                <small>Régime Intermédiaire</small>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <div style="width: 16px; height: 16px; background: #dc3545; border-radius: 50%;"></div>
                                <small>Régime Élevé</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Statistiques des Régimes et Matrice de Transition -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-pie-chart me-2"></i>Statistiques des Régimes
                        </h5>
                        <small class="text-muted">Distribution de la volatilité par régime</small>
                    </div>
                    <div class="card-body" id="regimeStatsContainer">
                        <div class="text-center py-4">
                            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-arrow-left-right me-2"></i>Matrice de Transition
                        </h5>
                        <small class="text-muted">Probabilité de passage entre régimes (%)</small>
                    </div>
                    <div class="card-body" id="transitionMatrixContainer">
                        <div class="text-center py-4">
                            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Régime actuel -->
            <div class="col-12">
                <div class="card" id="currentRegimeCard">
                    <div class="card-body py-3">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                            <div class="d-flex align-items-center gap-3">
                                <div id="currentRegimeBadge" class="px-4 py-2 rounded-pill text-white fw-bold" style="background: #6c757d;">
                                    --
                                </div>
                                <div>
                                    <div class="text-muted small">Régime actuel</div>
                                    <div class="fw-bold" id="currentVolatilityValue">Volatilité: --</div>
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="text-muted small">Seuils de classification</div>
                                <div id="thresholdsInfo">Faible ≤ -- | Intermédiaire ≤ -- | Élevé > --</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Note -->
            <div class="col-12">
                <div class="alert alert-light border d-flex align-items-center" role="alert">
                    <i class="bi bi-info-circle me-2" style="color: var(--primary-color);"></i>
                    <div>
                        <small>
                            <strong>Clustering de volatilité :</strong> Classification des régimes basée sur les percentiles 33% et 66% de la volatilité glissante.
                            La <strong>matrice de transition</strong> indique la probabilité de passer d'un régime à un autre le jour suivant.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Données VL depuis Django
    const vlDataRaw = {{ vl_data_json|safe }};
    const allFcpStats = {{ all_fcp_stats_json|safe }};
    const selectedFcp = "{{ selected_fcp }}";
    
    // Fonction pour filtrer les données par période
    function filterDataByPeriod(data, period) {
        if (!data || data.length === 0) return { labels: [], values: [] };
        
        const lastDate = new Date(data[data.length - 1].date);
        let startDate;
        
        switch(period) {
            case '1m': startDate = new Date(lastDate); startDate.setMonth(startDate.getMonth() - 1); break;
            case '3m': startDate = new Date(lastDate); startDate.setMonth(startDate.getMonth() - 3); break;
            case '6m': startDate = new Date(lastDate); startDate.setMonth(startDate.getMonth() - 6); break;
            case '1y': startDate = new Date(lastDate); startDate.setFullYear(lastDate.getFullYear() - 1); break;
            case '5y': startDate = new Date(lastDate); startDate.setFullYear(lastDate.getFullYear() - 5); break;
            default: startDate = new Date(data[0].date);
        }
        
        const filtered = data.filter(d => new Date(d.date) >= startDate);
        return {
            labels: filtered.map(d => d.date),
            values: filtered.map(d => d.valeur)
        };
    }
    
    // Données initiales (1 an par défaut)
    let currentData = filterDataByPeriod(vlDataRaw, '1y');
    
    // VL Evolution Chart
    const vlCtx = document.getElementById('vlEvolutionChart').getContext('2d');
    const vlChart = new Chart(vlCtx, {
        type: 'line',
        data: {
            labels: currentData.labels,
            datasets: [{
                label: selectedFcp,
                data: currentData.values,
                borderColor: '#004080',
                backgroundColor: 'rgba(0, 64, 128, 0.1)',
                borderWidth: 2.5,
                fill: true,
                tension: 0.2,
                pointRadius: 0,
                pointHoverRadius: 6,
                pointHoverBackgroundColor: '#004080',
                pointHoverBorderColor: '#fff',
                pointHoverBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleFont: { size: 13 },
                    bodyFont: { size: 12 },
                    padding: 12,
                    cornerRadius: 8,
                    callbacks: {
                        title: function(context) {
                            const date = new Date(context[0].label);
                            return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'long', year: 'numeric' });
                        },
                        label: function(context) {
                            return context.dataset.label + ': ' + new Intl.NumberFormat('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}).format(context.raw) + ' XOF';
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'category',
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: '#777777',
                        font: { size: 10 },
                        maxTicksLimit: 12,
                        callback: function(value, index) {
                            const date = new Date(this.getLabelForValue(value));
                            return date.toLocaleDateString('fr-FR', { month: 'short', year: '2-digit' });
                        }
                    }
                },
                y: {
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        color: '#777777',
                        font: { size: 11 },
                        callback: function(value) {
                            return new Intl.NumberFormat('fr-FR').format(value);
                        }
                    }
                }
            }
        }
    });
    
    // Risk/Return Scatter Chart avec données réelles et catégorisation par type_fond
    const scatterCtx = document.getElementById('riskReturnChart').getContext('2d');
    
    // Couleurs par type de fond
    const typeColors = {
        'Obligataire': '#004080',
        'Diversifié': '#28a745',
        'Actions': '#dc3545',
        'Monétaire': '#ffc107'
    };
    
    // Fonction pour créer les datasets du scatter chart
    function createScatterDatasets(data) {
        return data.map((fcp) => ({
            label: fcp.nom,
            data: [{ x: fcp.volatilite, y: fcp.rendement, type_fond: fcp.type_fond }],
            backgroundColor: fcp.selected ? typeColors[fcp.type_fond] || '#6c757d' : typeColors[fcp.type_fond] || '#6c757d',
            pointRadius: fcp.selected ? 14 : 8,
            pointHoverRadius: fcp.selected ? 16 : 10,
            borderColor: fcp.selected ? '#fff' : 'rgba(255,255,255,0.5)',
            borderWidth: fcp.selected ? 3 : 1,
            type_fond: fcp.type_fond
        }));
    }
    
    // Initialiser le scatter chart
    let scatterDatasets = createScatterDatasets(allFcpStats);
    
    const scatterChart = new Chart(scatterCtx, {
        type: 'scatter',
        data: {
            datasets: scatterDatasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    cornerRadius: 8,
                    callbacks: {
                        label: function(context) {
                            const typeFond = context.dataset.type_fond || 'N/A';
                            return [
                                context.dataset.label,
                                'Type: ' + typeFond,
                                'Rendement: ' + context.raw.y.toFixed(2) + '%',
                                'Volatilité: ' + context.raw.x.toFixed(2) + '%'
                            ];
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Risque (Volatilité %)',
                        color: '#555555',
                        font: { size: 12, weight: '500' }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        color: '#777777',
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Rendement %',
                        color: '#555555',
                        font: { size: 12, weight: '500' }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        color: '#777777',
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            },
            onClick: function(event, elements) {
                if (elements.length > 0) {
                    const datasetIndex = elements[0].datasetIndex;
                    const fcpData = scatterChart.data.datasets[datasetIndex];
                    updateScatterInfo(fcpData.label, fcpData.data[0].y, fcpData.data[0].x, fcpData.type_fond);
                }
            }
        }
    });
    
    // Fonction pour mettre à jour les infos du scatter
    function updateScatterInfo(nom, rendement, volatilite, typeFond) {
        document.getElementById('scatterSelectedFcp').textContent = nom;
        const rendementEl = document.getElementById('scatterRendement');
        rendementEl.textContent = (rendement >= 0 ? '+' : '') + rendement.toFixed(2) + '%';
        rendementEl.style.color = rendement >= 0 ? 'var(--success-color)' : 'var(--danger-color)';
        document.getElementById('scatterVolatilite').textContent = volatilite.toFixed(2) + '%';
        const ratio = volatilite > 0 ? (rendement / volatilite).toFixed(2) : '--';
        document.getElementById('scatterRatio').textContent = ratio;
        document.getElementById('scatterTypeFond').innerHTML = '<i class="bi bi-tag-fill me-1"></i>' + typeFond;
    }
    
    // Initialiser les infos avec le FCP sélectionné
    const selectedFcpData = allFcpStats.find(f => f.selected);
    if (selectedFcpData) {
        updateScatterInfo(selectedFcpData.nom, selectedFcpData.rendement, selectedFcpData.volatilite, selectedFcpData.type_fond);
    }
    
    // Scatter Period Filter Click Handler
    document.querySelectorAll('#scatterPeriodFilters .filter-pill').forEach(pill => {
        pill.addEventListener('click', function() {
            document.querySelectorAll('#scatterPeriodFilters .filter-pill').forEach(p => p.classList.remove('active'));
            this.classList.add('active');
            
            const period = this.dataset.period;
            
            // Appeler l'API pour récupérer les données filtrées
            fetch('/api/scatter-data/?period=' + period)
                .then(response => response.json())
                .then(result => {
                    // Marquer le FCP sélectionné
                    result.data.forEach(fcp => {
                        fcp.selected = fcp.nom === selectedFcp;
                    });
                    
                    // Mettre à jour le chart
                    scatterChart.data.datasets = createScatterDatasets(result.data);
                    scatterChart.update();
                    
                    // Mettre à jour les infos si le FCP sélectionné est dans les résultats
                    const selectedData = result.data.find(f => f.selected);
                    if (selectedData) {
                        updateScatterInfo(selectedData.nom, selectedData.rendement, selectedData.volatilite, selectedData.type_fond);
                    }
                    
                    // Mettre à jour la note avec la date
                    if (result.last_date) {
                        document.getElementById('scatterDateNote').innerHTML = 
                            '<i class="bi bi-info-circle me-1"></i>Données au <strong>' + result.last_date + '</strong> (dernière date en base)';
                    }
                })
                .catch(error => console.error('Erreur:', error));
        });
    });
    
    // Period Filter Click Handler
    document.querySelectorAll('#periodFilters .filter-pill').forEach(pill => {
        pill.addEventListener('click', function() {
            document.querySelectorAll('#periodFilters .filter-pill').forEach(p => p.classList.remove('active'));
            this.classList.add('active');
            
            const period = this.dataset.period;
            const filteredData = filterDataByPeriod(vlDataRaw, period);
            
            vlChart.data.labels = filteredData.labels;
            vlChart.data.datasets[0].data = filteredData.values;
            vlChart.update();
        });
    });
    
    // FCP Selector Change Handler
    document.getElementById('fcpSelector').addEventListener('change', function() {
        const selectedFcp = this.value;
        window.location.href = '?fcp=' + encodeURIComponent(selectedFcp);
    });
    
    // Performances FCP Selector
    document.getElementById('perfFcpSelector')?.addEventListener('change', function() {
        const selectedFcp = this.value;
        window.location.href = '?fcp=' + encodeURIComponent(selectedFcp);
    });
    
    // Analyse FCP Selector
    document.getElementById('analyseFcpSelector')?.addEventListener('change', function() {
        const selectedFcp = this.value;
        window.location.href = '?fcp=' + encodeURIComponent(selectedFcp);
    });
    
    // Benchmark Toggle
    document.getElementById('showBenchmark').addEventListener('change', function() {
        if (this.checked) {
            document.getElementById('benchmarkLegend').style.display = 'flex';
        } else {
            document.getElementById('benchmarkLegend').style.display = 'none';
        }
    });
    
    // Cumulative Toggle
    document.getElementById('showCumulative').addEventListener('change', function() {
        const currentValues = vlChart.data.datasets[0].data;
        
        if (this.checked && currentValues.length > 0) {
            // Convert to cumulative returns (%)
            const baseValue = currentValues[0];
            vlChart.data.datasets[0].data = currentValues.map(v => 
                ((v - baseValue) / baseValue * 100)
            );
            
            vlChart.options.scales.y.ticks.callback = function(value) {
                return value.toFixed(2) + '%';
            };
        } else {
            // Restore original data
            const period = document.querySelector('#periodFilters .filter-pill.active').dataset.period;
            const filteredData = filterDataByPeriod(vlDataRaw, period);
            vlChart.data.datasets[0].data = filteredData.values;
            
            vlChart.options.scales.y.ticks.callback = function(value) {
                return new Intl.NumberFormat('fr-FR').format(value);
            };
        }
        vlChart.update();
    });
    
    // Toggle options active state
    document.querySelectorAll('.toggle-option').forEach(toggle => {
        const checkbox = toggle.querySelector('input[type="checkbox"]');
        checkbox.addEventListener('change', function() {
            toggle.classList.toggle('active', this.checked);
        });
    });
    
    // ====================================
    // HISTORIQUE TAB FUNCTIONALITY
    // ====================================
    
    // Pagination state
    let historyCurrentPage = 1;
    const historyPageSize = 50;
    let historyData = [...vlDataRaw].reverse(); // Most recent first
    
    // Calculate daily and cumulative variations
    function calculateVariations(data) {
        if (!data || data.length === 0) return [];
        
        // Original data is sorted oldest to newest, we reversed it
        // So we need to calculate from the perspective of reversed data
        const originalData = [...data].reverse(); // Back to oldest first for calculations
        const firstValue = originalData[0].valeur;
        
        return data.map((item, index) => {
            const originalIndex = originalData.length - 1 - index;
            const prevIndex = originalIndex - 1;
            
            let var1j = 0;
            if (prevIndex >= 0) {
                const prevValue = originalData[prevIndex].valeur;
                var1j = ((item.valeur - prevValue) / prevValue) * 100;
            }
            
            const varCumul = ((item.valeur - firstValue) / firstValue) * 100;
            
            return {
                ...item,
                var1j: var1j,
                varCumul: varCumul
            };
        });
    }
    
    // Render history table
    function renderHistoryTable() {
        const tableBody = document.getElementById('historyTableBody');
        if (!tableBody) return;
        
        const dataWithVariations = calculateVariations(historyData);
        const startIndex = (historyCurrentPage - 1) * historyPageSize;
        const endIndex = Math.min(startIndex + historyPageSize, dataWithVariations.length);
        const pageData = dataWithVariations.slice(startIndex, endIndex);
        
        tableBody.innerHTML = '';
        
        if (pageData.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center py-5 text-muted">
                        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                        Aucune donnée disponible
                    </td>
                </tr>
            `;
            return;
        }
        
        pageData.forEach((item, index) => {
            const date = new Date(item.date);
            const formattedDate = date.toLocaleDateString('fr-FR', { 
                day: '2-digit', 
                month: 'short', 
                year: 'numeric' 
            });
            
            const var1jClass = item.var1j >= 0 ? 'text-success' : 'text-danger';
            const var1jIcon = item.var1j >= 0 ? 'bi-arrow-up' : 'bi-arrow-down';
            const var1jSign = item.var1j >= 0 ? '+' : '';
            
            const varCumulClass = item.varCumul >= 0 ? 'text-success' : 'text-danger';
            const varCumulSign = item.varCumul >= 0 ? '+' : '';
            
            tableBody.innerHTML += `
                <tr>
                    <td class="px-4 py-3">
                        <span class="fw-medium">${formattedDate}</span>
                    </td>
                    <td class="px-4 py-3 text-end">
                        <span class="fw-bold" style="color: var(--primary-color);">
                            ${new Intl.NumberFormat('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}).format(item.valeur)}
                        </span>
                        <span class="text-muted ms-1">XOF</span>
                    </td>
                    <td class="px-4 py-3 text-end">
                        <span class="${var1jClass}">
                            <i class="bi ${var1jIcon} me-1"></i>${var1jSign}${item.var1j.toFixed(2)}%
                        </span>
                    </td>
                    <td class="px-4 py-3 text-end">
                        <span class="${varCumulClass} fw-medium">
                            ${varCumulSign}${item.varCumul.toFixed(2)}%
                        </span>
                    </td>
                </tr>
            `;
        });
        
        // Update pagination info
        document.getElementById('showingFrom').textContent = startIndex + 1;
        document.getElementById('showingTo').textContent = endIndex;
        document.getElementById('totalRows').textContent = dataWithVariations.length;
        
        // Update pagination buttons
        document.getElementById('prevPageBtn').disabled = historyCurrentPage === 1;
        document.getElementById('nextPageBtn').disabled = endIndex >= dataWithVariations.length;
    }
    
    // Pagination handlers
    document.getElementById('prevPageBtn')?.addEventListener('click', function() {
        if (historyCurrentPage > 1) {
            historyCurrentPage--;
            renderHistoryTable();
        }
    });
    
    document.getElementById('nextPageBtn')?.addEventListener('click', function() {
        const maxPage = Math.ceil(historyData.length / historyPageSize);
        if (historyCurrentPage < maxPage) {
            historyCurrentPage++;
            renderHistoryTable();
        }
    });
    
    // History FCP Selector
    document.getElementById('historyFcpSelector')?.addEventListener('change', function() {
        const selectedFcp = this.value;
        window.location.href = '?fcp=' + encodeURIComponent(selectedFcp);
    });
    
    // Export CSV
    document.getElementById('exportCsvBtn')?.addEventListener('click', function() {
        const dataWithVariations = calculateVariations(historyData);
        
        let csv = 'Date;Valeur Liquidative;Variation 1J (%);Variation Cumul (%)\n';
        dataWithVariations.forEach(item => {
            const date = new Date(item.date).toLocaleDateString('fr-FR');
            csv += `${date};${item.valeur.toFixed(2)};${item.var1j.toFixed(2)};${item.varCumul.toFixed(2)}\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `VL_${selectedFcp.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0, 10)}.csv`;
        link.click();
    });
    
    // Initial render when tab is shown
    document.querySelector('button[data-bs-target="#history"]')?.addEventListener('shown.bs.tab', function() {
        renderHistoryTable();
    });
    
    // Also render if history tab is already visible (e.g., direct navigation)
    if (document.getElementById('history')?.classList.contains('show')) {
        renderHistoryTable();
    }
    
    // ====================================
    // MATRICE DE CORRELATION
    // ====================================
    
    function loadCorrelationMatrix(period = 'origin') {
        const container = document.getElementById('correlationTableContainer');
        container.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Chargement...</span>
                </div>
                <p class="text-muted mt-2">Calcul de la matrice de corrélation...</p>
            </div>
        `;
        
        fetch('/api/correlation-matrix/?period=' + period)
            .then(response => response.json())
            .then(data => {
                if (data.fcp_names && data.fcp_names.length > 0 && data.matrix.length > 0) {
                    document.getElementById('correlationObsCount').textContent = data.nb_observations;
                    renderCorrelationTable(data.fcp_names, data.matrix);
                } else {
                    container.innerHTML = `
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-exclamation-circle fs-1 d-block mb-2"></i>
                            <p>Données insuffisantes pour calculer la matrice de corrélation sur cette période.</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                container.innerHTML = `
                    <div class="text-center py-4 text-danger">
                        <i class="bi bi-x-circle fs-1 d-block mb-2"></i>
                        <p>Erreur lors du chargement de la matrice de corrélation.</p>
                    </div>
                `;
            });
    }
    
    function renderCorrelationTable(fcpNames, matrix) {
        const container = document.getElementById('correlationTableContainer');
        
        // Créer des noms courts pour les FCP
        const shortNames = fcpNames.map(name => {
            // Extraire les mots clés du nom
            const words = name.replace('FCP ', '').split(' ');
            if (words.length > 2) {
                return words.slice(0, 2).map(w => w.substring(0, 4)).join(' ');
            }
            return words.map(w => w.substring(0, 6)).join(' ');
        });
        
        let html = '<table class="table table-sm table-bordered mb-0" style="font-size: 11px;">';
        
        // En-tête
        html += '<thead><tr><th style="background: var(--bg-secondary);"></th>';
        shortNames.forEach((name, i) => {
            html += `<th class="text-center" style="background: var(--bg-secondary); writing-mode: vertical-rl; transform: rotate(180deg); height: 100px; white-space: nowrap;" title="${fcpNames[i]}">${name}</th>`;
        });
        html += '</tr></thead>';
        
        // Corps
        html += '<tbody>';
        matrix.forEach((row, i) => {
            html += `<tr><td class="fw-bold text-nowrap" style="background: var(--bg-secondary);" title="${fcpNames[i]}">${shortNames[i]}</td>`;
            row.forEach((corr, j) => {
                let bgColor, textColor;
                if (i === j) {
                    bgColor = '#004080';
                    textColor = 'white';
                } else if (corr >= 0.7) {
                    bgColor = `rgba(40, 167, 69, ${0.3 + corr * 0.7})`;
                    textColor = corr > 0.85 ? 'white' : 'black';
                } else if (corr >= 0.3) {
                    bgColor = `rgba(255, 193, 7, ${0.3 + corr * 0.5})`;
                    textColor = 'black';
                } else if (corr >= 0) {
                    bgColor = `rgba(200, 200, 200, ${0.2 + corr})`;
                    textColor = 'black';
                } else {
                    bgColor = `rgba(220, 53, 69, ${0.3 + Math.abs(corr) * 0.7})`;
                    textColor = Math.abs(corr) > 0.5 ? 'white' : 'black';
                }
                html += `<td class="text-center" style="background: ${bgColor}; color: ${textColor};">${corr.toFixed(2)}</td>`;
            });
            html += '</tr>';
        });
        html += '</tbody></table>';
        
        container.innerHTML = html;
    }
    
    // Correlation Period Filter Click Handler
    document.querySelectorAll('#correlationPeriodFilters .filter-pill').forEach(pill => {
        pill.addEventListener('click', function() {
            document.querySelectorAll('#correlationPeriodFilters .filter-pill').forEach(p => p.classList.remove('active'));
            this.classList.add('active');
            loadCorrelationMatrix(this.dataset.period);
        });
    });
    
    // Charger la matrice quand l'onglet Analyse est affiché
    document.querySelector('button[data-bs-target="#analysis"]')?.addEventListener('shown.bs.tab', function() {
        const activePeriod = document.querySelector('#correlationPeriodFilters .filter-pill.active')?.dataset.period || 'origin';
        loadCorrelationMatrix(activePeriod);
    });
    
    // ====================================
    // ONGLET RISQUE - CLUSTERING VOLATILITE
    // ====================================
    
    let volatilityChart = null;
    
    function loadVolatilityClustering(fcpName, window) {
        // Afficher les loaders
        document.getElementById('volatilityChartContainer').innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Chargement...</span>
                </div>
                <p class="text-muted mt-2">Calcul du clustering de volatilité...</p>
            </div>
        `;
        document.getElementById('regimeStatsContainer').innerHTML = '<div class="text-center py-4"><div class="spinner-border spinner-border-sm text-primary" role="status"></div></div>';
        document.getElementById('transitionMatrixContainer').innerHTML = '<div class="text-center py-4"><div class="spinner-border spinner-border-sm text-primary" role="status"></div></div>';
        
        fetch(`/api/volatility-clustering/?fcp=${encodeURIComponent(fcpName)}&window=${window}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('volatilityChartContainer').innerHTML = `
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-exclamation-circle fs-1 d-block mb-2"></i>
                            <p>${data.error}</p>
                        </div>
                    `;
                    return;
                }
                
                renderVolatilityChart(data.chart_data);
                renderRegimeStats(data.regime_stats);
                renderTransitionMatrix(data.transition_matrix);
                updateCurrentRegime(data.current_regime, data.current_volatility, data.thresholds);
            })
            .catch(error => {
                console.error('Erreur:', error);
                document.getElementById('volatilityChartContainer').innerHTML = `
                    <div class="text-center py-4 text-danger">
                        <i class="bi bi-x-circle fs-1 d-block mb-2"></i>
                        <p>Erreur lors du chargement des données.</p>
                    </div>
                `;
            });
    }
    
    function renderVolatilityChart(chartData) {
        const container = document.getElementById('volatilityChartContainer');
        container.innerHTML = '<canvas id="volatilityChart"></canvas>';
        
        const ctx = document.getElementById('volatilityChart').getContext('2d');
        
        const regimeColors = {
            0: '#28a745',  // Faible - Vert
            1: '#ffc107',  // Intermédiaire - Jaune
            2: '#dc3545'   // Élevé - Rouge
        };
        
        // Créer les données avec couleurs par segment
        const labels = chartData.map(d => d.date);
        const values = chartData.map(d => d.volatility);
        const colors = chartData.map(d => regimeColors[d.regime]);
        
        if (volatilityChart) {
            volatilityChart.destroy();
        }
        
        volatilityChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Volatilité glissante (%)',
                    data: values,
                    borderColor: '#004080',
                    backgroundColor: 'rgba(0, 64, 128, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.1,
                    pointRadius: 0,
                    pointHoverRadius: 5,
                    segment: {
                        borderColor: ctx => {
                            const idx = ctx.p0DataIndex;
                            return regimeColors[chartData[idx]?.regime] || '#004080';
                        },
                        backgroundColor: ctx => {
                            const idx = ctx.p0DataIndex;
                            const color = regimeColors[chartData[idx]?.regime] || '#004080';
                            return color.replace(')', ', 0.1)').replace('rgb', 'rgba');
                        }
                    }
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                const date = new Date(context[0].label);
                                return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'long', year: 'numeric' });
                            },
                            label: function(context) {
                                const regime = chartData[context.dataIndex]?.regime;
                                const regimeNames = {0: 'Faible', 1: 'Intermédiaire', 2: 'Élevé'};
                                return [
                                    'Volatilité: ' + context.raw.toFixed(2) + '%',
                                    'Régime: ' + regimeNames[regime]
                                ];
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: {
                            maxTicksLimit: 12,
                            callback: function(value) {
                                const date = new Date(this.getLabelForValue(value));
                                return date.toLocaleDateString('fr-FR', { month: 'short', year: '2-digit' });
                            }
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Volatilité annualisée (%)'
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    }
                }
            }
        });
    }
    
    function renderRegimeStats(regimeStats) {
        const container = document.getElementById('regimeStatsContainer');
        
        let html = '';
        const regimeOrder = [0, 1, 2];
        
        regimeOrder.forEach(regime => {
            const stats = regimeStats[regime];
            const percentage = stats.count > 0 ? ((stats.count / Object.values(regimeStats).reduce((a, b) => a + b.count, 0)) * 100).toFixed(1) : 0;
            
            html += `
                <div class="mb-3 p-3 rounded" style="background: ${stats.color}15; border-left: 4px solid ${stats.color};">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-bold" style="color: ${stats.color};">
                            <i class="bi bi-circle-fill me-2" style="font-size: 10px;"></i>${stats.nom}
                        </span>
                        <span class="badge" style="background: ${stats.color};">${stats.count} jours (${percentage}%)</span>
                    </div>
                    <div class="row text-center small">
                        <div class="col-4">
                            <div class="text-muted">Min</div>
                            <div class="fw-bold">${stats.min}%</div>
                        </div>
                        <div class="col-4">
                            <div class="text-muted">Moyenne</div>
                            <div class="fw-bold">${stats.mean}%</div>
                        </div>
                        <div class="col-4">
                            <div class="text-muted">Max</div>
                            <div class="fw-bold">${stats.max}%</div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    function renderTransitionMatrix(matrix) {
        const container = document.getElementById('transitionMatrixContainer');
        const regimeNames = ['Faible', 'Intermédiaire', 'Élevé'];
        const regimeColors = ['#28a745', '#ffc107', '#dc3545'];
        
        let html = '<table class="table table-sm table-bordered mb-0">';
        html += '<thead><tr><th style="background: var(--bg-secondary);">De \\ Vers</th>';
        regimeNames.forEach((name, i) => {
            html += `<th class="text-center" style="background: ${regimeColors[i]}20;">${name}</th>`;
        });
        html += '</tr></thead><tbody>';
        
        matrix.forEach((row, i) => {
            html += `<tr><td class="fw-bold" style="background: ${regimeColors[i]}20;">${regimeNames[i]}</td>`;
            row.forEach((prob, j) => {
                const intensity = prob / 100;
                const bgColor = i === j ? `rgba(0, 64, 128, ${0.2 + intensity * 0.6})` : `rgba(128, 128, 128, ${intensity * 0.5})`;
                html += `<td class="text-center" style="background: ${bgColor};">${prob}%</td>`;
            });
            html += '</tr>';
        });
        
        html += '</tbody></table>';
        html += `
            <div class="text-center mt-3">
                <small class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    Probabilité de transition d'un jour à l'autre
                </small>
            </div>
        `;
        
        container.innerHTML = html;
    }
    
    function updateCurrentRegime(regime, volatility, thresholds) {
        const regimeNames = {0: 'FAIBLE', 1: 'INTERMÉDIAIRE', 2: 'ÉLEVÉ'};
        const regimeColors = {0: '#28a745', 1: '#ffc107', 2: '#dc3545'};
        
        const badge = document.getElementById('currentRegimeBadge');
        badge.textContent = regimeNames[regime];
        badge.style.background = regimeColors[regime];
        
        document.getElementById('currentVolatilityValue').textContent = `Volatilité actuelle: ${volatility}%`;
        document.getElementById('thresholdsInfo').innerHTML = 
            `<span style="color: #28a745;">Faible ≤ ${thresholds.low}%</span> | 
             <span style="color: #ffc107;">Intermédiaire ≤ ${thresholds.high}%</span> | 
             <span style="color: #dc3545;">Élevé > ${thresholds.high}%</span>`;
    }
    
    // Risk FCP Selector
    document.getElementById('riskFcpSelector')?.addEventListener('change', function() {
        const selectedFcp = this.value;
        const window = document.getElementById('volatilityWindow').value;
        loadVolatilityClustering(selectedFcp, window);
    });
    
    // Volatility Window Slider
    document.getElementById('volatilityWindow')?.addEventListener('input', function() {
        document.getElementById('windowValue').textContent = this.value;
    });
    
    document.getElementById('volatilityWindow')?.addEventListener('change', function() {
        const fcpName = document.getElementById('riskFcpSelector').value;
        loadVolatilityClustering(fcpName, this.value);
    });
    
    // Charger les données quand l'onglet Risque est affiché
    document.querySelector('button[data-bs-target="#risk"]')?.addEventListener('shown.bs.tab', function() {
        const fcpName = document.getElementById('riskFcpSelector').value;
        const window = document.getElementById('volatilityWindow').value;
        loadVolatilityClustering(fcpName, window);
    });
});
</script>
{% endblock %}
