{% extends 'fcp_app/base.html' %}
{% load static %}

{% block title %}Valeurs Liquidatives - FCP Reporting{% endblock %}

{% block extra_css %}
<style>
    /* Tabs Styling */
    .nav-tabs-custom {
        border-bottom: 2px solid var(--border-color);
        gap: 8px;
    }
    
    .nav-tabs-custom .nav-link {
        border: none;
        color: var(--text-secondary);
        font-weight: 500;
        padding: 12px 20px;
        border-radius: 8px 8px 0 0;
        transition: all 0.2s ease;
        position: relative;
    }
    
    .nav-tabs-custom .nav-link:hover {
        color: var(--primary-color);
        background: var(--third-color);
    }
    
    .nav-tabs-custom .nav-link.active {
        color: var(--primary-color);
        background: var(--bg-primary);
        border-bottom: 3px solid var(--primary-color);
    }
    
    /* Filter Pills */
    .filter-pills {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
    }
    
    .filter-pill {
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 500;
        border: 1px solid var(--border-color);
        background: var(--bg-primary);
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .filter-pill:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
    }
    
    .filter-pill.active {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }
    
    /* Chart Container */
    .chart-container {
        position: relative;
        height: 350px;
        width: 100%;
    }
    
    .chart-container-scatter {
        position: relative;
        height: 300px;
        width: 100%;
    }
    
    /* Toggle Switch */
    .toggle-option {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: var(--bg-secondary);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .toggle-option:hover {
        background: var(--third-color);
    }
    
    .toggle-option.active {
        background: var(--primary-light);
        color: var(--primary-color);
    }
    
    .form-check-input:checked {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    /* Metric Cards */
    .metric-card {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        transition: all 0.2s ease;
    }
    
    .metric-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }
    
    .metric-card .metric-label {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-muted);
        margin-bottom: 8px;
    }
    
    .metric-card .metric-value {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-primary);
    }
    
    .metric-card .metric-change {
        font-size: 13px;
        margin-top: 6px;
    }
    
    .metric-card .metric-change.positive {
        color: var(--success-color);
    }
    
    .metric-card .metric-change.negative {
        color: var(--danger-color);
    }
    
    /* Section Headers */
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 16px;
    }
    
    .section-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .section-title i {
        color: var(--primary-color);
    }
    
    /* Options Bar */
    .options-bar {
        display: flex;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
    }
    
    /* Select Custom */
    .select-custom {
        padding: 8px 32px 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 13px;
        color: var(--text-primary);
        background: var(--bg-primary);
        cursor: pointer;
        min-width: 160px;
    }
    
    .select-custom:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(0, 64, 128, 0.1);
    }
    
    /* Legend Custom */
    .chart-legend {
        display: flex;
        justify-content: center;
        gap: 24px;
        margin-top: 16px;
        flex-wrap: wrap;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: var(--text-secondary);
    }
    
    .legend-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }
    
    .legend-line {
        width: 24px;
        height: 3px;
        border-radius: 2px;
    }
    
    /* Scatter Point Labels */
    .scatter-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: var(--bg-secondary);
        border-radius: 8px;
        margin-top: 16px;
    }
    
    .scatter-info-item {
        text-align: center;
    }
    
    .scatter-info-item .label {
        font-size: 11px;
        text-transform: uppercase;
        color: var(--text-muted);
    }
    
    .scatter-info-item .value {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
    }
</style>
{% endblock %}

{% block content %}
<!-- Navigation Tabs -->
<ul class="nav nav-tabs nav-tabs-custom mb-4" id="vlTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
            <i class="bi bi-grid-1x2-fill me-2"></i>Vue d'ensemble
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="performances-tab" data-bs-toggle="tab" data-bs-target="#performances" type="button" role="tab">
            <i class="bi bi-trophy me-2"></i>Performances
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">
            <i class="bi bi-table me-2"></i>Historique
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="analysis-tab" data-bs-toggle="tab" data-bs-target="#analysis" type="button" role="tab">
            <i class="bi bi-bar-chart-line me-2"></i>Analyse
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="risk-tab" data-bs-toggle="tab" data-bs-target="#risk" type="button" role="tab">
            <i class="bi bi-shield-exclamation me-2"></i>Risque
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="calendar-tab" data-bs-toggle="tab" data-bs-target="#calendar" type="button" role="tab">
            <i class="bi bi-calendar3 me-2"></i>Calendrier
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="vlTabsContent">
    <!-- Vue d'ensemble Tab -->
    <div class="tab-pane fade show active" id="overview" role="tabpanel">
        
        <!-- Évolution VL Section -->
        <div class="card mb-4">
            <div class="card-body">
                <!-- Header with filters -->
                <div class="section-header">
                    <div class="section-title">
                        <i class="bi bi-graph-up"></i>
                        <span>Évolution de la Valeur Liquidative</span>
                    </div>
                    
                    <div class="options-bar">
                        <!-- FCP Selector -->
                        <select class="select-custom" id="fcpSelector">
                            {% for fcp_name in fcp_list %}
                            <option value="{{ fcp_name }}" {% if fcp_name == selected_fcp %}selected{% endif %}>{{ fcp_name }}</option>
                            {% endfor %}
                        </select>
                        
                        <!-- Benchmark Toggle -->
                        <label class="toggle-option" id="benchmarkToggle">
                            <input class="form-check-input" type="checkbox" id="showBenchmark">
                            <span>Benchmark</span>
                        </label>
                        
                        <!-- Cumulative Toggle -->
                        <label class="toggle-option" id="cumulativeToggle">
                            <input class="form-check-input" type="checkbox" id="showCumulative">
                            <span>Vue Cumulée</span>
                        </label>
                    </div>
                </div>
                
                <!-- Period Filters -->
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
                    <div class="filter-pills" id="periodFilters">
                        <button class="filter-pill" data-period="1m">1M</button>
                        <button class="filter-pill" data-period="3m">3M</button>
                        <button class="filter-pill" data-period="6m">6M</button>
                        <button class="filter-pill active" data-period="1y">1A</button>
                        <button class="filter-pill" data-period="5y">5A</button>
                        <button class="filter-pill" data-period="all">Tout</button>
                    </div>
                </div>
                
                <!-- Chart -->
                <div class="chart-container">
                    <canvas id="vlEvolutionChart"></canvas>
                </div>
                
                <!-- Legend -->
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-line" style="background: #004080;"></div>
                        <span id="legendFcpName">{{ selected_fcp }}</span>
                    </div>
                    <div class="legend-item" id="benchmarkLegend" style="display: none;">
                        <div class="legend-line" style="background: #E0DEDD; border: 1px dashed #333;"></div>
                        <span>Benchmark (BRVM Composite)</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Metric Cards -->
        <div class="row mb-4">
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="metric-card">
                    <div class="metric-label">Dernière VL (<span id="metricDerniereDate">{{ stats.derniere_date|default:"--" }}</span>)</div>
                    <div class="metric-value" id="metricDerniereVL">{{ stats.derniere_vl|floatformat:2|default:"--" }} <small style="font-size: 14px;">XOF</small></div>
                    <div class="metric-change" id="metricVar1JContainer">
                        <span id="metricVar1J" class="{% if stats.var_1j >= 0 %}positive{% else %}negative{% endif %}">
                            <i class="bi bi-arrow-{% if stats.var_1j >= 0 %}up{% else %}down{% endif %}"></i> {% if stats.var_1j >= 0 %}+{% endif %}{{ stats.var_1j|default:"0" }}% (1j)
                        </span>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="metric-card">
                    <div class="metric-label">Rendement YTD</div>
                    <div class="metric-value" id="metricYTD">{% if stats.var_ytd >= 0 %}+{% endif %}{{ stats.var_ytd|default:"0" }}%</div>
                    <div class="metric-change">
                        Depuis début d'année
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="metric-card">
                    <div class="metric-label">Rendement Annualisé</div>
                    <div class="metric-value" id="metricRendementAnn">{% if analyse_stats.rendement_moyen_ann >= 0 %}+{% endif %}{{ analyse_stats.rendement_moyen_ann|default:"0" }}%</div>
                    <div class="metric-change">
                        Moyenne quotidienne × 365
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="metric-card">
                    <div class="metric-label">Volatilité</div>
                    <div class="metric-value" id="metricVolatilite">{{ stats.volatilite|default:"0" }}%</div>
                    <div class="metric-change">
                        Écart-type annualisé
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Risk/Return Scatter Plot -->
        <div class="card">
            <div class="card-body">
                <div class="section-header">
                    <div class="section-title">
                        <i class="bi bi-bullseye"></i>
                        <span>Rendement / Risque - Tous les FCP</span>
                    </div>
                    
                    <!-- Period Filters for Scatter -->
                    <div class="filter-pills" id="scatterPeriodFilters">
                        <button class="filter-pill" data-period="wtd">WTD</button>
                        <button class="filter-pill" data-period="mtd">MTD</button>
                        <button class="filter-pill" data-period="qtd">QTD</button>
                        <button class="filter-pill" data-period="std">STD</button>
                        <button class="filter-pill" data-period="ytd">YTD</button>
                        <button class="filter-pill active" data-period="origin">Origine</button>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-lg-8">
                        <div class="chart-container-scatter">
                            <canvas id="riskReturnChart"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="scatter-info flex-column h-100 justify-content-center">
                            <div class="scatter-info-item mb-3">
                                <div class="label">FCP sélectionné</div>
                                <div class="value fw-bold" style="color: var(--primary-color);" id="scatterSelectedFcp">{{ selected_fcp }}</div>
                            </div>
                            <div class="scatter-info-item mb-3">
                                <div class="label">Rendement</div>
                                <div class="value" id="scatterRendement" style="color: var(--success-color);">{{ stats.var_origine|default:"0" }}%</div>
                            </div>
                            <div class="scatter-info-item mb-3">
                                <div class="label">Risque (Volatilité)</div>
                                <div class="value" id="scatterVolatilite">{{ stats.volatilite|default:"0" }}%</div>
                            </div>
                            <div class="scatter-info-item mb-3">
                                <div class="label">Ratio Rendement/Risque</div>
                                <div class="value" id="scatterRatio">--</div>
                            </div>
                            <div class="scatter-info-item">
                                <div class="label">Type de fond</div>
                                <div class="value" id="scatterTypeFond" style="color: var(--primary-color);">
                                    <i class="bi bi-tag-fill me-1"></i>--
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Scatter Legend par Type de Fond -->
                <div class="d-flex justify-content-between align-items-center flex-wrap mt-3">
                    <div class="chart-legend" id="scatterLegend">
                        <div class="legend-item" data-type="Obligataire">
                            <div class="legend-dot" style="background: #004080;"></div>
                            <span>Obligataire</span>
                        </div>
                        <div class="legend-item" data-type="Diversifié">
                            <div class="legend-dot" style="background: #28a745;"></div>
                            <span>Diversifié</span>
                        </div>
                        <div class="legend-item" data-type="Actions">
                            <div class="legend-dot" style="background: #dc3545;"></div>
                            <span>Actions</span>
                        </div>
                        <div class="legend-item" data-type="Monétaire">
                            <div class="legend-dot" style="background: #ffc107;"></div>
                            <span>Monétaire</span>
                        </div>
                    </div>
                    <div class="text-muted small" id="scatterDateNote">
                        <i class="bi bi-info-circle me-1"></i>
                        Données au <strong id="overviewDerniereDate">{{ stats.derniere_date }}</strong> (dernière date en base)
                    </div>
                </div>
            </div>
        </div>
        
    </div>
    
    <!-- Performances Tab -->
    <div class="tab-pane fade" id="performances" role="tabpanel">
        <div class="row g-4">
            <!-- Sélecteur FCP -->
            <div class="col-12">
                <div class="card">
                    <div class="card-body py-3">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-trophy me-2" style="color: var(--primary-color);"></i>
                                Performances - <span id="perfFcpTitle" style="color: var(--primary-color);">{{ selected_fcp }}</span>
                            </h5>
                            <div class="d-flex align-items-center gap-2">
                                <label class="text-muted small me-2">Sélectionner un FCP :</label>
                                <select class="select-custom" id="perfFcpSelector" style="min-width: 220px;">
                                    {% for fcp_name in fcp_list %}
                                    <option value="{{ fcp_name }}" {% if fcp_name == selected_fcp %}selected{% endif %}>{{ fcp_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Performances Calendaires -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-calendar3 me-2"></i>Performances Calendaires
                        </h5>
                        <small class="text-muted">Depuis le début de chaque période</small>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th class="px-4 py-3">Période</th>
                                    <th class="px-4 py-3">Description</th>
                                    <th class="px-4 py-3 text-end">Performance</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="px-4 py-3"><span class="badge bg-secondary">WTD</span></td>
                                    <td class="px-4 py-3 text-muted">Week-to-Date</td>
                                    <td class="px-4 py-3 text-end" id="perf-wtd">
                                        {% if perf_calendaires.wtd != None %}
                                        <span class="fw-bold {% if perf_calendaires.wtd >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {% if perf_calendaires.wtd >= 0 %}+{% endif %}{{ perf_calendaires.wtd }}%
                                        </span>
                                        {% else %}<span class="text-muted">N/A</span>{% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3"><span class="badge bg-secondary">MTD</span></td>
                                    <td class="px-4 py-3 text-muted">Month-to-Date</td>
                                    <td class="px-4 py-3 text-end" id="perf-mtd">
                                        {% if perf_calendaires.mtd != None %}
                                        <span class="fw-bold {% if perf_calendaires.mtd >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {% if perf_calendaires.mtd >= 0 %}+{% endif %}{{ perf_calendaires.mtd }}%
                                        </span>
                                        {% else %}<span class="text-muted">N/A</span>{% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3"><span class="badge bg-secondary">QTD</span></td>
                                    <td class="px-4 py-3 text-muted">Quarter-to-Date</td>
                                    <td class="px-4 py-3 text-end" id="perf-qtd">
                                        {% if perf_calendaires.qtd != None %}
                                        <span class="fw-bold {% if perf_calendaires.qtd >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {% if perf_calendaires.qtd >= 0 %}+{% endif %}{{ perf_calendaires.qtd }}%
                                        </span>
                                        {% else %}<span class="text-muted">N/A</span>{% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3"><span class="badge bg-secondary">STD</span></td>
                                    <td class="px-4 py-3 text-muted">Semester-to-Date</td>
                                    <td class="px-4 py-3 text-end" id="perf-std">
                                        {% if perf_calendaires.std != None %}
                                        <span class="fw-bold {% if perf_calendaires.std >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {% if perf_calendaires.std >= 0 %}+{% endif %}{{ perf_calendaires.std }}%
                                        </span>
                                        {% else %}<span class="text-muted">N/A</span>{% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3"><span class="badge" style="background: var(--primary-color);">YTD</span></td>
                                    <td class="px-4 py-3 text-muted">Year-to-Date</td>
                                    <td class="px-4 py-3 text-end" id="perf-ytd">
                                        {% if perf_calendaires.ytd != None %}
                                        <span class="fw-bold {% if perf_calendaires.ytd >= 0 %}text-success{% else %}text-danger{% endif %}" style="font-size: 1.1em;">
                                            {% if perf_calendaires.ytd >= 0 %}+{% endif %}{{ perf_calendaires.ytd }}%
                                        </span>
                                        {% else %}<span class="text-muted">N/A</span>{% endif %}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Performances Glissantes -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-arrow-repeat me-2"></i>Performances Glissantes
                        </h5>
                        <small class="text-muted">Sur les X derniers mois/années</small>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th class="px-4 py-3">Période</th>
                                    <th class="px-4 py-3">Description</th>
                                    <th class="px-4 py-3 text-end">Performance</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="px-4 py-3"><span class="badge bg-info">1M</span></td>
                                    <td class="px-4 py-3 text-muted">1 Mois</td>
                                    <td class="px-4 py-3 text-end" id="perf-1m">
                                        {% if perf_glissantes.perf_1m != None %}
                                        <span class="fw-bold {% if perf_glissantes.perf_1m >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {% if perf_glissantes.perf_1m >= 0 %}+{% endif %}{{ perf_glissantes.perf_1m }}%
                                        </span>
                                        {% else %}<span class="text-muted">N/A</span>{% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3"><span class="badge bg-info">3M</span></td>
                                    <td class="px-4 py-3 text-muted">3 Mois</td>
                                    <td class="px-4 py-3 text-end" id="perf-3m">
                                        {% if perf_glissantes.perf_3m != None %}
                                        <span class="fw-bold {% if perf_glissantes.perf_3m >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {% if perf_glissantes.perf_3m >= 0 %}+{% endif %}{{ perf_glissantes.perf_3m }}%
                                        </span>
                                        {% else %}<span class="text-muted">N/A</span>{% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3"><span class="badge bg-info">6M</span></td>
                                    <td class="px-4 py-3 text-muted">6 Mois</td>
                                    <td class="px-4 py-3 text-end" id="perf-6m">
                                        {% if perf_glissantes.perf_6m != None %}
                                        <span class="fw-bold {% if perf_glissantes.perf_6m >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {% if perf_glissantes.perf_6m >= 0 %}+{% endif %}{{ perf_glissantes.perf_6m }}%
                                        </span>
                                        {% else %}<span class="text-muted">N/A</span>{% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3"><span class="badge bg-info">1A</span></td>
                                    <td class="px-4 py-3 text-muted">1 An</td>
                                    <td class="px-4 py-3 text-end" id="perf-1y">
                                        {% if perf_glissantes.perf_1y != None %}
                                        <span class="fw-bold {% if perf_glissantes.perf_1y >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {% if perf_glissantes.perf_1y >= 0 %}+{% endif %}{{ perf_glissantes.perf_1y }}%
                                        </span>
                                        {% else %}<span class="text-muted">N/A</span>{% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3"><span class="badge bg-info">3A</span></td>
                                    <td class="px-4 py-3 text-muted">3 Ans</td>
                                    <td class="px-4 py-3 text-end" id="perf-3y">
                                        {% if perf_glissantes.perf_3y != None %}
                                        <span class="fw-bold {% if perf_glissantes.perf_3y >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {% if perf_glissantes.perf_3y >= 0 %}+{% endif %}{{ perf_glissantes.perf_3y }}%
                                        </span>
                                        {% else %}<span class="text-muted">N/A</span>{% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3"><span class="badge bg-info">5A</span></td>
                                    <td class="px-4 py-3 text-muted">5 Ans</td>
                                    <td class="px-4 py-3 text-end" id="perf-5y">
                                        {% if perf_glissantes.perf_5y != None %}
                                        <span class="fw-bold {% if perf_glissantes.perf_5y >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {% if perf_glissantes.perf_5y >= 0 %}+{% endif %}{{ perf_glissantes.perf_5y }}%
                                        </span>
                                        {% else %}<span class="text-muted">N/A</span>{% endif %}
                                    </td>
                                </tr>
                                <tr style="background: rgba(0, 64, 128, 0.05);">
                                    <td class="px-4 py-3"><span class="badge" style="background: var(--primary-color);">Origine</span></td>
                                    <td class="px-4 py-3 text-muted">Depuis la création</td>
                                    <td class="px-4 py-3 text-end" id="perf-origine">
                                        {% if perf_glissantes.origine != None %}
                                        <span class="fw-bold {% if perf_glissantes.origine >= 0 %}text-success{% else %}text-danger{% endif %}" style="font-size: 1.1em;">
                                            {% if perf_glissantes.origine >= 0 %}+{% endif %}{{ perf_glissantes.origine }}%
                                        </span>
                                        {% else %}<span class="text-muted">N/A</span>{% endif %}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Note -->
            <div class="col-12">
                <div class="alert alert-light border d-flex align-items-center" role="alert">
                    <i class="bi bi-info-circle me-2" style="color: var(--primary-color);"></i>
                    <div>
                        <small>Données calculées au <strong id="perf-derniere-date">{{ stats.derniere_date }}</strong> (dernière VL en base). 
                        Les performances passées ne préjugent pas des performances futures.</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Historique Tab -->
    <div class="tab-pane fade" id="history" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                <h5 class="card-title mb-0">
                    <i class="bi bi-table me-2"></i>Historique des Valeurs Liquidatives - <span id="historyFcpTitle">{{ selected_fcp }}</span>
                </h5>
                <div class="d-flex gap-2 align-items-center flex-wrap">
                    <select class="select-custom" id="historyFcpSelector" style="min-width: 200px;">
                        {% for fcp_name in fcp_list %}
                        <option value="{{ fcp_name }}" {% if fcp_name == selected_fcp %}selected{% endif %}>{{ fcp_name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="card-body p-0">
                <!-- Stats Summary -->
                <div class="history-stats d-flex justify-content-around flex-wrap py-3 px-4 border-bottom" style="background: var(--bg-secondary);">
                    <div class="text-center px-3">
                        <div class="text-muted small text-uppercase">Nb. Observations</div>
                        <div class="fw-bold fs-5" id="history-nb-obs" style="color: var(--primary-color);">{{ stats.nb_vl|default:"0" }}</div>
                    </div>
                    <div class="text-center px-3">
                        <div class="text-muted small text-uppercase">Première Date</div>
                        <div class="fw-bold" id="history-premiere-date">{{ stats.premiere_date|default:"--" }}</div>
                    </div>
                    <div class="text-center px-3">
                        <div class="text-muted small text-uppercase">Dernière Date</div>
                        <div class="fw-bold" id="history-derniere-date">{{ stats.derniere_date|default:"--" }}</div>
                    </div>
                    <div class="text-center px-3">
                        <div class="text-muted small text-uppercase">Perf. Origine</div>
                        <div class="fw-bold" id="history-perf-origine">
                            <span class="{% if stats.var_origine >= 0 %}text-success{% else %}text-danger{% endif %}">
                                {% if stats.var_origine >= 0 %}+{% endif %}{{ stats.var_origine|default:"0" }}%
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- Table Container -->
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-hover table-striped mb-0" id="historyTable">
                        <thead class="sticky-top" style="background: var(--bg-primary);">
                            <tr>
                                <th class="px-4 py-3" style="min-width: 120px;">
                                    <span class="d-flex align-items-center gap-2">
                                        <i class="bi bi-calendar3"></i> Date
                                    </span>
                                </th>
                                <th class="px-4 py-3 text-end" style="min-width: 140px;">
                                    <span class="d-flex align-items-center justify-content-end gap-2">
                                        Valeur Liquidative <i class="bi bi-currency-exchange"></i>
                                    </span>
                                </th>
                                <th class="px-4 py-3 text-end" style="min-width: 120px;">
                                    <span class="d-flex align-items-center justify-content-end gap-2">
                                        Var. 1J <i class="bi bi-graph-up-arrow"></i>
                                    </span>
                                </th>
                                <th class="px-4 py-3 text-end" style="min-width: 120px;">
                                    <span class="d-flex align-items-center justify-content-end gap-2">
                                        Var. Cumul <i class="bi bi-bar-chart-line"></i>
                                    </span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <!-- Rempli par JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div class="d-flex justify-content-between align-items-center px-4 py-3 border-top">
                    <div class="text-muted small">
                        Affichage <span id="showingFrom">1</span>-<span id="showingTo">50</span> sur <span id="totalRows">{{ stats.nb_vl|default:"0" }}</span> lignes
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-secondary" id="prevPageBtn" disabled>
                            <i class="bi bi-chevron-left"></i> Précédent
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" id="nextPageBtn">
                            Suivant <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Analyse Tab -->
    <div class="tab-pane fade" id="analysis" role="tabpanel">
        <div class="row g-4">
            <!-- Header -->
            <div class="col-12">
                <div class="card">
                    <div class="card-body py-3">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-bar-chart-line me-2" style="color: var(--primary-color);"></i>
                                Analyse - <span id="analyseFcpTitle" style="color: var(--primary-color);">{{ selected_fcp }}</span>
                            </h5>
                            <div class="d-flex align-items-center gap-2">
                                <label class="text-muted small me-2">Sélectionner un FCP :</label>
                                <select class="select-custom" id="analyseFcpSelector" style="min-width: 220px;">
                                    {% for fcp_name in fcp_list %}
                                    <option value="{{ fcp_name }}" {% if fcp_name == selected_fcp %}selected{% endif %}>{{ fcp_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Statistiques Descriptives -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-calculator me-2"></i>Statistiques Descriptives
                        </h5>
                        <small class="text-muted">Analyse des rendements quotidiens</small>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-hover mb-0">
                            <tbody>
                                <tr>
                                    <td class="px-4 py-3">
                                        <i class="bi bi-hash me-2 text-muted"></i>Nombre d'observations
                                    </td>
                                    <td class="px-4 py-3 text-end fw-bold" id="analyse-nb-obs">{{ analyse_stats.nb_observations|default:"--" }}</td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3">
                                        <i class="bi bi-graph-up me-2 text-muted"></i>Rendement moyen quotidien
                                    </td>
                                    <td class="px-4 py-3 text-end fw-bold" id="analyse-rdt-moyen">{{ analyse_stats.rendement_moyen|default:"--" }}%</td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3">
                                        <i class="bi bi-graph-up-arrow me-2 text-muted"></i>Rendement annualisé
                                    </td>
                                    <td class="px-4 py-3 text-end" id="analyse-rdt-ann">
                                        <span class="fw-bold {% if analyse_stats.rendement_moyen_ann >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {% if analyse_stats.rendement_moyen_ann >= 0 %}+{% endif %}{{ analyse_stats.rendement_moyen_ann|default:"--" }}%
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3">
                                        <i class="bi bi-distribute-vertical me-2 text-muted"></i>Médiane
                                    </td>
                                    <td class="px-4 py-3 text-end fw-bold" id="analyse-mediane">{{ analyse_stats.mediane|default:"--" }}%</td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3">
                                        <i class="bi bi-bar-chart me-2 text-muted"></i>Écart-type quotidien
                                    </td>
                                    <td class="px-4 py-3 text-end fw-bold" id="analyse-ecart-type">{{ analyse_stats.ecart_type|default:"--" }}%</td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3">
                                        <i class="bi bi-activity me-2 text-muted"></i>Volatilité annualisée
                                    </td>
                                    <td class="px-4 py-3 text-end fw-bold" id="analyse-volatilite" style="color: var(--primary-color);">{{ analyse_stats.volatilite_ann|default:"--" }}%</td>
                                </tr>
                                <tr class="table-light">
                                    <td class="px-4 py-3">
                                        <i class="bi bi-arrow-down-circle me-2 text-danger"></i>VL Minimum
                                    </td>
                                    <td class="px-4 py-3 text-end fw-bold" id="analyse-vl-min">{{ analyse_stats.vl_min|default:"--" }} XOF</td>
                                </tr>
                                <tr class="table-light">
                                    <td class="px-4 py-3">
                                        <i class="bi bi-arrow-up-circle me-2 text-success"></i>VL Maximum
                                    </td>
                                    <td class="px-4 py-3 text-end fw-bold" id="analyse-vl-max">{{ analyse_stats.vl_max|default:"--" }} XOF</td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3">
                                        <i class="bi bi-chevron-double-down me-2 text-danger"></i>Pire rendement quotidien
                                    </td>
                                    <td class="px-4 py-3 text-end fw-bold text-danger" id="analyse-rdt-min">{{ analyse_stats.rdt_min|default:"--" }}%</td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3">
                                        <i class="bi bi-chevron-double-up me-2 text-success"></i>Meilleur rendement quotidien
                                    </td>
                                    <td class="px-4 py-3 text-end fw-bold text-success" id="analyse-rdt-max">+{{ analyse_stats.rdt_max|default:"--" }}%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Profil de Risque -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-shield-exclamation me-2"></i>Profil de Risque
                        </h5>
                        <small class="text-muted">Indicateurs de risque et ratios</small>
                    </div>
                    <div class="card-body">
                        <!-- Drawdown Max -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted">
                                    <i class="bi bi-graph-down-arrow me-2"></i>Drawdown Maximum
                                </span>
                                <span class="fw-bold text-danger fs-5" id="analyse-max-drawdown">-{{ analyse_stats.max_drawdown|default:"--" }}%</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-danger" role="progressbar" id="analyse-drawdown-bar"
                                     style="width: {{ analyse_stats.max_drawdown|default:0 }}%"></div>
                            </div>
                            <small class="text-muted">Perte maximale depuis un pic historique</small>
                        </div>
                        
                        <!-- Ratio de Sharpe -->
                        <div class="mb-4 p-3 rounded" style="background: var(--bg-secondary);">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi bi-trophy me-2" style="color: var(--primary-color);"></i>
                                    <span class="fw-medium">Ratio de Sharpe</span>
                                    <br><small class="text-muted">Rendement ajusté du risque (rf=3,25%)</small>
                                </div>
                                <span class="fs-4 fw-bold" id="analyse-sharpe">
                                    {{ analyse_stats.sharpe|default:"--" }}
                                </span>
                            </div>
                        </div>
                        
                        <!-- Ratio de Sortino -->
                        <div class="mb-4 p-3 rounded" style="background: var(--bg-secondary);">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi bi-shield-check me-2" style="color: var(--primary-color);"></i>
                                    <span class="fw-medium">Ratio de Sortino</span>
                                    <br><small class="text-muted">Rendement ajusté du risque baissier</small>
                                </div>
                                <span class="fs-4 fw-bold" id="analyse-sortino">
                                    {{ analyse_stats.sortino|default:"--" }}
                                </span>
                            </div>
                        </div>
                        
                        <!-- Jours Positifs/Négatifs -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted">Distribution des jours</span>
                                <span class="fw-bold" id="analyse-ratio-positif">{{ analyse_stats.ratio_positif|default:"--" }}% positifs</span>
                            </div>
                            <div class="progress" style="height: 24px;" id="analyse-jours-progress">
                                <div class="progress-bar bg-success" role="progressbar" id="analyse-jours-positifs-bar"
                                     style="width: {{ analyse_stats.ratio_positif|default:50 }}%"
                                     title="{{ analyse_stats.jours_positifs }} jours positifs">
                                    <small><span id="analyse-jours-positifs">{{ analyse_stats.jours_positifs|default:"--" }}</span> <i class="bi bi-arrow-up"></i></small>
                                </div>
                                <div class="progress-bar bg-danger" role="progressbar" id="analyse-jours-negatifs-bar"
                                     style="width: {% widthratio analyse_stats.jours_negatifs analyse_stats.nb_observations 100 %}%"
                                     title="{{ analyse_stats.jours_negatifs }} jours négatifs">
                                    <small><span id="analyse-jours-negatifs">{{ analyse_stats.jours_negatifs|default:"--" }}</span> <i class="bi bi-arrow-down"></i></small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tracking Error Table -->
                        <div class="mt-4">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-graph-up-arrow me-2" style="color: var(--primary-color);"></i>
                                <span class="fw-medium">Tracking Error (Volatilité annualisée)</span>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered mb-0" style="font-size: 0.85rem;">
                                    <thead style="background: var(--bg-secondary);">
                                        <tr class="text-center">
                                            <th class="py-2">WTD</th>
                                            <th class="py-2">MTD</th>
                                            <th class="py-2">QTD</th>
                                            <th class="py-2">STD</th>
                                            <th class="py-2">YTD</th>
                                            <th class="py-2">Origine</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="text-center">
                                            <td class="py-2 fw-bold" id="tracking-error-wtd">{{ tracking_error.wtd|default:"--" }}%</td>
                                            <td class="py-2 fw-bold" id="tracking-error-mtd">{{ tracking_error.mtd|default:"--" }}%</td>
                                            <td class="py-2 fw-bold" id="tracking-error-qtd">{{ tracking_error.qtd|default:"--" }}%</td>
                                            <td class="py-2 fw-bold" id="tracking-error-std">{{ tracking_error.std|default:"--" }}%</td>
                                            <td class="py-2 fw-bold" id="tracking-error-ytd">{{ tracking_error.ytd|default:"--" }}%</td>
                                            <td class="py-2 fw-bold" id="tracking-error-origine" style="color: var(--primary-color);">{{ tracking_error.origine|default:"--" }}%</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Légende interprétation -->
                        <div class="alert alert-light border-0 mb-0 mt-4">
                            <small>
                                <strong>Interprétation des ratios :</strong><br>
                                <span class="text-success">● &gt; 1</span> = Excellent |
                                <span class="text-warning">● 0-1</span> = Acceptable |
                                <span class="text-danger">● &lt; 0</span> = À éviter
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Distribution des Rendements -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-bar-chart me-2"></i>Distribution des Rendements
                        </h5>
                        <small class="text-muted">Histogramme et test de normalité</small>
                    </div>
                    <div class="card-body">
                        <div style="height: 200px;">
                            <canvas id="histogramChart"></canvas>
                        </div>
                        <!-- Statistiques de distribution -->
                        <div class="row mt-3 text-center">
                            <div class="col-6">
                                <div class="p-2 rounded" style="background: var(--bg-secondary);">
                                    <div class="text-muted small">Skewness (Asymétrie)</div>
                                    <div class="fw-bold fs-5" id="analyse-skewness">
                                        {{ analyse_stats.skewness|default:"--" }}
                                    </div>
                                    <small class="text-muted" id="analyse-skewness-desc">{% if analyse_stats.skewness > 0.5 %}Queue droite{% elif analyse_stats.skewness < -0.5 %}Queue gauche{% else %}≈ Symétrique{% endif %}</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 rounded" style="background: var(--bg-secondary);">
                                    <div class="text-muted small">Kurtosis (Excès)</div>
                                    <div class="fw-bold fs-5" id="analyse-kurtosis">
                                        {{ analyse_stats.kurtosis|default:"--" }}
                                    </div>
                                    <small class="text-muted" id="analyse-kurtosis-desc">{% if analyse_stats.kurtosis > 1 %}Queues épaisses{% elif analyse_stats.kurtosis < -1 %}Queues fines{% else %}≈ Normal{% endif %}</small>
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-light border-0 mt-3 mb-0 small">
                            <i class="bi bi-info-circle me-1"></i>
                            <strong>Normalité :</strong> Skewness ≈ 0 et Kurtosis ≈ 0 indiquent une distribution normale.
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- VaR et CVaR -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>Value at Risk (VaR)
                        </h5>
                        <small class="text-muted">Mesures de risque extrême - Méthode historique</small>
                    </div>
                    <div class="card-body">
                        <!-- VaR 95% -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <span class="fw-medium">VaR 95%</span>
                                    <br><small class="text-muted">Perte max dans 95% des cas (1 jour)</small>
                                </div>
                                <span class="fs-4 fw-bold text-danger" id="analyse-var95">{{ analyse_stats.var_95|default:"--" }}%</span>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-warning" role="progressbar" style="width: 95%;"></div>
                                <div class="progress-bar bg-danger" role="progressbar" style="width: 5%;"></div>
                            </div>
                        </div>
                        
                        <!-- VaR 99% -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <span class="fw-medium">VaR 99%</span>
                                    <br><small class="text-muted">Perte max dans 99% des cas (1 jour)</small>
                                </div>
                                <span class="fs-4 fw-bold text-danger" id="analyse-var99">{{ analyse_stats.var_99|default:"--" }}%</span>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-warning" role="progressbar" style="width: 99%;"></div>
                                <div class="progress-bar bg-danger" role="progressbar" style="width: 1%;"></div>
                            </div>
                        </div>
                        
                        <!-- CVaR / Expected Shortfall -->
                        <div class="row">
                            <div class="col-6">
                                <div class="p-3 rounded text-center" style="background: rgba(220, 53, 69, 0.1); border: 1px solid rgba(220, 53, 69, 0.3);">
                                    <div class="text-muted small">CVaR 95%</div>
                                    <div class="fw-bold fs-5 text-danger" id="analyse-cvar95">{{ analyse_stats.cvar_95|default:"--" }}%</div>
                                    <small class="text-muted">Expected Shortfall</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-3 rounded text-center" style="background: rgba(220, 53, 69, 0.15); border: 1px solid rgba(220, 53, 69, 0.4);">
                                    <div class="text-muted small">CVaR 99%</div>
                                    <div class="fw-bold fs-5 text-danger" id="analyse-cvar99">{{ analyse_stats.cvar_99|default:"--" }}%</div>
                                    <small class="text-muted">Expected Shortfall</small>
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-light border-0 mt-3 mb-0 small">
                            <i class="bi bi-info-circle me-1"></i>
                            <strong>CVaR</strong> = Perte moyenne quand on dépasse la VaR (plus conservateur).
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Underwater Chart (Drawdowns dans le temps) -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-water me-2"></i>Underwater Chart - Évolution des Drawdowns
                        </h5>
                        <small class="text-muted">Visualisation des périodes de perte par rapport aux pics historiques</small>
                    </div>
                    <div class="card-body">
                        <div style="height: 250px;">
                            <canvas id="underwaterChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Top Drawdowns -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div>
                            <h5 class="card-title mb-0">
                                <i class="bi bi-graph-down-arrow me-2"></i>Top 5 des Pires Drawdowns
                            </h5>
                            <small class="text-muted">Analyse détaillée des périodes de baisse</small>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <label class="text-muted small">Seuil minimum :</label>
                            <select class="select-custom" id="drawdownThreshold" style="width: auto;">
                                <option value="0">Tous</option>
                                <option value="1">≥ 1%</option>
                                <option value="2" selected>≥ 2%</option>
                                <option value="5">≥ 5%</option>
                                <option value="10">≥ 10%</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" id="drawdownsTable">
                                <thead>
                                    <tr>
                                        <th class="px-4 py-3">#</th>
                                        <th class="px-4 py-3">Début</th>
                                        <th class="px-4 py-3">Point bas</th>
                                        <th class="px-4 py-3">Fin</th>
                                        <th class="px-4 py-3 text-end">Profondeur</th>
                                        <th class="px-4 py-3 text-center">Durée (jours)</th>
                                        <th class="px-4 py-3 text-center">Recovery (jours)</th>
                                    </tr>
                                </thead>
                                <tbody id="drawdownsTableBody">
                                    <!-- Rempli par JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Note -->
            <div class="col-12">
                <div class="alert alert-light border d-flex align-items-center" role="alert">
                    <i class="bi bi-info-circle me-2" style="color: var(--primary-color);"></i>
                    <div>
                        <small>Analyse basée sur les données du <strong>{{ stats.premiere_date }}</strong> au <strong>{{ stats.derniere_date }}</strong>. 
                        Taux sans risque utilisé : 3,25% annuel.</small>
                    </div>
                </div>
            </div>
            
            <!-- Matrice de Corrélation -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div>
                            <h5 class="card-title mb-0">
                                <i class="bi bi-grid-3x3 me-2"></i>Matrice de Corrélation
                            </h5>
                            <small class="text-muted">Corrélation des rendements entre FCP</small>
                        </div>
                        <div class="filter-pills" id="correlationPeriodFilters">
                            <button class="filter-pill" data-period="wtd">WTD</button>
                            <button class="filter-pill" data-period="mtd">MTD</button>
                            <button class="filter-pill" data-period="qtd">QTD</button>
                            <button class="filter-pill" data-period="std">STD</button>
                            <button class="filter-pill" data-period="ytd">YTD</button>
                            <button class="filter-pill active" data-period="origin">Origine</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-3">
                            <small class="text-muted"><span id="correlationObsCount">--</span> observations communes</small>
                        </div>
                        <div class="table-responsive" id="correlationTableContainer">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Chargement...</span>
                                </div>
                                <p class="text-muted mt-2">Calcul de la matrice de corrélation...</p>
                            </div>
                        </div>
                        <!-- Légende -->
                        <div class="d-flex justify-content-center gap-4 mt-3 flex-wrap">
                            <div class="d-flex align-items-center gap-2">
                                <div style="width: 20px; height: 20px; background: #28a745; border-radius: 4px;"></div>
                                <small class="text-muted">Corrélation positive forte (> 0.7)</small>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <div style="width: 20px; height: 20px; background: #ffc107; border-radius: 4px;"></div>
                                <small class="text-muted">Corrélation modérée (0.3 - 0.7)</small>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <div style="width: 20px; height: 20px; background: #dc3545; border-radius: 4px;"></div>
                                <small class="text-muted">Corrélation négative (< 0)</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Risque Tab -->
    <div class="tab-pane fade" id="risk" role="tabpanel">
        <div class="row g-4">
            <!-- Header -->
            <div class="col-12">
                <div class="card">
                    <div class="card-body py-3">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-shield-exclamation me-2" style="color: var(--primary-color);"></i>
                                Analyse du Risque - <span id="riskFcpTitle" style="color: var(--primary-color);">{{ selected_fcp }}</span>
                            </h5>
                            <div class="d-flex align-items-center gap-3 flex-wrap">
                                <div class="d-flex align-items-center gap-2">
                                    <label class="text-muted small">FCP :</label>
                                    <select class="select-custom" id="riskFcpSelector" style="min-width: 220px;">
                                        {% for fcp_name in fcp_list %}
                                        <option value="{{ fcp_name }}" {% if fcp_name == selected_fcp %}selected{% endif %}>{{ fcp_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <label class="text-muted small">Fenêtre :</label>
                                    <input type="range" class="form-range" id="volatilityWindow" min="5" max="30" value="20" style="width: 100px;">
                                    <span class="badge bg-primary" id="windowValue">20</span>
                                    <small class="text-muted">jours</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Graphique Volatilité Glissante -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-activity me-2"></i>Volatilité Glissante et Régimes
                        </h5>
                        <small class="text-muted">Clustering en 3 régimes : Faible, Intermédiaire, Élevé</small>
                    </div>
                    <div class="card-body">
                        <div id="volatilityChartContainer" style="height: 350px;">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Chargement...</span>
                                </div>
                                <p class="text-muted mt-2">Calcul du clustering de volatilité...</p>
                            </div>
                        </div>
                        <canvas id="volatilityChart" style="display: none;"></canvas>
                        <!-- Légende régimes -->
                        <div class="d-flex justify-content-center gap-4 mt-3">
                            <div class="d-flex align-items-center gap-2">
                                <div style="width: 16px; height: 16px; background: #28a745; border-radius: 50%;"></div>
                                <small>Régime Faible</small>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <div style="width: 16px; height: 16px; background: #ffc107; border-radius: 50%;"></div>
                                <small>Régime Intermédiaire</small>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <div style="width: 16px; height: 16px; background: #dc3545; border-radius: 50%;"></div>
                                <small>Régime Élevé</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Statistiques des Régimes et Matrice de Transition -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-pie-chart me-2"></i>Statistiques des Régimes
                        </h5>
                        <small class="text-muted">Distribution de la volatilité par régime</small>
                    </div>
                    <div class="card-body" id="regimeStatsContainer">
                        <div class="text-center py-4">
                            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-arrow-left-right me-2"></i>Matrice de Transition
                        </h5>
                        <small class="text-muted">Probabilité de passage entre régimes (%)</small>
                    </div>
                    <div class="card-body" id="transitionMatrixContainer">
                        <div class="text-center py-4">
                            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Régime actuel -->
            <div class="col-12">
                <div class="card" id="currentRegimeCard">
                    <div class="card-body py-3">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                            <div class="d-flex align-items-center gap-3">
                                <div id="currentRegimeBadge" class="px-4 py-2 rounded-pill text-white fw-bold" style="background: #6c757d;">
                                    --
                                </div>
                                <div>
                                    <div class="text-muted small">Régime actuel</div>
                                    <div class="fw-bold" id="currentVolatilityValue">Volatilité: --</div>
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="text-muted small">Seuils de classification</div>
                                <div id="thresholdsInfo">Faible ≤ -- | Intermédiaire ≤ -- | Élevé > --</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Rolling Metrics Section -->
            <div class="col-12 mt-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div>
                            <h5 class="card-title mb-0">
                                <i class="bi bi-graph-up-arrow me-2"></i>Métriques Glissantes
                            </h5>
                            <small class="text-muted">Sharpe Ratio et Beta glissants</small>
                        </div>
                        <div class="d-flex align-items-center gap-3 flex-wrap">
                            <div class="d-flex align-items-center gap-2">
                                <label class="text-muted small">Fenêtre :</label>
                                <input type="range" class="form-range" id="rollingMetricsWindow" min="10" max="60" value="20" style="width: 100px;">
                                <span class="badge bg-primary" id="rollingWindowValue">20</span>
                                <small class="text-muted">jours</small>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <!-- Sharpe Ratio Glissant -->
                            <div class="col-md-6">
                                <div class="mb-2 d-flex justify-content-between">
                                    <span class="fw-bold">Sharpe Ratio Glissant</span>
                                    <span class="badge bg-primary" id="currentSharpeValue">--</span>
                                </div>
                                <div style="height: 200px;">
                                    <canvas id="rollingSharpeChart"></canvas>
                                </div>
                            </div>
                            <!-- Beta Glissant -->
                            <div class="col-md-6">
                                <div class="mb-2 d-flex justify-content-between">
                                    <span class="fw-bold">Beta Glissant <small class="text-muted">(vs FCP Actions Performances)</small></span>
                                    <span class="badge bg-secondary" id="currentBetaValue">--</span>
                                </div>
                                <div style="height: 200px;">
                                    <canvas id="rollingBetaChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tail Risk Analysis Section -->
            <div class="col-12 mt-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>Analyse du Tail Risk
                        </h5>
                        <small class="text-muted">Événements extrêmes et fréquence des pertes</small>
                    </div>
                    <div class="card-body" id="tailRiskContainer">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Chargement...</span>
                            </div>
                            <p class="text-muted mt-2">Analyse des événements extrêmes...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Pires et Meilleurs Jours -->
            <div class="col-md-6 mt-4">
                <div class="card h-100">
                    <div class="card-header" style="background: rgba(220, 53, 69, 0.1);">
                        <h5 class="card-title mb-0 text-danger">
                            <i class="bi bi-arrow-down-circle me-2"></i>Top 10 Pires Jours
                        </h5>
                    </div>
                    <div class="card-body" id="worstDaysContainer">
                        <div class="text-center py-4">
                            <div class="spinner-border spinner-border-sm text-danger" role="status"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6 mt-4">
                <div class="card h-100">
                    <div class="card-header" style="background: rgba(40, 167, 69, 0.1);">
                        <h5 class="card-title mb-0 text-success">
                            <i class="bi bi-arrow-up-circle me-2"></i>Top 10 Meilleurs Jours
                        </h5>
                    </div>
                    <div class="card-body" id="bestDaysContainer">
                        <div class="text-center py-4">
                            <div class="spinner-border spinner-border-sm text-success" role="status"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Note -->
            <div class="col-12">
                <div class="alert alert-light border d-flex align-items-center" role="alert">
                    <i class="bi bi-info-circle me-2" style="color: var(--primary-color);"></i>
                    <div>
                        <small>
                            <strong>Clustering de volatilité :</strong> Classification des régimes basée sur les percentiles 33% et 66% de la volatilité glissante.
                            La <strong>matrice de transition</strong> indique la probabilité de passer d'un régime à un autre le jour suivant.
                            <br><strong>Tail Risk :</strong> Analyse des événements extrêmes au-delà de 1, 2 et 3 écarts-types par rapport à la distribution normale attendue.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Calendrier Tab -->
    <div class="tab-pane fade" id="calendar" role="tabpanel">
        <div class="row g-4">
            <!-- Header -->
            <div class="col-12">
                <div class="card">
                    <div class="card-body py-3">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-calendar3 me-2" style="color: var(--primary-color);"></i>
                                Calendrier de Performance - <span id="calendarFcpTitle" style="color: var(--primary-color);">{{ selected_fcp }}</span>
                            </h5>
                            <div class="d-flex align-items-center gap-2">
                                <label class="text-muted small">FCP :</label>
                                <select class="select-custom" id="calendarFcpSelector" style="min-width: 220px;">
                                    {% for fcp_name in fcp_list %}
                                    <option value="{{ fcp_name }}" {% if fcp_name == selected_fcp %}selected{% endif %}>{{ fcp_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Heatmap Mensuelle -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-grid-3x3-gap me-2"></i>Heatmap des Performances Mensuelles
                        </h5>
                        <small class="text-muted">Performance mensuelle par année (style GitHub contributions)</small>
                    </div>
                    <div class="card-body">
                        <div id="monthlyHeatmapContainer" style="overflow-x: auto;">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Chargement...</span>
                                </div>
                                <p class="text-muted mt-2">Génération de la heatmap...</p>
                            </div>
                        </div>
                        <!-- Légende -->
                        <div class="d-flex justify-content-center gap-3 mt-3 flex-wrap">
                            <small class="text-muted">Moins</small>
                            <div style="width: 16px; height: 16px; background: #dc3545; border-radius: 3px;"></div>
                            <div style="width: 16px; height: 16px; background: #ffc107; border-radius: 3px;"></div>
                            <div style="width: 16px; height: 16px; background: #e9ecef; border-radius: 3px;"></div>
                            <div style="width: 16px; height: 16px; background: #90EE90; border-radius: 3px;"></div>
                            <div style="width: 16px; height: 16px; background: #28a745; border-radius: 3px;"></div>
                            <small class="text-muted">Plus</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Performance par Jour de la Semaine -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-calendar-week me-2"></i>Performance par Jour de la Semaine
                        </h5>
                        <small class="text-muted">Statistiques historiques par jour</small>
                    </div>
                    <div class="card-body">
                        <div style="height: 250px;">
                            <canvas id="weekdayChart"></canvas>
                        </div>
                        <div class="table-responsive mt-3" id="weekdayStatsContainer">
                            <div class="text-center py-4">
                                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Saisonnalité Mensuelle -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-snow me-2"></i>Saisonnalité Mensuelle
                        </h5>
                        <small class="text-muted">Performance moyenne historique par mois</small>
                    </div>
                    <div class="card-body">
                        <div style="height: 250px;">
                            <canvas id="seasonalityChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Meilleurs et Pires Mois -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header" style="background: rgba(40, 167, 69, 0.1);">
                        <h5 class="card-title mb-0 text-success">
                            <i class="bi bi-trophy me-2"></i>Meilleurs Mois Historiques
                        </h5>
                    </div>
                    <div class="card-body" id="bestMonthsContainer">
                        <div class="text-center py-4">
                            <div class="spinner-border spinner-border-sm text-success" role="status"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header" style="background: rgba(220, 53, 69, 0.1);">
                        <h5 class="card-title mb-0 text-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>Pires Mois Historiques
                        </h5>
                    </div>
                    <div class="card-body" id="worstMonthsContainer">
                        <div class="text-center py-4">
                            <div class="spinner-border spinner-border-sm text-danger" role="status"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Note -->
            <div class="col-12">
                <div class="alert alert-light border d-flex align-items-center" role="alert">
                    <i class="bi bi-info-circle me-2" style="color: var(--primary-color);"></i>
                    <div>
                        <small>
                            <strong>Heatmap :</strong> Visualisation des performances mensuelles colorées selon l'intensité du rendement.
                            <strong>Saisonnalité :</strong> Moyenne historique des performances pour identifier les tendances saisonnières récurrentes.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Données VL depuis Django (variables modifiables)
    let vlDataRaw = {{ vl_data_json|safe }};
    let allFcpStats = {{ all_fcp_stats_json|safe }};
    let selectedFcp = "{{ selected_fcp }}";
    
    // Données pour l'analyse (variables modifiables)
    let histogramData = {{ histogram_data_json|safe }};
    let underwaterData = {{ underwater_data_json|safe }};
    let drawdownsData = {{ drawdowns_data_json|safe }};
    let rendementsList = {{ rendements_list_json|safe }};
    
    // Fonction pour filtrer les données par période
    function filterDataByPeriod(data, period) {
        if (!data || data.length === 0) return { labels: [], values: [] };
        
        const lastDate = new Date(data[data.length - 1].date);
        let startDate;
        
        switch(period) {
            case '1m': startDate = new Date(lastDate); startDate.setMonth(startDate.getMonth() - 1); break;
            case '3m': startDate = new Date(lastDate); startDate.setMonth(startDate.getMonth() - 3); break;
            case '6m': startDate = new Date(lastDate); startDate.setMonth(startDate.getMonth() - 6); break;
            case '1y': startDate = new Date(lastDate); startDate.setFullYear(lastDate.getFullYear() - 1); break;
            case '5y': startDate = new Date(lastDate); startDate.setFullYear(lastDate.getFullYear() - 5); break;
            default: startDate = new Date(data[0].date);
        }
        
        const filtered = data.filter(d => new Date(d.date) >= startDate);
        return {
            labels: filtered.map(d => d.date),
            values: filtered.map(d => d.valeur)
        };
    }
    
    // Données initiales (1 an par défaut)
    let currentData = filterDataByPeriod(vlDataRaw, '1y');
    
    // VL Evolution Chart
    const vlCtx = document.getElementById('vlEvolutionChart').getContext('2d');
    const vlChart = new Chart(vlCtx, {
        type: 'line',
        data: {
            labels: currentData.labels,
            datasets: [{
                label: selectedFcp,
                data: currentData.values,
                borderColor: '#004080',
                backgroundColor: 'rgba(0, 64, 128, 0.1)',
                borderWidth: 2.5,
                fill: true,
                tension: 0.2,
                pointRadius: 0,
                pointHoverRadius: 6,
                pointHoverBackgroundColor: '#004080',
                pointHoverBorderColor: '#fff',
                pointHoverBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleFont: { size: 13 },
                    bodyFont: { size: 12 },
                    padding: 12,
                    cornerRadius: 8,
                    callbacks: {
                        title: function(context) {
                            const date = new Date(context[0].label);
                            return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'long', year: 'numeric' });
                        },
                        label: function(context) {
                            return context.dataset.label + ': ' + new Intl.NumberFormat('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}).format(context.raw) + ' XOF';
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'category',
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: '#777777',
                        font: { size: 10 },
                        maxTicksLimit: 12,
                        callback: function(value, index) {
                            const date = new Date(this.getLabelForValue(value));
                            return date.toLocaleDateString('fr-FR', { month: 'short', year: '2-digit' });
                        }
                    }
                },
                y: {
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        color: '#777777',
                        font: { size: 11 },
                        callback: function(value) {
                            return new Intl.NumberFormat('fr-FR').format(value);
                        }
                    }
                }
            }
        }
    });
    
    // Risk/Return Scatter Chart avec données réelles et catégorisation par type_fond
    const scatterCtx = document.getElementById('riskReturnChart').getContext('2d');
    
    // Couleurs par type de fond
    const typeColors = {
        'Obligataire': '#004080',
        'Diversifié': '#28a745',
        'Actions': '#dc3545',
        'Monétaire': '#ffc107'
    };
    
    // Fonction pour créer les datasets du scatter chart
    function createScatterDatasets(data) {
        return data.map((fcp) => ({
            label: fcp.nom,
            data: [{ x: fcp.volatilite, y: fcp.rendement, type_fond: fcp.type_fond }],
            backgroundColor: fcp.selected ? typeColors[fcp.type_fond] || '#6c757d' : typeColors[fcp.type_fond] || '#6c757d',
            pointRadius: fcp.selected ? 14 : 8,
            pointHoverRadius: fcp.selected ? 16 : 10,
            borderColor: fcp.selected ? '#fff' : 'rgba(255,255,255,0.5)',
            borderWidth: fcp.selected ? 3 : 1,
            type_fond: fcp.type_fond
        }));
    }
    
    // Initialiser le scatter chart
    let scatterDatasets = createScatterDatasets(allFcpStats);
    
    const scatterChart = new Chart(scatterCtx, {
        type: 'scatter',
        data: {
            datasets: scatterDatasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    cornerRadius: 8,
                    callbacks: {
                        label: function(context) {
                            const typeFond = context.dataset.type_fond || 'N/A';
                            return [
                                context.dataset.label,
                                'Type: ' + typeFond,
                                'Rendement: ' + context.raw.y.toFixed(2) + '%',
                                'Volatilité: ' + context.raw.x.toFixed(2) + '%'
                            ];
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Risque (Volatilité %)',
                        color: '#555555',
                        font: { size: 12, weight: '500' }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        color: '#777777',
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Rendement %',
                        color: '#555555',
                        font: { size: 12, weight: '500' }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        color: '#777777',
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            },
            onClick: function(event, elements) {
                if (elements.length > 0) {
                    const datasetIndex = elements[0].datasetIndex;
                    const fcpData = scatterChart.data.datasets[datasetIndex];
                    updateScatterInfo(fcpData.label, fcpData.data[0].y, fcpData.data[0].x, fcpData.type_fond);
                }
            }
        }
    });
    
    // Fonction pour mettre à jour les infos du scatter
    function updateScatterInfo(nom, rendement, volatilite, typeFond) {
        document.getElementById('scatterSelectedFcp').textContent = nom;
        const rendementEl = document.getElementById('scatterRendement');
        rendementEl.textContent = (rendement >= 0 ? '+' : '') + rendement.toFixed(2) + '%';
        rendementEl.style.color = rendement >= 0 ? 'var(--success-color)' : 'var(--danger-color)';
        document.getElementById('scatterVolatilite').textContent = volatilite.toFixed(2) + '%';
        const ratio = volatilite > 0 ? (rendement / volatilite).toFixed(2) : '--';
        document.getElementById('scatterRatio').textContent = ratio;
        document.getElementById('scatterTypeFond').innerHTML = '<i class="bi bi-tag-fill me-1"></i>' + typeFond;
    }
    
    // Initialiser les infos avec le FCP sélectionné
    const selectedFcpData = allFcpStats.find(f => f.selected);
    if (selectedFcpData) {
        updateScatterInfo(selectedFcpData.nom, selectedFcpData.rendement, selectedFcpData.volatilite, selectedFcpData.type_fond);
    }
    
    // Scatter Period Filter Click Handler
    document.querySelectorAll('#scatterPeriodFilters .filter-pill').forEach(pill => {
        pill.addEventListener('click', function() {
            document.querySelectorAll('#scatterPeriodFilters .filter-pill').forEach(p => p.classList.remove('active'));
            this.classList.add('active');
            
            const period = this.dataset.period;
            
            // Appeler l'API pour récupérer les données filtrées
            fetch('/api/scatter-data/?period=' + period)
                .then(response => response.json())
                .then(result => {
                    // Marquer le FCP sélectionné
                    result.data.forEach(fcp => {
                        fcp.selected = fcp.nom === selectedFcp;
                    });
                    
                    // Mettre à jour le chart
                    scatterChart.data.datasets = createScatterDatasets(result.data);
                    scatterChart.update();
                    
                    // Mettre à jour les infos si le FCP sélectionné est dans les résultats
                    const selectedData = result.data.find(f => f.selected);
                    if (selectedData) {
                        updateScatterInfo(selectedData.nom, selectedData.rendement, selectedData.volatilite, selectedData.type_fond);
                    }
                    
                    // Mettre à jour la note avec la date
                    if (result.last_date) {
                        document.getElementById('scatterDateNote').innerHTML = 
                            '<i class="bi bi-info-circle me-1"></i>Données au <strong>' + result.last_date + '</strong> (dernière date en base)';
                    }
                })
                .catch(error => console.error('Erreur:', error));
        });
    });
    
    // Period Filter Click Handler
    document.querySelectorAll('#periodFilters .filter-pill').forEach(pill => {
        pill.addEventListener('click', function() {
            document.querySelectorAll('#periodFilters .filter-pill').forEach(p => p.classList.remove('active'));
            this.classList.add('active');
            
            const period = this.dataset.period;
            const filteredData = filterDataByPeriod(vlDataRaw, period);
            
            vlChart.data.labels = filteredData.labels;
            vlChart.data.datasets[0].data = filteredData.values;
            vlChart.update();
        });
    });
    
    // ========== FONCTION POUR CHARGER LES DONNÉES FCP VIA AJAX ==========
    function loadFcpData(fcpName) {
        // Afficher un indicateur de chargement
        document.body.style.cursor = 'wait';
        
        fetch(`/api/fcp-full-data/?fcp=${encodeURIComponent(fcpName)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Erreur:', data.error);
                    document.body.style.cursor = 'default';
                    return;
                }
                
                // Mettre à jour les variables globales
                vlDataRaw = data.vl_data;
                selectedFcp = data.fcp_name;
                histogramData = data.analyse_stats?.histogram_data || [];
                underwaterData = data.analyse_stats?.underwater_data || [];
                drawdownsData = data.analyse_stats?.drawdowns_data || [];
                rendementsList = data.analyse_stats?.rendements_list || [];
                
                // Mettre à jour le graphique VL
                const activePeriod = document.querySelector('#periodFilters .filter-pill.active')?.dataset.period || '1y';
                const filteredData = filterDataByPeriod(vlDataRaw, activePeriod);
                vlChart.data.labels = filteredData.labels;
                vlChart.data.datasets[0].data = filteredData.values;
                vlChart.data.datasets[0].label = fcpName;
                vlChart.update();
                
                // Mettre à jour les données de l'historique et recalculer le tableau
                historyData = [...vlDataRaw].reverse();
                historyCurrentPage = 1;
                if (typeof renderHistoryTable === 'function') {
                    renderHistoryTable();
                }
                
                // Mettre à jour les statistiques de la carte
                updateStatsCard(data.stats, data.perf_calendaires, data.perf_glissantes, data.analyse_stats);
                
                // Mettre à jour l'onglet Performance
                console.log('Données reçues:', { perf_calendaires: data.perf_calendaires, perf_glissantes: data.perf_glissantes });
                updatePerformanceTab(data.perf_calendaires, data.perf_glissantes, fcpName, data.stats);
                
                // Mettre à jour les statistiques de l'onglet Historique
                updateHistoryStats(data.stats, data.perf_glissantes);
                
                // Mettre à jour le scatter chart (point sélectionné)
                updateScatterChartSelection(fcpName);
                
                // Mettre à jour tous les sélecteurs FCP
                syncAllFcpSelectors(fcpName);
                
                // Mettre à jour l'onglet Analyse avec les nouvelles statistiques
                updateAnalysisTab(data.analyse_stats, data.tracking_error);
                
                document.body.style.cursor = 'default';
            })
            .catch(error => {
                console.error('Erreur:', error);
                document.body.style.cursor = 'default';
            });
    }
    
    // Fonction pour synchroniser tous les sélecteurs FCP
    function syncAllFcpSelectors(fcpName) {
        const selectors = ['fcpSelector', 'perfFcpSelector', 'analyseFcpSelector', 'historyFcpSelector', 'riskFcpSelector', 'calendarFcpSelector'];
        selectors.forEach(id => {
            const selector = document.getElementById(id);
            if (selector) {
                selector.value = fcpName;
            }
        });
        
        // Mettre à jour tous les titres dynamiques
        const titles = ['analyseFcpTitle', 'historyFcpTitle', 'riskFcpTitle', 'calendarFcpTitle', 'perfFcpTitle'];
        titles.forEach(id => {
            const titleEl = document.getElementById(id);
            if (titleEl) {
                titleEl.textContent = fcpName;
            }
        });
    }
    
    // Fonction pour mettre à jour la carte de statistiques
    function updateStatsCard(stats, perfCal, perfGliss, analyseStats) {
        // Mettre à jour la légende du graphique
        const legendFcpName = document.getElementById('legendFcpName');
        if (legendFcpName) {
            legendFcpName.textContent = selectedFcp;
        }
        
        // Mettre à jour la date dans le label de la dernière VL
        const metricDerniereDate = document.getElementById('metricDerniereDate');
        if (metricDerniereDate && stats.derniere_date) {
            metricDerniereDate.textContent = stats.derniere_date;
        }
        
        // Mettre à jour la dernière VL
        const metricDerniereVL = document.getElementById('metricDerniereVL');
        if (metricDerniereVL && stats.derniere_vl !== undefined) {
            metricDerniereVL.innerHTML = `${parseFloat(stats.derniere_vl).toFixed(2)} <small style="font-size: 14px;">XOF</small>`;
        }
        
        // Mettre à jour la variation 1 jour
        const metricVar1J = document.getElementById('metricVar1J');
        if (metricVar1J && stats.var_1j !== undefined) {
            const var1j = stats.var_1j || 0;
            const sign = var1j >= 0 ? '+' : '';
            const colorClass = var1j >= 0 ? 'positive' : 'negative';
            const arrowDir = var1j >= 0 ? 'up' : 'down';
            metricVar1J.className = colorClass;
            metricVar1J.innerHTML = `<i class="bi bi-arrow-${arrowDir}"></i> ${sign}${var1j}% (1j)`;
        }
        
        // Mettre à jour le rendement YTD
        const metricYTD = document.getElementById('metricYTD');
        if (metricYTD && stats.var_ytd !== undefined) {
            const varYtd = stats.var_ytd || 0;
            const sign = varYtd >= 0 ? '+' : '';
            const colorClass = varYtd >= 0 ? 'text-success' : 'text-danger';
            metricYTD.textContent = `${sign}${varYtd}%`;
            metricYTD.className = `metric-value ${colorClass}`;
        }
        
        // Mettre à jour le rendement annualisé
        const metricRendementAnn = document.getElementById('metricRendementAnn');
        if (metricRendementAnn && analyseStats && analyseStats.rendement_moyen_ann !== undefined) {
            const rendAnn = analyseStats.rendement_moyen_ann || 0;
            const sign = rendAnn >= 0 ? '+' : '';
            const colorClass = rendAnn >= 0 ? 'text-success' : 'text-danger';
            metricRendementAnn.textContent = `${sign}${rendAnn}%`;
            metricRendementAnn.className = `metric-value ${colorClass}`;
        }
        
        // Mettre à jour la volatilité
        const metricVolatilite = document.getElementById('metricVolatilite');
        if (metricVolatilite && stats.volatilite !== undefined) {
            metricVolatilite.textContent = `${stats.volatilite}%`;
        }
        
        // Mettre à jour la carte résumé du scatter chart
        const scatterSelectedFcp = document.getElementById('scatterSelectedFcp');
        if (scatterSelectedFcp) {
            scatterSelectedFcp.textContent = selectedFcp;
        }
        
        const scatterRendement = document.getElementById('scatterRendement');
        if (scatterRendement && stats.var_origine !== undefined) {
            const varOrigine = stats.var_origine || 0;
            const sign = varOrigine >= 0 ? '+' : '';
            scatterRendement.textContent = `${sign}${varOrigine}%`;
            scatterRendement.style.color = varOrigine >= 0 ? 'var(--success-color)' : 'var(--danger-color)';
        }
        
        const scatterVolatilite = document.getElementById('scatterVolatilite');
        if (scatterVolatilite && stats.volatilite !== undefined) {
            scatterVolatilite.textContent = `${stats.volatilite}%`;
        }
        
        // Calculer et mettre à jour le ratio rendement/risque
        const scatterRatio = document.getElementById('scatterRatio');
        if (scatterRatio && stats.var_origine !== undefined && stats.volatilite !== undefined && stats.volatilite > 0) {
            const ratio = (stats.var_origine / stats.volatilite).toFixed(2);
            scatterRatio.textContent = ratio;
        }
        
        // Mettre à jour la date en bas du scatter
        const overviewDerniereDate = document.getElementById('overviewDerniereDate');
        if (overviewDerniereDate && stats.derniere_date) {
            overviewDerniereDate.textContent = stats.derniere_date;
        }
    }
    
    // Fonction pour mettre à jour la sélection dans le scatter chart
    function updateScatterChartSelection(fcpName) {
        if (scatterChart && scatterChart.data && scatterChart.data.datasets) {
            scatterChart.data.datasets.forEach(ds => {
                const isSelected = ds.label === fcpName;
                ds.pointRadius = isSelected ? 14 : 8;
                ds.pointHoverRadius = isSelected ? 16 : 10;
                ds.borderColor = isSelected ? '#fff' : 'rgba(255,255,255,0.5)';
                ds.borderWidth = isSelected ? 3 : 1;
            });
            scatterChart.update();
        }
    }
    
    // Fonction pour mettre à jour l'onglet Analyse
    function updateAnalysisTab(analyseStats, trackingError) {
        // Fonction helper pour formater les valeurs
        const formatValue = (val, suffix = '') => val !== null && val !== undefined ? val + suffix : '--' + suffix;
        const formatColoredValue = (val, suffix = '', inverse = false) => {
            if (val === null || val === undefined) return '--' + suffix;
            const isPositive = inverse ? val < 0 : val >= 0;
            const colorClass = isPositive ? 'text-success' : 'text-danger';
            const sign = val >= 0 ? '+' : '';
            return `<span class="${colorClass}">${sign}${val}${suffix}</span>`;
        };
        
        // Statistiques descriptives
        document.getElementById('analyse-nb-obs').textContent = formatValue(analyseStats.nb_observations);
        document.getElementById('analyse-rdt-moyen').textContent = formatValue(analyseStats.rendement_moyen, '%');
        document.getElementById('analyse-rdt-ann').innerHTML = formatColoredValue(analyseStats.rendement_moyen_ann, '%');
        document.getElementById('analyse-mediane').textContent = formatValue(analyseStats.mediane, '%');
        document.getElementById('analyse-ecart-type').textContent = formatValue(analyseStats.ecart_type, '%');
        document.getElementById('analyse-volatilite').textContent = formatValue(analyseStats.volatilite_ann, '%');
        document.getElementById('analyse-vl-min').textContent = formatValue(analyseStats.vl_min, ' XOF');
        document.getElementById('analyse-vl-max').textContent = formatValue(analyseStats.vl_max, ' XOF');
        document.getElementById('analyse-rdt-min').textContent = formatValue(analyseStats.rdt_min, '%');
        document.getElementById('analyse-rdt-max').textContent = '+' + formatValue(analyseStats.rdt_max, '%');
        
        // Profil de risque
        const maxDD = analyseStats.max_drawdown || 0;
        document.getElementById('analyse-max-drawdown').textContent = '-' + formatValue(maxDD, '%');
        document.getElementById('analyse-drawdown-bar').style.width = Math.min(maxDD, 100) + '%';
        
        // Sharpe et Sortino avec couleurs
        const sharpe = analyseStats.sharpe;
        const sortino = analyseStats.sortino;
        const sharpeEl = document.getElementById('analyse-sharpe');
        const sortinoEl = document.getElementById('analyse-sortino');
        
        const getRatioColor = (val) => {
            if (val === null || val === undefined) return '';
            if (val >= 1) return 'text-success';
            if (val >= 0) return 'text-warning';
            return 'text-danger';
        };
        
        sharpeEl.textContent = formatValue(sharpe);
        sharpeEl.className = 'fs-4 fw-bold ' + getRatioColor(sharpe);
        sortinoEl.textContent = formatValue(sortino);
        sortinoEl.className = 'fs-4 fw-bold ' + getRatioColor(sortino);
        
        // Jours positifs/négatifs
        const joursPos = analyseStats.jours_positifs || 0;
        const joursNeg = analyseStats.jours_negatifs || 0;
        const ratioPos = analyseStats.ratio_positif || 50;
        const nbObs = analyseStats.nb_observations || 1;
        
        document.getElementById('analyse-ratio-positif').textContent = ratioPos + '% positifs';
        document.getElementById('analyse-jours-positifs').textContent = joursPos;
        document.getElementById('analyse-jours-negatifs').textContent = joursNeg;
        document.getElementById('analyse-jours-positifs-bar').style.width = ratioPos + '%';
        document.getElementById('analyse-jours-negatifs-bar').style.width = (100 - ratioPos) + '%';
        
        // Skewness et Kurtosis
        const skew = analyseStats.skewness;
        const kurt = analyseStats.kurtosis;
        const skewEl = document.getElementById('analyse-skewness');
        const kurtEl = document.getElementById('analyse-kurtosis');
        
        skewEl.textContent = formatValue(skew);
        skewEl.className = 'fw-bold fs-5 ' + (skew > 0 ? 'text-success' : skew < 0 ? 'text-danger' : '');
        kurtEl.textContent = formatValue(kurt);
        kurtEl.className = 'fw-bold fs-5 ' + (kurt > 0 ? 'text-warning' : 'text-info');
        
        document.getElementById('analyse-skewness-desc').textContent = 
            skew > 0.5 ? 'Queue droite' : skew < -0.5 ? 'Queue gauche' : '≈ Symétrique';
        document.getElementById('analyse-kurtosis-desc').textContent = 
            kurt > 1 ? 'Queues épaisses' : kurt < -1 ? 'Queues fines' : '≈ Normal';
        
        // VaR et CVaR
        document.getElementById('analyse-var95').textContent = formatValue(analyseStats.var_95, '%');
        document.getElementById('analyse-var99').textContent = formatValue(analyseStats.var_99, '%');
        document.getElementById('analyse-cvar95').textContent = formatValue(analyseStats.cvar_95, '%');
        document.getElementById('analyse-cvar99').textContent = formatValue(analyseStats.cvar_99, '%');
        
        // Tracking Error
        if (trackingError) {
            document.getElementById('tracking-error-wtd').textContent = formatValue(trackingError.wtd, '%');
            document.getElementById('tracking-error-mtd').textContent = formatValue(trackingError.mtd, '%');
            document.getElementById('tracking-error-qtd').textContent = formatValue(trackingError.qtd, '%');
            document.getElementById('tracking-error-std').textContent = formatValue(trackingError.std, '%');
            document.getElementById('tracking-error-ytd').textContent = formatValue(trackingError.ytd, '%');
            document.getElementById('tracking-error-origine').textContent = formatValue(trackingError.origine, '%');
        }
        
        // Re-render les graphiques de l'analyse si les données ont changé
        if (histogramData.length > 0) {
            renderHistogramChart();
        }
        if (underwaterData.length > 0) {
            renderUnderwaterChart();
        }
        if (drawdownsData.length > 0) {
            renderDrawdownsTable();
        }
    }
    
    // Fonction pour mettre à jour l'onglet Performance
    function updatePerformanceTab(perfCal, perfGliss, fcpName, stats) {
        console.log('updatePerformanceTab appelée avec:', { perfCal, perfGliss, fcpName, stats });
        
        // Mettre à jour le titre
        const perfTitle = document.getElementById('perfFcpTitle');
        if (perfTitle) {
            perfTitle.textContent = fcpName;
        }
        
        // Mettre à jour la date
        const dateEl = document.getElementById('perf-derniere-date');
        if (dateEl && stats && stats.derniere_date) {
            dateEl.textContent = stats.derniere_date;
        }
        
        // Fonction helper pour formater une valeur de performance
        const formatPerfValue = (value, isBig = false) => {
            if (value === null || value === undefined) {
                return '<span class="text-muted">N/A</span>';
            }
            const sign = value >= 0 ? '+' : '';
            const colorClass = value >= 0 ? 'text-success' : 'text-danger';
            const sizeStyle = isBig ? ' style="font-size: 1.1em;"' : '';
            return `<span class="fw-bold ${colorClass}"${sizeStyle}>${sign}${value}%</span>`;
        };
        
        // Mettre à jour les performances calendaires
        if (perfCal) {
            const calFields = ['wtd', 'mtd', 'qtd', 'std', 'ytd'];
            calFields.forEach(field => {
                const el = document.getElementById(`perf-${field}`);
                if (el) {
                    const isBig = field === 'ytd';
                    el.innerHTML = formatPerfValue(perfCal[field], isBig);
                }
            });
        }
        
        // Mettre à jour les performances glissantes
        if (perfGliss) {
            const glissFields = ['1m', '3m', '6m', '1y', '3y', '5y'];
            glissFields.forEach(field => {
                const el = document.getElementById(`perf-${field}`);
                if (el) {
                    el.innerHTML = formatPerfValue(perfGliss[`perf_${field}`]);
                }
            });
            
            // Mettre à jour l'origine
            const origineEl = document.getElementById('perf-origine');
            if (origineEl) {
                origineEl.innerHTML = formatPerfValue(perfGliss.origine, true);
            }
        }
    }
    
    // Fonction pour mettre à jour les statistiques de l'onglet Historique
    function updateHistoryStats(stats, perfGliss) {
        // Nb. Observations
        const nbObsEl = document.getElementById('history-nb-obs');
        if (nbObsEl && stats) {
            nbObsEl.textContent = stats.nb_vl || '0';
        }
        
        // Première Date
        const premiereDateEl = document.getElementById('history-premiere-date');
        if (premiereDateEl && stats) {
            premiereDateEl.textContent = stats.premiere_date || '--';
        }
        
        // Dernière Date
        const derniereDateEl = document.getElementById('history-derniere-date');
        if (derniereDateEl && stats) {
            derniereDateEl.textContent = stats.derniere_date || '--';
        }
        
        // Perf. Origine
        const perfOrigineEl = document.getElementById('history-perf-origine');
        if (perfOrigineEl && stats) {
            const varOrigine = stats.var_origine;
            if (varOrigine !== null && varOrigine !== undefined) {
                const sign = varOrigine >= 0 ? '+' : '';
                const colorClass = varOrigine >= 0 ? 'text-success' : 'text-danger';
                perfOrigineEl.innerHTML = `<span class="${colorClass}">${sign}${varOrigine}%</span>`;
            } else {
                perfOrigineEl.innerHTML = '<span class="text-muted">--</span>';
            }
        }
    }
    
    // FCP Selector Change Handler (Vue d'ensemble)
    document.getElementById('fcpSelector').addEventListener('change', function() {
        loadFcpData(this.value);
    });
    
    // Performances FCP Selector
    document.getElementById('perfFcpSelector')?.addEventListener('change', function() {
        loadFcpData(this.value);
    });
    
    // Analyse FCP Selector
    document.getElementById('analyseFcpSelector')?.addEventListener('change', function() {
        loadFcpData(this.value);
    });
    
    // Benchmark Toggle
    document.getElementById('showBenchmark').addEventListener('change', function() {
        if (this.checked) {
            document.getElementById('benchmarkLegend').style.display = 'flex';
        } else {
            document.getElementById('benchmarkLegend').style.display = 'none';
        }
    });
    
    // Cumulative Toggle
    document.getElementById('showCumulative').addEventListener('change', function() {
        const currentValues = vlChart.data.datasets[0].data;
        
        if (this.checked && currentValues.length > 0) {
            // Convert to cumulative returns (%)
            const baseValue = currentValues[0];
            vlChart.data.datasets[0].data = currentValues.map(v => 
                ((v - baseValue) / baseValue * 100)
            );
            
            vlChart.options.scales.y.ticks.callback = function(value) {
                return value.toFixed(2) + '%';
            };
        } else {
            // Restore original data
            const period = document.querySelector('#periodFilters .filter-pill.active').dataset.period;
            const filteredData = filterDataByPeriod(vlDataRaw, period);
            vlChart.data.datasets[0].data = filteredData.values;
            
            vlChart.options.scales.y.ticks.callback = function(value) {
                return new Intl.NumberFormat('fr-FR').format(value);
            };
        }
        vlChart.update();
    });
    
    // Toggle options active state
    document.querySelectorAll('.toggle-option').forEach(toggle => {
        const checkbox = toggle.querySelector('input[type="checkbox"]');
        checkbox.addEventListener('change', function() {
            toggle.classList.toggle('active', this.checked);
        });
    });
    
    // ====================================
    // HISTORIQUE TAB FUNCTIONALITY
    // ====================================
    
    // Pagination state
    let historyCurrentPage = 1;
    const historyPageSize = 50;
    let historyData = [...vlDataRaw].reverse(); // Most recent first
    
    // Calculate daily and cumulative variations
    function calculateVariations(data) {
        if (!data || data.length === 0) return [];
        
        // Original data is sorted oldest to newest, we reversed it
        // So we need to calculate from the perspective of reversed data
        const originalData = [...data].reverse(); // Back to oldest first for calculations
        const firstValue = originalData[0].valeur;
        
        return data.map((item, index) => {
            const originalIndex = originalData.length - 1 - index;
            const prevIndex = originalIndex - 1;
            
            let var1j = 0;
            if (prevIndex >= 0) {
                const prevValue = originalData[prevIndex].valeur;
                var1j = ((item.valeur - prevValue) / prevValue) * 100;
            }
            
            const varCumul = ((item.valeur - firstValue) / firstValue) * 100;
            
            return {
                ...item,
                var1j: var1j,
                varCumul: varCumul
            };
        });
    }
    
    // Render history table
    function renderHistoryTable() {
        const tableBody = document.getElementById('historyTableBody');
        if (!tableBody) return;
        
        const dataWithVariations = calculateVariations(historyData);
        const startIndex = (historyCurrentPage - 1) * historyPageSize;
        const endIndex = Math.min(startIndex + historyPageSize, dataWithVariations.length);
        const pageData = dataWithVariations.slice(startIndex, endIndex);
        
        tableBody.innerHTML = '';
        
        if (pageData.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center py-5 text-muted">
                        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                        Aucune donnée disponible
                    </td>
                </tr>
            `;
            return;
        }
        
        pageData.forEach((item, index) => {
            const date = new Date(item.date);
            const formattedDate = date.toLocaleDateString('fr-FR', { 
                day: '2-digit', 
                month: 'short', 
                year: 'numeric' 
            });
            
            const var1jClass = item.var1j >= 0 ? 'text-success' : 'text-danger';
            const var1jIcon = item.var1j >= 0 ? 'bi-arrow-up' : 'bi-arrow-down';
            const var1jSign = item.var1j >= 0 ? '+' : '';
            
            const varCumulClass = item.varCumul >= 0 ? 'text-success' : 'text-danger';
            const varCumulSign = item.varCumul >= 0 ? '+' : '';
            
            tableBody.innerHTML += `
                <tr>
                    <td class="px-4 py-3">
                        <span class="fw-medium">${formattedDate}</span>
                    </td>
                    <td class="px-4 py-3 text-end">
                        <span class="fw-bold" style="color: var(--primary-color);">
                            ${new Intl.NumberFormat('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}).format(item.valeur)}
                        </span>
                        <span class="text-muted ms-1">XOF</span>
                    </td>
                    <td class="px-4 py-3 text-end">
                        <span class="${var1jClass}">
                            <i class="bi ${var1jIcon} me-1"></i>${var1jSign}${item.var1j.toFixed(2)}%
                        </span>
                    </td>
                    <td class="px-4 py-3 text-end">
                        <span class="${varCumulClass} fw-medium">
                            ${varCumulSign}${item.varCumul.toFixed(2)}%
                        </span>
                    </td>
                </tr>
            `;
        });
        
        // Update pagination info
        document.getElementById('showingFrom').textContent = startIndex + 1;
        document.getElementById('showingTo').textContent = endIndex;
        document.getElementById('totalRows').textContent = dataWithVariations.length;
        
        // Update pagination buttons
        document.getElementById('prevPageBtn').disabled = historyCurrentPage === 1;
        document.getElementById('nextPageBtn').disabled = endIndex >= dataWithVariations.length;
    }
    
    // Pagination handlers
    document.getElementById('prevPageBtn')?.addEventListener('click', function() {
        if (historyCurrentPage > 1) {
            historyCurrentPage--;
            renderHistoryTable();
        }
    });
    
    document.getElementById('nextPageBtn')?.addEventListener('click', function() {
        const maxPage = Math.ceil(historyData.length / historyPageSize);
        if (historyCurrentPage < maxPage) {
            historyCurrentPage++;
            renderHistoryTable();
        }
    });
    
    // History FCP Selector - utilise AJAX aussi
    document.getElementById('historyFcpSelector')?.addEventListener('change', function() {
        loadFcpData(this.value);
        // Réinitialiser la pagination
        historyCurrentPage = 1;
    });
    
    // Export CSV
    document.getElementById('exportCsvBtn')?.addEventListener('click', function() {
        const dataWithVariations = calculateVariations(historyData);
        
        let csv = 'Date;Valeur Liquidative;Variation 1J (%);Variation Cumul (%)\n';
        dataWithVariations.forEach(item => {
            const date = new Date(item.date).toLocaleDateString('fr-FR');
            csv += `${date};${item.valeur.toFixed(2)};${item.var1j.toFixed(2)};${item.varCumul.toFixed(2)}\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `VL_${selectedFcp.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0, 10)}.csv`;
        link.click();
    });
    
    // Initial render when tab is shown
    document.querySelector('button[data-bs-target="#history"]')?.addEventListener('shown.bs.tab', function() {
        renderHistoryTable();
    });
    
    // Also render if history tab is already visible (e.g., direct navigation)
    if (document.getElementById('history')?.classList.contains('show')) {
        renderHistoryTable();
    }
    
    // ====================================
    // GRAPHIQUES D'ANALYSE - Distribution et Drawdowns
    // ====================================
    
    let histogramChart = null;
    let underwaterChart = null;
    
    // Histogramme des rendements
    function renderHistogramChart() {
        const ctx = document.getElementById('histogramChart');
        if (!ctx || !histogramData || histogramData.length === 0) return;
        
        if (histogramChart) {
            histogramChart.destroy();
        }
        
        const labels = histogramData.map(d => d.bin_start.toFixed(2) + '%');
        const counts = histogramData.map(d => d.count);
        
        // Calculer les couleurs (rouge pour négatifs, vert pour positifs)
        const colors = histogramData.map(d => {
            if (d.bin_end <= 0) return 'rgba(220, 53, 69, 0.7)';
            if (d.bin_start >= 0) return 'rgba(40, 167, 69, 0.7)';
            return 'rgba(108, 117, 125, 0.7)';
        });
        
        histogramChart = new Chart(ctx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Fréquence',
                    data: counts,
                    backgroundColor: colors,
                    borderColor: colors.map(c => c.replace('0.7', '1')),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                const idx = context[0].dataIndex;
                                return `${histogramData[idx].bin_start.toFixed(2)}% à ${histogramData[idx].bin_end.toFixed(2)}%`;
                            },
                            label: function(context) {
                                const idx = context.dataIndex;
                                return [`${context.raw} jours (${histogramData[idx].frequency}%)`];
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        grid: { display: false },
                        ticks: {
                            maxTicksLimit: 10,
                            font: { size: 9 }
                        },
                        title: {
                            display: true,
                            text: 'Rendement quotidien (%)',
                            font: { size: 10 }
                        }
                    },
                    y: {
                        display: true,
                        grid: { color: 'rgba(0,0,0,0.05)' },
                        title: {
                            display: true,
                            text: 'Nombre de jours',
                            font: { size: 10 }
                        }
                    }
                }
            }
        });
    }
    
    // Underwater Chart
    function renderUnderwaterChart() {
        const ctx = document.getElementById('underwaterChart');
        if (!ctx || !underwaterData || underwaterData.length === 0) return;
        
        if (underwaterChart) {
            underwaterChart.destroy();
        }
        
        underwaterChart = new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: {
                labels: underwaterData.map(d => d.date),
                datasets: [{
                    label: 'Drawdown',
                    data: underwaterData.map(d => d.drawdown),
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.3)',
                    borderWidth: 1.5,
                    fill: true,
                    tension: 0.1,
                    pointRadius: 0,
                    pointHoverRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                const date = new Date(context[0].label);
                                return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'long', year: 'numeric' });
                            },
                            label: function(context) {
                                return `Drawdown: ${context.raw.toFixed(2)}%`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'category',
                        grid: { display: false },
                        ticks: {
                            maxTicksLimit: 12,
                            callback: function(value) {
                                const date = new Date(this.getLabelForValue(value));
                                return date.toLocaleDateString('fr-FR', { month: 'short', year: '2-digit' });
                            }
                        }
                    },
                    y: {
                        grid: { color: 'rgba(0,0,0,0.05)' },
                        max: 0,
                        ticks: {
                            callback: function(value) {
                                return value.toFixed(0) + '%';
                            }
                        },
                        title: {
                            display: true,
                            text: 'Drawdown (%)',
                            font: { size: 11 }
                        }
                    }
                }
            }
        });
    }
    
    // Table des drawdowns
    function renderDrawdownsTable(threshold = 2) {
        const tbody = document.getElementById('drawdownsTableBody');
        if (!tbody || !drawdownsData) return;
        
        // Filtrer par seuil
        const filtered = drawdownsData.filter(d => d.depth >= threshold).slice(0, 5);
        
        if (filtered.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4 text-muted">
                        Aucun drawdown supérieur à ${threshold}%
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = '';
        filtered.forEach((dd, index) => {
            const startDate = new Date(dd.start_date).toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' });
            const troughDate = new Date(dd.trough_date).toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' });
            const endDate = dd.end_date ? new Date(dd.end_date).toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' }) : '<span class="badge bg-warning">En cours</span>';
            const recovery = dd.recovery !== null ? dd.recovery : '<span class="text-muted">--</span>';
            
            // Couleur selon la profondeur
            let depthClass = 'text-warning';
            if (dd.depth >= 10) depthClass = 'text-danger fw-bold';
            else if (dd.depth >= 5) depthClass = 'text-danger';
            
            tbody.innerHTML += `
                <tr>
                    <td class="px-4 py-3 fw-bold">${index + 1}</td>
                    <td class="px-4 py-3">${startDate}</td>
                    <td class="px-4 py-3">${troughDate}</td>
                    <td class="px-4 py-3">${endDate}</td>
                    <td class="px-4 py-3 text-end ${depthClass}">-${dd.depth}%</td>
                    <td class="px-4 py-3 text-center">${dd.duration}</td>
                    <td class="px-4 py-3 text-center">${recovery}</td>
                </tr>
            `;
        });
    }
    
    // Event listener pour le filtre de seuil
    document.getElementById('drawdownThreshold')?.addEventListener('change', function() {
        renderDrawdownsTable(parseFloat(this.value));
    });
    
    // Charger les graphiques quand l'onglet Analyse est affiché
    document.querySelector('button[data-bs-target="#analysis"]')?.addEventListener('shown.bs.tab', function() {
        setTimeout(() => {
            renderHistogramChart();
            renderUnderwaterChart();
            renderDrawdownsTable(parseFloat(document.getElementById('drawdownThreshold')?.value || 2));
        }, 100);
    });
    
    // Si l'onglet est déjà visible
    if (document.getElementById('analysis')?.classList.contains('show')) {
        setTimeout(() => {
            renderHistogramChart();
            renderUnderwaterChart();
            renderDrawdownsTable(2);
        }, 100);
    }
    
    // ====================================
    // MATRICE DE CORRELATION
    // ====================================
    
    function loadCorrelationMatrix(period = 'origin') {
        const container = document.getElementById('correlationTableContainer');
        container.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Chargement...</span>
                </div>
                <p class="text-muted mt-2">Calcul de la matrice de corrélation...</p>
            </div>
        `;
        
        fetch('/api/correlation-matrix/?period=' + period)
            .then(response => response.json())
            .then(data => {
                if (data.fcp_names && data.fcp_names.length > 0 && data.matrix.length > 0) {
                    document.getElementById('correlationObsCount').textContent = data.nb_observations;
                    renderCorrelationTable(data.fcp_names, data.matrix);
                } else {
                    container.innerHTML = `
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-exclamation-circle fs-1 d-block mb-2"></i>
                            <p>Données insuffisantes pour calculer la matrice de corrélation sur cette période.</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                container.innerHTML = `
                    <div class="text-center py-4 text-danger">
                        <i class="bi bi-x-circle fs-1 d-block mb-2"></i>
                        <p>Erreur lors du chargement de la matrice de corrélation.</p>
                    </div>
                `;
            });
    }
    
    function renderCorrelationTable(fcpNames, matrix) {
        const container = document.getElementById('correlationTableContainer');
        
        // Créer des noms courts pour les FCP
        const shortNames = fcpNames.map(name => {
            // Extraire les mots clés du nom
            const words = name.replace('FCP ', '').split(' ');
            if (words.length > 2) {
                return words.slice(0, 2).map(w => w.substring(0, 4)).join(' ');
            }
            return words.map(w => w.substring(0, 6)).join(' ');
        });
        
        let html = '<table class="table table-sm table-bordered mb-0" style="font-size: 11px;">';
        
        // En-tête
        html += '<thead><tr><th style="background: var(--bg-secondary);"></th>';
        shortNames.forEach((name, i) => {
            html += `<th class="text-center" style="background: var(--bg-secondary); writing-mode: vertical-rl; transform: rotate(180deg); height: 100px; white-space: nowrap;" title="${fcpNames[i]}">${name}</th>`;
        });
        html += '</tr></thead>';
        
        // Corps
        html += '<tbody>';
        matrix.forEach((row, i) => {
            html += `<tr><td class="fw-bold text-nowrap" style="background: var(--bg-secondary);" title="${fcpNames[i]}">${shortNames[i]}</td>`;
            row.forEach((corr, j) => {
                let bgColor, textColor;
                if (i === j) {
                    bgColor = '#004080';
                    textColor = 'white';
                } else if (corr >= 0.7) {
                    bgColor = `rgba(40, 167, 69, ${0.3 + corr * 0.7})`;
                    textColor = corr > 0.85 ? 'white' : 'black';
                } else if (corr >= 0.3) {
                    bgColor = `rgba(255, 193, 7, ${0.3 + corr * 0.5})`;
                    textColor = 'black';
                } else if (corr >= 0) {
                    bgColor = `rgba(200, 200, 200, ${0.2 + corr})`;
                    textColor = 'black';
                } else {
                    bgColor = `rgba(220, 53, 69, ${0.3 + Math.abs(corr) * 0.7})`;
                    textColor = Math.abs(corr) > 0.5 ? 'white' : 'black';
                }
                html += `<td class="text-center" style="background: ${bgColor}; color: ${textColor};">${corr.toFixed(2)}</td>`;
            });
            html += '</tr>';
        });
        html += '</tbody></table>';
        
        container.innerHTML = html;
    }
    
    // Correlation Period Filter Click Handler
    document.querySelectorAll('#correlationPeriodFilters .filter-pill').forEach(pill => {
        pill.addEventListener('click', function() {
            document.querySelectorAll('#correlationPeriodFilters .filter-pill').forEach(p => p.classList.remove('active'));
            this.classList.add('active');
            loadCorrelationMatrix(this.dataset.period);
        });
    });
    
    // Charger la matrice quand l'onglet Analyse est affiché
    document.querySelector('button[data-bs-target="#analysis"]')?.addEventListener('shown.bs.tab', function() {
        const activePeriod = document.querySelector('#correlationPeriodFilters .filter-pill.active')?.dataset.period || 'origin';
        loadCorrelationMatrix(activePeriod);
    });
    
    // ====================================
    // ONGLET RISQUE - CLUSTERING VOLATILITE
    // ====================================
    
    let volatilityChart = null;
    
    function loadVolatilityClustering(fcpName, window) {
        // Afficher les loaders
        document.getElementById('volatilityChartContainer').innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Chargement...</span>
                </div>
                <p class="text-muted mt-2">Calcul du clustering de volatilité...</p>
            </div>
        `;
        document.getElementById('regimeStatsContainer').innerHTML = '<div class="text-center py-4"><div class="spinner-border spinner-border-sm text-primary" role="status"></div></div>';
        document.getElementById('transitionMatrixContainer').innerHTML = '<div class="text-center py-4"><div class="spinner-border spinner-border-sm text-primary" role="status"></div></div>';
        
        fetch(`/api/volatility-clustering/?fcp=${encodeURIComponent(fcpName)}&window=${window}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('volatilityChartContainer').innerHTML = `
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-exclamation-circle fs-1 d-block mb-2"></i>
                            <p>${data.error}</p>
                        </div>
                    `;
                    return;
                }
                
                renderVolatilityChart(data.chart_data);
                renderRegimeStats(data.regime_stats);
                renderTransitionMatrix(data.transition_matrix);
                updateCurrentRegime(data.current_regime, data.current_volatility, data.thresholds);
            })
            .catch(error => {
                console.error('Erreur:', error);
                document.getElementById('volatilityChartContainer').innerHTML = `
                    <div class="text-center py-4 text-danger">
                        <i class="bi bi-x-circle fs-1 d-block mb-2"></i>
                        <p>Erreur lors du chargement des données.</p>
                    </div>
                `;
            });
    }
    
    function renderVolatilityChart(chartData) {
        const container = document.getElementById('volatilityChartContainer');
        container.innerHTML = '<canvas id="volatilityChart"></canvas>';
        
        const ctx = document.getElementById('volatilityChart').getContext('2d');
        
        const regimeColors = {
            0: '#28a745',  // Faible - Vert
            1: '#ffc107',  // Intermédiaire - Jaune
            2: '#dc3545'   // Élevé - Rouge
        };
        
        // Créer les données avec couleurs par segment
        const labels = chartData.map(d => d.date);
        const values = chartData.map(d => d.volatility);
        const colors = chartData.map(d => regimeColors[d.regime]);
        
        if (volatilityChart) {
            volatilityChart.destroy();
        }
        
        volatilityChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Volatilité glissante (%)',
                    data: values,
                    borderColor: '#004080',
                    backgroundColor: 'rgba(0, 64, 128, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.1,
                    pointRadius: 0,
                    pointHoverRadius: 5,
                    segment: {
                        borderColor: ctx => {
                            const idx = ctx.p0DataIndex;
                            return regimeColors[chartData[idx]?.regime] || '#004080';
                        },
                        backgroundColor: ctx => {
                            const idx = ctx.p0DataIndex;
                            const color = regimeColors[chartData[idx]?.regime] || '#004080';
                            return color.replace(')', ', 0.1)').replace('rgb', 'rgba');
                        }
                    }
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                const date = new Date(context[0].label);
                                return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'long', year: 'numeric' });
                            },
                            label: function(context) {
                                const regime = chartData[context.dataIndex]?.regime;
                                const regimeNames = {0: 'Faible', 1: 'Intermédiaire', 2: 'Élevé'};
                                return [
                                    'Volatilité: ' + context.raw.toFixed(2) + '%',
                                    'Régime: ' + regimeNames[regime]
                                ];
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: {
                            maxTicksLimit: 12,
                            callback: function(value) {
                                const date = new Date(this.getLabelForValue(value));
                                return date.toLocaleDateString('fr-FR', { month: 'short', year: '2-digit' });
                            }
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Volatilité annualisée (%)'
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    }
                }
            }
        });
    }
    
    function renderRegimeStats(regimeStats) {
        const container = document.getElementById('regimeStatsContainer');
        
        let html = '';
        const regimeOrder = [0, 1, 2];
        
        regimeOrder.forEach(regime => {
            const stats = regimeStats[regime];
            const percentage = stats.count > 0 ? ((stats.count / Object.values(regimeStats).reduce((a, b) => a + b.count, 0)) * 100).toFixed(1) : 0;
            
            html += `
                <div class="mb-3 p-3 rounded" style="background: ${stats.color}15; border-left: 4px solid ${stats.color};">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-bold" style="color: ${stats.color};">
                            <i class="bi bi-circle-fill me-2" style="font-size: 10px;"></i>${stats.nom}
                        </span>
                        <span class="badge" style="background: ${stats.color};">${stats.count} jours (${percentage}%)</span>
                    </div>
                    <div class="row text-center small">
                        <div class="col-4">
                            <div class="text-muted">Min</div>
                            <div class="fw-bold">${stats.min}%</div>
                        </div>
                        <div class="col-4">
                            <div class="text-muted">Moyenne</div>
                            <div class="fw-bold">${stats.mean}%</div>
                        </div>
                        <div class="col-4">
                            <div class="text-muted">Max</div>
                            <div class="fw-bold">${stats.max}%</div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    function renderTransitionMatrix(matrix) {
        const container = document.getElementById('transitionMatrixContainer');
        const regimeNames = ['Faible', 'Intermédiaire', 'Élevé'];
        const regimeColors = ['#28a745', '#ffc107', '#dc3545'];
        
        let html = '<table class="table table-sm table-bordered mb-0">';
        html += '<thead><tr><th style="background: var(--bg-secondary);">De \\ Vers</th>';
        regimeNames.forEach((name, i) => {
            html += `<th class="text-center" style="background: ${regimeColors[i]}20;">${name}</th>`;
        });
        html += '</tr></thead><tbody>';
        
        matrix.forEach((row, i) => {
            html += `<tr><td class="fw-bold" style="background: ${regimeColors[i]}20;">${regimeNames[i]}</td>`;
            row.forEach((prob, j) => {
                const intensity = prob / 100;
                const bgColor = i === j ? `rgba(0, 64, 128, ${0.2 + intensity * 0.6})` : `rgba(128, 128, 128, ${intensity * 0.5})`;
                html += `<td class="text-center" style="background: ${bgColor};">${prob}%</td>`;
            });
            html += '</tr>';
        });
        
        html += '</tbody></table>';
        html += `
            <div class="text-center mt-3">
                <small class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    Probabilité de transition d'un jour à l'autre
                </small>
            </div>
        `;
        
        container.innerHTML = html;
    }
    
    function updateCurrentRegime(regime, volatility, thresholds) {
        const regimeNames = {0: 'FAIBLE', 1: 'INTERMÉDIAIRE', 2: 'ÉLEVÉ'};
        const regimeColors = {0: '#28a745', 1: '#ffc107', 2: '#dc3545'};
        
        const badge = document.getElementById('currentRegimeBadge');
        badge.textContent = regimeNames[regime];
        badge.style.background = regimeColors[regime];
        
        document.getElementById('currentVolatilityValue').textContent = `Volatilité actuelle: ${volatility}%`;
        document.getElementById('thresholdsInfo').innerHTML = 
            `<span style="color: #28a745;">Faible ≤ ${thresholds.low}%</span> | 
             <span style="color: #ffc107;">Intermédiaire ≤ ${thresholds.high}%</span> | 
             <span style="color: #dc3545;">Élevé > ${thresholds.high}%</span>`;
    }
    
    // Risk FCP Selector
    document.getElementById('riskFcpSelector')?.addEventListener('change', function() {
        const selectedFcp = this.value;
        // Mettre à jour le titre dynamiquement
        document.getElementById('riskFcpTitle').textContent = selectedFcp;
        const window = document.getElementById('volatilityWindow').value;
        loadVolatilityClustering(selectedFcp, window);
        loadRollingMetrics(selectedFcp, document.getElementById('rollingMetricsWindow').value);
        loadTailRisk(selectedFcp);
    });
    
    // Volatility Window Slider
    document.getElementById('volatilityWindow')?.addEventListener('input', function() {
        document.getElementById('windowValue').textContent = this.value;
    });
    
    document.getElementById('volatilityWindow')?.addEventListener('change', function() {
        const fcpName = document.getElementById('riskFcpSelector').value;
        loadVolatilityClustering(fcpName, this.value);
    });
    
    // Rolling Metrics Window Slider
    document.getElementById('rollingMetricsWindow')?.addEventListener('input', function() {
        document.getElementById('rollingWindowValue').textContent = this.value;
    });
    
    document.getElementById('rollingMetricsWindow')?.addEventListener('change', function() {
        const fcpName = document.getElementById('riskFcpSelector').value;
        loadRollingMetrics(fcpName, this.value);
    });
    
    // Charger les données quand l'onglet Risque est affiché
    document.querySelector('button[data-bs-target="#risk"]')?.addEventListener('shown.bs.tab', function() {
        const fcpName = document.getElementById('riskFcpSelector').value;
        const window = document.getElementById('volatilityWindow').value;
        loadVolatilityClustering(fcpName, window);
        loadRollingMetrics(fcpName, document.getElementById('rollingMetricsWindow').value);
        loadTailRisk(fcpName);
    });
    
    // Charger les données quand l'onglet Calendrier est affiché
    document.querySelector('button[data-bs-target="#calendar"]')?.addEventListener('shown.bs.tab', function() {
        const fcpName = document.getElementById('calendarFcpSelector').value;
        loadCalendarData(fcpName);
    });
    
    // Calendar FCP Selector
    document.getElementById('calendarFcpSelector')?.addEventListener('change', function() {
        // Mettre à jour le titre dynamiquement
        document.getElementById('calendarFcpTitle').textContent = this.value;
        loadCalendarData(this.value);
    });
    
    // ========== ROLLING METRICS FUNCTIONS ==========
    let rollingSharpeChart = null;
    let rollingBetaChart = null;
    
    function loadRollingMetrics(fcpName, window) {
        fetch(`/api/rolling-metrics/?fcp=${encodeURIComponent(fcpName)}&window=${window}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Erreur rolling metrics:', data.error);
                    return;
                }
                
                renderRollingSharpeChart(data.dates, data.sharpe);
                renderRollingBetaChart(data.dates, data.beta);
                
                // Mettre à jour les valeurs actuelles
                document.getElementById('currentSharpeValue').textContent = 
                    data.current_sharpe !== null ? data.current_sharpe.toFixed(2) : '--';
                document.getElementById('currentBetaValue').textContent = 
                    data.current_beta !== null ? data.current_beta.toFixed(2) : '--';
            })
            .catch(error => console.error('Erreur:', error));
    }
    
    function renderRollingSharpeChart(dates, sharpeValues) {
        const ctx = document.getElementById('rollingSharpeChart');
        if (!ctx) return;
        
        if (rollingSharpeChart) {
            rollingSharpeChart.destroy();
        }
        
        rollingSharpeChart = new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: 'Sharpe Ratio',
                    data: sharpeValues,
                    borderColor: '#004080',
                    backgroundColor: 'rgba(0, 64, 128, 0.1)',
                    borderWidth: 1.5,
                    fill: true,
                    tension: 0.3,
                    pointRadius: 0,
                    pointHoverRadius: 4
                }, {
                    label: 'Seuil 0',
                    data: dates.map(() => 0),
                    borderColor: 'rgba(220, 53, 69, 0.5)',
                    borderWidth: 1,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                const date = new Date(context[0].label);
                                return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' });
                            },
                            label: function(context) {
                                if (context.datasetIndex === 0) {
                                    return 'Sharpe: ' + context.raw.toFixed(2);
                                }
                                return null;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        grid: { display: false },
                        ticks: {
                            maxTicksLimit: 6,
                            callback: function(value) {
                                const date = new Date(this.getLabelForValue(value));
                                return date.toLocaleDateString('fr-FR', { month: 'short', year: '2-digit' });
                            }
                        }
                    },
                    y: {
                        grid: { color: 'rgba(0, 0, 0, 0.05)' }
                    }
                }
            }
        });
    }
    
    function renderRollingBetaChart(dates, betaValues) {
        const ctx = document.getElementById('rollingBetaChart');
        if (!ctx) return;
        
        if (rollingBetaChart) {
            rollingBetaChart.destroy();
        }
        
        // Filtrer les valeurs null
        const filteredData = dates.map((d, i) => ({
            date: d,
            beta: betaValues[i]
        })).filter(d => d.beta !== null);
        
        if (filteredData.length === 0) {
            ctx.parentElement.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-info-circle me-2"></i>Données de benchmark insuffisantes</div>';
            return;
        }
        
        rollingBetaChart = new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: {
                labels: filteredData.map(d => d.date),
                datasets: [{
                    label: 'Beta',
                    data: filteredData.map(d => d.beta),
                    borderColor: '#6c757d',
                    backgroundColor: 'rgba(108, 117, 125, 0.1)',
                    borderWidth: 1.5,
                    fill: true,
                    tension: 0.3,
                    pointRadius: 0,
                    pointHoverRadius: 4
                }, {
                    label: 'Beta = 1',
                    data: filteredData.map(() => 1),
                    borderColor: 'rgba(0, 64, 128, 0.5)',
                    borderWidth: 1,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                const date = new Date(context[0].label);
                                return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' });
                            },
                            label: function(context) {
                                if (context.datasetIndex === 0) {
                                    return 'Beta: ' + context.raw.toFixed(2);
                                }
                                return null;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        grid: { display: false },
                        ticks: {
                            maxTicksLimit: 6,
                            callback: function(value) {
                                const date = new Date(this.getLabelForValue(value));
                                return date.toLocaleDateString('fr-FR', { month: 'short', year: '2-digit' });
                            }
                        }
                    },
                    y: {
                        grid: { color: 'rgba(0, 0, 0, 0.05)' }
                    }
                }
            }
        });
    }
    
    // ========== TAIL RISK FUNCTIONS ==========
    function loadTailRisk(fcpName) {
        fetch(`/api/tail-risk/?fcp=${encodeURIComponent(fcpName)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Erreur tail risk:', data.error);
                    return;
                }
                
                renderTailRiskAnalysis(data);
                renderWorstDays(data.worst_days);
                renderBestDays(data.best_days);
            })
            .catch(error => console.error('Erreur:', error));
    }
    
    function renderTailRiskAnalysis(data) {
        const container = document.getElementById('tailRiskContainer');
        const tail = data.tail_analysis;
        const stats = data.statistics;
        
        let html = `
            <div class="row g-4">
                <div class="col-12">
                    <div class="p-3 rounded" style="background: var(--bg-secondary);">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="text-muted small">Moyenne quotidienne</div>
                                <div class="fw-bold">${(stats.mean).toFixed(4)}%</div>
                            </div>
                            <div class="col-4">
                                <div class="text-muted small">Écart-type (σ)</div>
                                <div class="fw-bold">${stats.std.toFixed(4)}%</div>
                            </div>
                            <div class="col-4">
                                <div class="text-muted small">Jours analysés</div>
                                <div class="fw-bold">${data.total_days}</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 1 Sigma -->
                <div class="col-md-4">
                    <div class="p-3 rounded h-100" style="background: rgba(255, 193, 7, 0.1); border-left: 4px solid #ffc107;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-bold" style="color: #856404;">
                                <i class="bi bi-exclamation-circle me-2"></i>Pertes > 1σ
                            </span>
                            <span class="badge bg-warning text-dark">${tail['1_sigma'].count}</span>
                        </div>
                        <div class="small">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted">Seuil :</span>
                                <span class="fw-bold">${stats.sigma_1_threshold.toFixed(3)}%</span>
                            </div>
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted">Fréquence réelle :</span>
                                <span class="fw-bold">${tail['1_sigma'].frequency}%</span>
                            </div>
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted">Fréquence attendue :</span>
                                <span class="fw-bold">${tail['1_sigma'].expected}%</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">Ratio :</span>
                                <span class="fw-bold ${tail['1_sigma'].ratio > 1.2 ? 'text-danger' : tail['1_sigma'].ratio < 0.8 ? 'text-success' : ''}">${tail['1_sigma'].ratio}x</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 2 Sigma -->
                <div class="col-md-4">
                    <div class="p-3 rounded h-100" style="background: rgba(255, 127, 80, 0.1); border-left: 4px solid #ff7f50;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-bold" style="color: #d35400;">
                                <i class="bi bi-exclamation-triangle me-2"></i>Pertes > 2σ
                            </span>
                            <span class="badge" style="background: #ff7f50;">${tail['2_sigma'].count}</span>
                        </div>
                        <div class="small">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted">Seuil :</span>
                                <span class="fw-bold">${stats.sigma_2_threshold.toFixed(3)}%</span>
                            </div>
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted">Fréquence réelle :</span>
                                <span class="fw-bold">${tail['2_sigma'].frequency}%</span>
                            </div>
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted">Fréquence attendue :</span>
                                <span class="fw-bold">${tail['2_sigma'].expected}%</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">Ratio :</span>
                                <span class="fw-bold ${tail['2_sigma'].ratio > 1.5 ? 'text-danger' : tail['2_sigma'].ratio < 0.7 ? 'text-success' : ''}">${tail['2_sigma'].ratio}x</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 3 Sigma -->
                <div class="col-md-4">
                    <div class="p-3 rounded h-100" style="background: rgba(220, 53, 69, 0.1); border-left: 4px solid #dc3545;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-bold text-danger">
                                <i class="bi bi-lightning me-2"></i>Pertes > 3σ (Black Swan)
                            </span>
                            <span class="badge bg-danger">${tail['3_sigma'].count}</span>
                        </div>
                        <div class="small">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted">Seuil :</span>
                                <span class="fw-bold">${stats.sigma_3_threshold.toFixed(3)}%</span>
                            </div>
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted">Fréquence réelle :</span>
                                <span class="fw-bold">${tail['3_sigma'].frequency}%</span>
                            </div>
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted">Fréquence attendue :</span>
                                <span class="fw-bold">${tail['3_sigma'].expected}%</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">Ratio :</span>
                                <span class="fw-bold ${tail['3_sigma'].ratio > 2 ? 'text-danger' : ''}">${tail['3_sigma'].ratio}x</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        container.innerHTML = html;
    }
    
    function renderWorstDays(worstDays) {
        const container = document.getElementById('worstDaysContainer');
        
        let html = '<div class="list-group list-group-flush">';
        worstDays.forEach((day, index) => {
            const date = new Date(day.date);
            const formattedDate = date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' });
            html += `
                <div class="list-group-item d-flex justify-content-between align-items-center px-0 py-2">
                    <div>
                        <span class="badge bg-danger me-2">${index + 1}</span>
                        <span class="small">${formattedDate}</span>
                    </div>
                    <span class="fw-bold text-danger">${day.return.toFixed(2)}%</span>
                </div>
            `;
        });
        html += '</div>';
        
        container.innerHTML = html;
    }
    
    function renderBestDays(bestDays) {
        const container = document.getElementById('bestDaysContainer');
        
        let html = '<div class="list-group list-group-flush">';
        bestDays.forEach((day, index) => {
            const date = new Date(day.date);
            const formattedDate = date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' });
            html += `
                <div class="list-group-item d-flex justify-content-between align-items-center px-0 py-2">
                    <div>
                        <span class="badge bg-success me-2">${index + 1}</span>
                        <span class="small">${formattedDate}</span>
                    </div>
                    <span class="fw-bold text-success">+${day.return.toFixed(2)}%</span>
                </div>
            `;
        });
        html += '</div>';
        
        container.innerHTML = html;
    }
    
    // ========== CALENDAR FUNCTIONS ==========
    let weekdayChart = null;
    let seasonalityChart = null;
    
    function loadCalendarData(fcpName) {
        fetch(`/api/calendar-data/?fcp=${encodeURIComponent(fcpName)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Erreur calendar data:', data.error);
                    return;
                }
                
                renderMonthlyHeatmap(data.monthly_heatmap);
                renderWeekdayChart(data.weekday_analysis);
                renderWeekdayStats(data.weekday_analysis);
                renderSeasonalityChart(data.seasonality);
                renderBestMonths(data.best_months);
                renderWorstMonths(data.worst_months);
            })
            .catch(error => console.error('Erreur:', error));
    }
    
    function renderMonthlyHeatmap(heatmapData) {
        const container = document.getElementById('monthlyHeatmapContainer');
        
        if (!heatmapData || heatmapData.length === 0) {
            container.innerHTML = '<div class="text-center text-muted py-4">Données insuffisantes</div>';
            return;
        }
        
        // Grouper par année
        const years = [...new Set(heatmapData.map(d => d.year))].sort();
        const monthNames = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Jun', 'Jul', 'Aoû', 'Sep', 'Oct', 'Nov', 'Déc'];
        
        // Trouver min/max pour l'échelle de couleurs
        const returns = heatmapData.map(d => d.return);
        const maxReturn = Math.max(...returns);
        const minReturn = Math.min(...returns);
        
        function getColor(value) {
            if (value > 3) return '#28a745';  // Vert foncé
            if (value > 1) return '#90EE90';  // Vert clair
            if (value > -1) return '#e9ecef'; // Gris
            if (value > -3) return '#ffc107'; // Jaune/Orange
            return '#dc3545';                  // Rouge
        }
        
        let html = '<table class="table table-sm table-bordered mb-0" style="font-size: 12px;">';
        html += '<thead><tr><th style="background: var(--bg-secondary);">Année</th>';
        monthNames.forEach(month => {
            html += `<th class="text-center" style="background: var(--bg-secondary); width: 60px;">${month}</th>`;
        });
        html += '<th class="text-center" style="background: var(--bg-secondary);">Total</th></tr></thead><tbody>';
        
        years.forEach(year => {
            html += `<tr><td class="fw-bold" style="background: var(--bg-secondary);">${year}</td>`;
            let yearTotal = 0;
            let yearCount = 0;
            
            for (let month = 1; month <= 12; month++) {
                const item = heatmapData.find(d => d.year === year && d.month === month);
                if (item) {
                    const color = getColor(item.return);
                    yearTotal += item.return;
                    yearCount++;
                    html += `<td class="text-center" style="background: ${color}; color: ${Math.abs(item.return) > 2 ? 'white' : 'inherit'};" title="${monthNames[month-1]} ${year}: ${item.return.toFixed(2)}%">${item.return.toFixed(1)}%</td>`;
                } else {
                    html += '<td class="text-center text-muted">-</td>';
                }
            }
            
            // Total annuel (somme des rendements mensuels)
            const yearTotalColor = yearTotal > 0 ? '#28a745' : '#dc3545';
            html += `<td class="text-center fw-bold" style="background: ${yearTotalColor}20; color: ${yearTotalColor};">${yearTotal.toFixed(1)}%</td>`;
            html += '</tr>';
        });
        
        html += '</tbody></table>';
        
        container.innerHTML = html;
    }
    
    function renderWeekdayChart(weekdayData) {
        const ctx = document.getElementById('weekdayChart');
        if (!ctx) return;
        
        if (weekdayChart) {
            weekdayChart.destroy();
        }
        
        const colors = weekdayData.map(d => d.mean >= 0 ? '#28a745' : '#dc3545');
        
        weekdayChart = new Chart(ctx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: weekdayData.map(d => d.day),
                datasets: [{
                    label: 'Performance moyenne',
                    data: weekdayData.map(d => d.mean),
                    backgroundColor: colors.map(c => c + '80'),
                    borderColor: colors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const d = weekdayData[context.dataIndex];
                                return [
                                    `Moyenne: ${d.mean.toFixed(4)}%`,
                                    `Win rate: ${d.win_rate}%`,
                                    `Observations: ${d.count}`
                                ];
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        grid: { color: 'rgba(0, 0, 0, 0.05)' },
                        ticks: {
                            callback: function(value) {
                                return value.toFixed(3) + '%';
                            }
                        }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });
    }
    
    function renderWeekdayStats(weekdayData) {
        const container = document.getElementById('weekdayStatsContainer');
        
        let html = '<table class="table table-sm table-bordered mb-0" style="font-size: 11px;">';
        html += `<thead><tr>
            <th>Jour</th>
            <th class="text-center">Win Rate</th>
            <th class="text-center">Meilleur</th>
            <th class="text-center">Pire</th>
        </tr></thead><tbody>`;
        
        weekdayData.forEach(d => {
            const winRateColor = d.win_rate >= 50 ? '#28a745' : '#dc3545';
            html += `<tr>
                <td class="fw-bold">${d.day}</td>
                <td class="text-center" style="color: ${winRateColor};">${d.win_rate}%</td>
                <td class="text-center text-success">+${d.best.toFixed(2)}%</td>
                <td class="text-center text-danger">${d.worst.toFixed(2)}%</td>
            </tr>`;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
    }
    
    function renderSeasonalityChart(seasonalityData) {
        const ctx = document.getElementById('seasonalityChart');
        if (!ctx) return;
        
        if (seasonalityChart) {
            seasonalityChart.destroy();
        }
        
        const colors = seasonalityData.map(d => d.mean >= 0 ? '#28a745' : '#dc3545');
        
        seasonalityChart = new Chart(ctx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: seasonalityData.map(d => d.month.substring(0, 3)),
                datasets: [{
                    label: 'Performance moyenne',
                    data: seasonalityData.map(d => d.mean),
                    backgroundColor: colors.map(c => c + '80'),
                    borderColor: colors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                return seasonalityData[context[0].dataIndex].month;
                            },
                            label: function(context) {
                                const d = seasonalityData[context.dataIndex];
                                return [
                                    `Moyenne: ${d.mean.toFixed(2)}%`,
                                    `Win rate: ${d.win_rate}%`,
                                    `Années: ${d.count}`,
                                    `Best: +${d.best.toFixed(2)}%`,
                                    `Worst: ${d.worst.toFixed(2)}%`
                                ];
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        grid: { color: 'rgba(0, 0, 0, 0.05)' },
                        ticks: {
                            callback: function(value) {
                                return value.toFixed(1) + '%';
                            }
                        }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });
    }
    
    function renderBestMonths(bestMonths) {
        const container = document.getElementById('bestMonthsContainer');
        
        let html = '<div class="list-group list-group-flush">';
        bestMonths.forEach((month, index) => {
            html += `
                <div class="list-group-item d-flex justify-content-between align-items-center px-0 py-2">
                    <div>
                        <span class="badge bg-success me-2">${index + 1}</span>
                        <span class="fw-bold">${month.month}</span>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold text-success">+${month.mean.toFixed(2)}%</div>
                        <small class="text-muted">Win rate: ${month.win_rate}%</small>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        
        container.innerHTML = html;
    }
    
    function renderWorstMonths(worstMonths) {
        const container = document.getElementById('worstMonthsContainer');
        
        let html = '<div class="list-group list-group-flush">';
        worstMonths.forEach((month, index) => {
            html += `
                <div class="list-group-item d-flex justify-content-between align-items-center px-0 py-2">
                    <div>
                        <span class="badge bg-danger me-2">${index + 1}</span>
                        <span class="fw-bold">${month.month}</span>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold text-danger">${month.mean.toFixed(2)}%</div>
                        <small class="text-muted">Win rate: ${month.win_rate}%</small>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        
        container.innerHTML = html;
    }
});
</script>
{% endblock %}
