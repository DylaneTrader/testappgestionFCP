{% extends 'fcp_app/base.html' %}

{% block title %}Valeurs liquidatives - Gestion FCP{% endblock %}

{% block content %}
<div class="vl-page-container">
    <!-- Sidebar avec menu et filtres int√©gr√©s -->
    <aside class="vl-sidebar">
        <!-- Navigation des sections -->
        <div class="sidebar-section">
            <h4 class="sidebar-section-title">üìë Navigation</h4>
            <nav class="section-nav">
                <ul>
                    <li>
                        <a href="#section-1" class="nav-link active" data-section="section-1">
                            üìä Section 1 : Vue d'ensemble
                        </a>
                        <ul class="sub-nav">
                            <li><a href="#classification" class="sub-nav-link">Classification des FCP</a></li>
                            <li><a href="#positionnement" class="sub-nav-link">Positionnement Perf/Vol</a></li>
                            <li><a href="#perf-vol-table" class="sub-nav-link">Tableau Perf/Vol</a></li>
                            <li><a href="#rendement-annualise" class="sub-nav-link">Rendement Annualis√©</a></li>
                        </ul>
                    </li>
                    <li>
                        <a href="#section-2" class="nav-link" data-section="section-2">
                            üìà Section 2 : R√©capitulatif
                        </a>
                        <ul class="sub-nav">
                            <li><a href="#perf-calendaires" class="sub-nav-link">Perf. Calendaires</a></li>
                            <li><a href="#perf-glissantes" class="sub-nav-link">Perf. Glissantes</a></li>
                            <li><a href="#evolution-vl" class="sub-nav-link">√âvolution VL</a></li>
                        </ul>
                    </li>
                    <li>
                        <a href="#section-3" class="nav-link" data-section="section-3">
                            üìê Section 3 : Statistiques
                        </a>
                        <ul class="sub-nav">
                            <li><a href="#boxplot-rendements" class="sub-nav-link">Box Plot Rendements</a></li>
                            <li><a href="#stats-descriptives" class="sub-nav-link">Stats Descriptives</a></li>
                            <li><a href="#heatmap-correlation" class="sub-nav-link">Corr√©lations</a></li>
                        </ul>
                    </li>
                </ul>
            </nav>
        </div>

        <!-- Filtres compacts -->
        <div class="sidebar-section">
            <div class="filters-header-compact">
                <h4 class="sidebar-section-title">üîç Filtres</h4>
                <button id="reinitialiser-filtres" class="btn-reset-small" title="R√©initialiser">‚Üª</button>
            </div>
            
            <!-- P√©riode d'analyse -->
            <div class="filter-group-compact">
                <label class="filter-label-small">üìÖ P√©riode</label>
                <select id="periode-analyse" class="filter-select-small">
                    <option value="origine" selected>Origine</option>
                    <option value="ytd">YTD</option>
                    <option value="std">STD</option>
                    <option value="qtd">QTD</option>
                    <option value="mtd">MTD</option>
                    <option value="wtd">WTD</option>
                    <option value="personnalise">Personnalis√©</option>
                </select>
                <div id="dates-personnalisees" class="custom-dates-compact" style="display: none;">
                    <input type="date" id="date-debut" class="filter-input-small" placeholder="D√©but">
                    <input type="date" id="date-fin" class="filter-input-small" placeholder="Fin">
                </div>
            </div>

            <!-- FCP Selection -->
            <div class="filter-group-compact">
                <div class="filter-header-inline">
                    <label class="filter-label-small">üìã FCP</label>
                    <div class="btn-group-small">
                        <button id="select-all-fcps" class="btn-tiny">Tous</button>
                        <button id="deselect-all-fcps" class="btn-tiny">Aucun</button>
                    </div>
                </div>
                <div class="fcp-selection-compact">
                    {% for fcp in fcps %}
                    <label class="checkbox-compact">
                        <input type="checkbox" value="{{ fcp.id }}" data-nom="{{ fcp.nom }}" class="filter-checkbox fcp-checkbox" checked>
                        <span>{{ fcp.nom|truncatechars:25 }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>

            <!-- Type de fond -->
            <div class="filter-group-compact">
                <label class="filter-label-small">üìä Type de fond</label>
                <div class="filter-pills">
                    <label class="pill-checkbox">
                        <input type="checkbox" value="Actions" class="filter-checkbox type-fond-checkbox">
                        <span>Actions</span>
                    </label>
                    <label class="pill-checkbox">
                        <input type="checkbox" value="Capital-Risque" class="filter-checkbox type-fond-checkbox">
                        <span>Capital</span>
                    </label>
                    <label class="pill-checkbox">
                        <input type="checkbox" value="Diversifi√©" class="filter-checkbox type-fond-checkbox">
                        <span>Divers.</span>
                    </label>
                    <label class="pill-checkbox">
                        <input type="checkbox" value="Mon√©taire" class="filter-checkbox type-fond-checkbox">
                        <span>Monet.</span>
                    </label>
                    <label class="pill-checkbox">
                        <input type="checkbox" value="Obligataire" class="filter-checkbox type-fond-checkbox">
                        <span>Oblig.</span>
                    </label>
                </div>
            </div>

            <!-- Profil de risque -->
            <div class="filter-group-compact">
                <label class="filter-label-small">‚ö†Ô∏è Profil</label>
                <div class="filter-pills">
                    <label class="pill-checkbox">
                        <input type="checkbox" value="Prudent" class="filter-checkbox profil-risque-checkbox">
                        <span>Prudent</span>
                    </label>
                    <label class="pill-checkbox">
                        <input type="checkbox" value="√âquilibr√©" class="filter-checkbox profil-risque-checkbox">
                        <span>√âquilibr√©</span>
                    </label>
                    <label class="pill-checkbox">
                        <input type="checkbox" value="Dynamique" class="filter-checkbox profil-risque-checkbox">
                        <span>Dynamique</span>
                    </label>
                </div>
            </div>
        </div>
    </aside>

    <!-- Contenu principal -->
    <main class="vl-main-content">
        <!-- Indicateur de chargement -->
        <div id="loading-indicator" class="loading-overlay" style="display: none;">
            <div class="loading-spinner"></div>
            <span>Chargement des donn√©es...</span>
        </div>
        
        <div class="content-header-compact">
            <h1>Valeurs liquidatives</h1>
            <span id="period-display" class="period-badge">Origine</span>
        </div>
        
        <!-- Navigation des onglets -->
        <div class="tabs-container">
            <div class="tabs-header">
                <button class="tab-btn active" data-tab="tab-section-1">
                    <span class="tab-icon">üìä</span>
                    <span class="tab-label">Vue d'ensemble</span>
                </button>
                <button class="tab-btn" data-tab="tab-section-2">
                    <span class="tab-icon">üìà</span>
                    <span class="tab-label">R√©capitulatif</span>
                </button>
                <button class="tab-btn" data-tab="tab-section-3">
                    <span class="tab-icon">üìê</span>
                    <span class="tab-label">Statistiques</span>
                </button>
            </div>
        </div>
        
        <!-- Section 1 : Vue d'ensemble comparative -->
        <section class="section tab-content active" id="tab-section-1" data-section="section-1">
            <h2 class="section-title">üìä Section 1 : Vue d'ensemble comparative</h2>
            
            <!-- Classification des FCP -->
            <div class="subsection collapsible" id="classification">
                <div class="subsection-header" onclick="toggleSection(this)">
                    <h3 class="subsection-title">üìã Classification des FCP</h3>
                    <span class="collapse-icon">‚ñº</span>
                </div>
                <div class="subsection-content">
                    <div class="table-container">
                        <table class="data-table" id="classification-table">
                            <thead>
                                <tr>
                                    <th>FCP</th>
                                    <th>Type</th>
                                    <th>Risque</th>
                                    <th>Profil</th>
                                    <th>Bench. Oblig.</th>
                                    <th>Bench. Act.</th>
                                    <th>Horizon</th>
                                </tr>
                            </thead>
                            <tbody id="classification-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Positionnement Performance vs Volatilit√© -->
            <div class="subsection collapsible" id="positionnement">
                <div class="subsection-header" onclick="toggleSection(this)">
                    <h3 class="subsection-title">üìà Positionnement Performance vs Volatilit√©</h3>
                    <span class="collapse-icon">‚ñº</span>
                </div>
                <div class="subsection-content">
                    <div class="chart-container">
                        <canvas id="performance-volatility-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Tableau Performance/Volatilit√© -->
            <div class="subsection collapsible" id="perf-vol-table">
                <div class="subsection-header" onclick="toggleSection(this)">
                    <h3 class="subsection-title">üìä Tableau Performance / Volatilit√©</h3>
                    <span class="collapse-icon">‚ñº</span>
                </div>
                <div class="subsection-content">
                    <div class="table-container">
                        <table class="data-table" id="performance-table">
                            <thead>
                                <tr>
                                    <th>FCP</th>
                                    <th>Performance (%)</th>
                                    <th>Volatilit√© (%)</th>
                                </tr>
                            </thead>
                            <tbody id="performance-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Rendement Annualis√© -->
            <div class="subsection collapsible" id="rendement-annualise">
                <div class="subsection-header" onclick="toggleSection(this)">
                    <h3 class="subsection-title">üìÖ Rendement Annualis√©</h3>
                    <span class="collapse-icon">‚ñº</span>
                </div>
                <div class="subsection-content">
                    <div class="chart-container" id="rendement-chart-container">
                        <canvas id="rendement-annualise-chart"></canvas>
                    </div>
                    <div class="table-container" style="margin-top: 20px;">
                        <table class="data-table" id="rendement-annualise-table">
                            <thead>
                                <tr>
                                    <th>FCP</th>
                                    <th>Rendement Annualis√© (%)</th>
                                    <th>Nb Jours</th>
                                </tr>
                            </thead>
                            <tbody id="rendement-annualise-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 2 : R√©capitulatif des performances -->
        <section class="section tab-content" id="tab-section-2" data-section="section-2">
            <h2 class="section-title">üìà Section 2 : R√©capitulatif des performances</h2>
            
            <!-- Performances Calendaires -->
            <div class="subsection collapsible" id="perf-calendaires">
                <div class="subsection-header" onclick="toggleSection(this)">
                    <h3 class="subsection-title">üìÜ Performances Calendaires</h3>
                    <span class="collapse-icon">‚ñº</span>
                </div>
                <div class="subsection-content">
                    <div class="table-container">
                        <table class="data-table performance-heatmap" id="perf-calendaires-table">
                            <thead>
                                <tr>
                                    <th>FCP</th>
                                    <th>WTD</th>
                                    <th>MTD</th>
                                    <th>QTD</th>
                                    <th>STD</th>
                                    <th>YTD</th>
                                </tr>
                            </thead>
                            <tbody id="perf-calendaires-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Performances Glissantes -->
            <div class="subsection collapsible" id="perf-glissantes">
                <div class="subsection-header" onclick="toggleSection(this)">
                    <h3 class="subsection-title">üìä Performances Glissantes</h3>
                    <span class="collapse-icon">‚ñº</span>
                </div>
                <div class="subsection-content">
                    <div class="table-container">
                        <table class="data-table performance-heatmap" id="perf-glissantes-table">
                            <thead>
                                <tr>
                                    <th>FCP</th>
                                    <th>1M</th>
                                    <th>3M</th>
                                    <th>6M</th>
                                    <th>1Y</th>
                                    <th>5Y</th>
                                    <th>Origine</th>
                                </tr>
                            </thead>
                            <tbody id="perf-glissantes-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- √âvolution Valeur Liquidative -->
            <div class="subsection collapsible" id="evolution-vl">
                <div class="subsection-header" onclick="toggleSection(this)">
                    <h3 class="subsection-title">üìâ √âvolution Valeur Liquidative</h3>
                    <span class="collapse-icon">‚ñº</span>
                </div>
                <div class="subsection-content">
                    <!-- Filtres du graphique -->
                    <div class="evolution-filters">
                        <div class="evolution-filter-group">
                            <label class="evolution-filter-label">üìã FCP √† afficher</label>
                            <select id="evolution-fcp-select" class="evolution-select">
                                <option value="">-- S√©lectionner un FCP --</option>
                                {% for fcp in fcps_avec_vl %}
                                <option value="{{ fcp.id }}">{{ fcp.nom }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="evolution-filter-group">
                            <label class="evolution-filter-label">üìÖ P√©riode d'affichage</label>
                            <div class="evolution-period-pills">
                                <label class="period-pill">
                                    <input type="radio" name="evolution-periode" value="1m">
                                    <span>1M</span>
                                </label>
                                <label class="period-pill">
                                    <input type="radio" name="evolution-periode" value="3m">
                                    <span>3M</span>
                                </label>
                                <label class="period-pill">
                                    <input type="radio" name="evolution-periode" value="6m">
                                    <span>6M</span>
                                </label>
                                <label class="period-pill">
                                    <input type="radio" name="evolution-periode" value="1y">
                                    <span>1Y</span>
                                </label>
                                <label class="period-pill">
                                    <input type="radio" name="evolution-periode" value="tout" checked>
                                    <span>Tout</span>
                                </label>
                            </div>
                        </div>
                        <div class="evolution-filter-group">
                            <label class="checkbox-inline">
                                <input type="checkbox" id="show-benchmark" checked>
                                <span>Afficher le benchmark composite</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Graphique -->
                    <div class="chart-container" id="evolution-chart-container">
                        <div id="evolution-placeholder" class="chart-placeholder">
                            <span>üìä</span>
                            <p>S√©lectionnez un FCP pour afficher son √©volution</p>
                        </div>
                        <canvas id="evolution-vl-chart" style="display: none;"></canvas>
                    </div>
                    
                    <!-- Infos benchmark -->
                    <div id="benchmark-info" class="benchmark-info" style="display: none;">
                        <span class="benchmark-tag">üìä Composition benchmark :</span>
                        <span id="benchmark-composition"></span>
                    </div>
                    
                    <!-- Carte derni√®re VL -->
                    <div id="derniere-vl-card" class="derniere-vl-card" style="display: none;">
                        <div class="vl-card-header">
                            <span class="vl-card-icon">üìà</span>
                            <span class="vl-card-title">Derni√®re Valeur Liquidative</span>
                        </div>
                        <div class="vl-card-content">
                            <div class="vl-card-row">
                                <span class="vl-card-label">Date</span>
                                <span class="vl-card-value" id="derniere-vl-date">-</span>
                            </div>
                            <div class="vl-card-row">
                                <span class="vl-card-label">Valeur</span>
                                <span class="vl-card-value vl-value-main" id="derniere-vl-valeur">-</span>
                            </div>
                            <div class="vl-card-row">
                                <span class="vl-card-label">Performance p√©riode</span>
                                <span class="vl-card-value" id="derniere-vl-perf">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 3 : Statistiques descriptives -->
        <section class="section tab-content" id="tab-section-3" data-section="section-3">
            <h2 class="section-title">üìê Section 3 : Statistiques descriptives</h2>

            <!-- Box Plot des rendements journaliers -->
            <div class="subsection collapsible" id="boxplot-rendements">
                <div class="subsection-header" onclick="toggleSection(this)">
                    <h3 class="subsection-title">üì¶ Box Plot des Rendements Journaliers</h3>
                    <span class="collapse-icon">‚ñº</span>
                </div>
                <div class="subsection-content">
                    <div class="chart-container" id="boxplot-container" style="min-height: 400px;">
                        <canvas id="boxplot-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Tableau statistiques descriptives -->
            <div class="subsection collapsible" id="stats-descriptives">
                <div class="subsection-header" onclick="toggleSection(this)">
                    <h3 class="subsection-title">üìä Tableau Statistiques Descriptives</h3>
                    <span class="collapse-icon">‚ñº</span>
                </div>
                <div class="subsection-content">
                    <div class="table-container">
                        <table class="data-table" id="stats-table">
                            <thead>
                                <tr>
                                    <th>FCP</th>
                                    <th>Rdt Moyen (%)</th>
                                    <th>M√©diane (%)</th>
                                    <th>Volatilit√© (%)</th>
                                    <th>Min (%)</th>
                                    <th>Max (%)</th>
                                    <th>Skewness</th>
                                    <th>Kurtosis</th>
                                </tr>
                            </thead>
                            <tbody id="stats-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Heatmap de corr√©lation -->
            <div class="subsection collapsible" id="heatmap-correlation">
                <div class="subsection-header" onclick="toggleSection(this)">
                    <h3 class="subsection-title">üî• Matrice de Corr√©lation</h3>
                    <span class="collapse-icon">‚ñº</span>
                </div>
                <div class="subsection-content">
                    <div class="heatmap-container" id="correlation-heatmap-container">
                        <div id="correlation-heatmap"></div>
                    </div>
                    <div class="heatmap-legend">
                        <span class="legend-label">-1</span>
                        <div class="legend-gradient"></div>
                        <span class="legend-label">+1</span>
                    </div>
                </div>
            </div>
        </section>
    </main>
</div>

<style>
    /* Layout principal */
    .vl-page-container {
        display: flex;
        gap: 15px;
        min-height: calc(100vh - 40px);
    }

    /* Sidebar compacte */
    .vl-sidebar {
        width: 240px;
        min-width: 240px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 15px;
        height: fit-content;
        position: sticky;
        top: 20px;
        max-height: calc(100vh - 40px);
        overflow-y: auto;
    }

    .sidebar-section {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #E0DEDD;
    }

    .sidebar-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }

    .sidebar-section-title {
        font-size: 0.85em;
        color: #333333;
        margin: 0 0 10px 0;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Navigation des sections */
    .section-nav ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .section-nav > ul > li {
        margin-bottom: 8px;
    }

    .nav-link {
        display: block;
        padding: 8px 10px;
        color: #333333;
        text-decoration: none;
        border-radius: 5px;
        font-size: 0.85em;
        font-weight: 600;
        transition: all 0.2s;
    }

    .nav-link:hover, .nav-link.active {
        background: #004080;
        color: white;
    }

    .sub-nav {
        list-style: none;
        padding: 5px 0 5px 15px;
        margin: 0;
    }

    .sub-nav-link {
        display: block;
        padding: 5px 10px;
        color: #333333;
        text-decoration: none;
        font-size: 0.8em;
        border-left: 2px solid #E0DEDD;
        transition: all 0.2s;
    }

    .sub-nav-link:hover {
        color: #004080;
        border-left-color: #004080;
    }

    /* Filtres compacts */
    .filters-header-compact {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .btn-reset-small {
        background: #e74c3c;
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        font-size: 0.9em;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-reset-small:hover {
        transform: rotate(180deg);
    }

    .filter-group-compact {
        margin-bottom: 12px;
    }

    .filter-header-inline {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
    }

    .filter-label-small {
        font-size: 0.8em;
        font-weight: 600;
        color: #333333;
        display: block;
        margin-bottom: 5px;
    }

    .filter-select-small {
        width: 100%;
        padding: 6px 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.85em;
        background: white;
    }

    .filter-input-small {
        width: 100%;
        padding: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.8em;
        margin-top: 5px;
    }

    .custom-dates-compact {
        margin-top: 8px;
    }

    .btn-group-small {
        display: flex;
        gap: 5px;
    }

    .btn-tiny {
        background: none;
        border: 1px solid #004080;
        color: #004080;
        padding: 2px 6px;
        font-size: 0.7em;
        border-radius: 3px;
        cursor: pointer;
    }

    .btn-tiny:hover {
        background: #004080;
        color: white;
    }

    .fcp-selection-compact {
        max-height: 150px;
        overflow-y: auto;
        border: 1px solid #E0DEDD;
        border-radius: 4px;
        padding: 5px;
        background: #f8f8f8;
    }

    .checkbox-compact {
        display: flex;
        align-items: center;
        padding: 3px 5px;
        font-size: 0.75em;
        cursor: pointer;
        border-radius: 3px;
    }

    .checkbox-compact:hover {
        background: #E0DEDD;
    }

    .checkbox-compact input {
        margin-right: 6px;
        width: 12px;
        height: 12px;
    }

    .filter-pills {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
    }

    .pill-checkbox {
        cursor: pointer;
    }

    .pill-checkbox input {
        display: none;
    }

    .pill-checkbox span {
        display: inline-block;
        padding: 3px 8px;
        font-size: 0.7em;
        background: #E0DEDD;
        border-radius: 12px;
        transition: all 0.2s;
    }

    .pill-checkbox input:checked + span {
        background: #004080;
        color: white;
    }

    .pill-checkbox:hover span {
        background: #c5c3c2;
    }

    /* Contenu principal */
    .vl-main-content {
        flex: 1;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 20px;
        min-width: 0;
    }

    .content-header-compact {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #E0DEDD;
    }

    .content-header-compact h1 {
        margin: 0;
        font-size: 1.5em;
        color: #004080;
        border: none;
        padding: 0;
    }

    .period-badge {
        background: #E0DEDD;
        color: #004080;
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 0.8em;
        font-weight: 500;
    }

    /* Sections */
    .section {
        margin-bottom: 30px;
    }

    .section-title {
        color: #004080;
        font-size: 1.2em;
        margin-bottom: 20px;
        padding-bottom: 8px;
        border-bottom: 3px solid #004080;
    }

    /* Subsections pliables */
    .subsection.collapsible {
        margin-bottom: 15px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
    }

    .subsection-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        background: #004080;
        cursor: pointer;
    }

    .subsection-header:hover {
        background: #003366;
    }

    .subsection-header .subsection-title {
        margin: 0;
        color: white;
        font-size: 0.95em;
    }

    .collapse-icon {
        color: white;
        font-size: 0.9em;
        transition: transform 0.3s;
    }

    .subsection.collapsed .collapse-icon {
        transform: rotate(-90deg);
    }

    .subsection-content {
        padding: 15px;
        transition: max-height 0.3s ease-out, padding 0.3s ease-out;
        overflow: hidden;
    }

    .subsection.collapsed .subsection-content {
        max-height: 0;
        padding: 0 15px;
    }

    /* Tables */
    .table-container {
        overflow-x: auto;
        border-radius: 5px;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        font-size: 0.85em;
    }

    .data-table thead {
        background: #004080;
        color: white;
    }

    .data-table th {
        padding: 10px 12px;
        text-align: left;
        font-weight: 600;
        font-size: 0.9em;
        white-space: nowrap;
    }

    .data-table td {
        padding: 8px 12px;
        border-bottom: 1px solid #E0DEDD;
    }

    .data-table tbody tr:hover {
        background-color: #f8f9fa;
    }

    /* Couleurs pour valeurs positives/n√©gatives */
    .positive, .text-success {
        color: #27ae60;
        font-weight: 600;
    }

    .negative, .text-danger {
        color: #e74c3c;
        font-weight: 600;
    }

    /* Heatmap pour tableaux de performance */
    .performance-heatmap td.perf-cell {
        text-align: center;
        font-weight: 600;
        transition: all 0.2s;
    }

    /* Nuances de vert pour positif */
    .perf-positive-1 { background-color: rgba(39, 174, 96, 0.1); color: #27ae60; }
    .perf-positive-2 { background-color: rgba(39, 174, 96, 0.25); color: #27ae60; }
    .perf-positive-3 { background-color: rgba(39, 174, 96, 0.4); color: #1e8449; }
    .perf-positive-4 { background-color: rgba(39, 174, 96, 0.55); color: #145a32; }
    .perf-positive-5 { background-color: rgba(39, 174, 96, 0.7); color: white; }

    /* Nuances de rouge pour n√©gatif */
    .perf-negative-1 { background-color: rgba(231, 76, 60, 0.1); color: #e74c3c; }
    .perf-negative-2 { background-color: rgba(231, 76, 60, 0.25); color: #e74c3c; }
    .perf-negative-3 { background-color: rgba(231, 76, 60, 0.4); color: #c0392b; }
    .perf-negative-4 { background-color: rgba(231, 76, 60, 0.55); color: #922b21; }
    .perf-negative-5 { background-color: rgba(231, 76, 60, 0.7); color: white; }

    .perf-neutral { background-color: #f5f5f5; color: #333333; }
    .perf-na { background-color: #E0DEDD; color: #999999; font-style: italic; }

    /* Charts */
    .chart-container {
        background: white;
        padding: 15px;
        border-radius: 5px;
        min-height: 350px;
    }

    #rendement-chart-container {
        min-height: 400px;
    }

    /* Loading overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        gap: 15px;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #E0DEDD;
        border-top: 4px solid #004080;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .vl-sidebar {
            width: 200px;
            min-width: 200px;
        }
    }

    @media (max-width: 768px) {
        .vl-page-container {
            flex-direction: column;
        }

        .vl-sidebar {
            width: 100%;
            position: static;
            max-height: none;
        }
    }

    /* Scrollbar compact */
    .vl-sidebar::-webkit-scrollbar,
    .fcp-selection-compact::-webkit-scrollbar {
        width: 5px;
    }

    .vl-sidebar::-webkit-scrollbar-track,
    .fcp-selection-compact::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    .vl-sidebar::-webkit-scrollbar-thumb,
    .fcp-selection-compact::-webkit-scrollbar-thumb {
        background: #c0c0c0;
        border-radius: 3px;
    }

    /* Styles pour le graphique d'√©volution */
    .evolution-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        align-items: flex-end;
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .evolution-filter-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .evolution-filter-label {
        font-size: 0.85em;
        font-weight: 600;
        color: #333333;
    }

    .evolution-select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 0.9em;
        min-width: 250px;
        background: white;
    }

    .evolution-select:focus {
        outline: none;
        border-color: #004080;
    }

    .evolution-period-pills {
        display: flex;
        gap: 5px;
    }

    .period-pill {
        cursor: pointer;
    }

    .period-pill input {
        display: none;
    }

    .period-pill span {
        display: inline-block;
        padding: 6px 14px;
        font-size: 0.85em;
        background: #E0DEDD;
        border-radius: 20px;
        transition: all 0.2s;
        font-weight: 500;
    }

    .period-pill input:checked + span {
        background: #004080;
        color: white;
    }

    .period-pill:hover span {
        background: #c5c3c2;
    }

    .checkbox-inline {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        font-size: 0.85em;
        padding: 8px 0;
    }

    .checkbox-inline input {
        width: 16px;
        height: 16px;
    }

    .chart-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 300px;
        color: #333333;
        text-align: center;
    }

    .chart-placeholder span {
        font-size: 3em;
        margin-bottom: 15px;
    }

    .chart-placeholder p {
        font-size: 1.1em;
        margin: 0;
    }

    #evolution-chart-container {
        min-height: 350px;
    }

    .benchmark-info {
        margin-top: 15px;
        padding: 10px 15px;
        background: #E0DEDD;
        border-radius: 5px;
        font-size: 0.85em;
        color: #004080;
    }

    .benchmark-tag {
        font-weight: 600;
    }

    /* Carte derni√®re VL */
    .derniere-vl-card {
        margin-top: 20px;
        background: #004080;
        border-radius: 12px;
        padding: 20px;
        color: white;
        box-shadow: 0 4px 15px rgba(0, 64, 128, 0.3);
    }

    .vl-card-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
        padding-bottom: 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .vl-card-icon {
        font-size: 1.5em;
    }

    .vl-card-title {
        font-size: 1.1em;
        font-weight: 600;
    }

    .vl-card-content {
        display: flex;
        justify-content: space-around;
        flex-wrap: wrap;
        gap: 15px;
    }

    .vl-card-row {
        text-align: center;
        min-width: 100px;
    }

    .vl-card-label {
        display: block;
        font-size: 0.8em;
        opacity: 0.8;
        margin-bottom: 5px;
    }

    .vl-card-value {
        display: block;
        font-size: 1.2em;
        font-weight: 700;
    }

    .vl-value-main {
        font-size: 1.5em;
        color: #ffd700;
    }

    .perf-positive {
        color: #2ecc71;
    }

    .perf-negative {
        color: #ff6b6b;
    }

    /* Styles pour la Section 3 - Statistiques */
    .heatmap-container {
        overflow-x: auto;
        padding: 10px;
    }

    #correlation-heatmap {
        display: grid;
        gap: 2px;
        font-size: 0.75em;
    }

    .heatmap-cell {
        width: 60px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 3px;
        font-weight: 600;
        transition: transform 0.2s;
    }

    .heatmap-cell:hover {
        transform: scale(1.1);
        z-index: 10;
    }

    .heatmap-header {
        background: #004080;
        color: white;
        font-weight: 700;
        font-size: 0.7em;
        text-align: center;
        padding: 5px 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .heatmap-row-header {
        background: #004080;
        color: white;
        font-weight: 600;
        font-size: 0.7em;
        padding: 5px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 120px;
    }

    .heatmap-legend {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin-top: 15px;
        padding: 10px;
    }

    .legend-gradient {
        width: 200px;
        height: 20px;
        background: linear-gradient(to right, #e74c3c, #f39c12, #f1f1f1, #3498db, #004080);
        border-radius: 3px;
    }

    .legend-label {
        font-weight: 600;
        color: #333333;
        font-size: 0.9em;
    }

    /* Box plot styles */
    #boxplot-container {
        position: relative;
    }

    .boxplot-tooltip {
        position: absolute;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 8px 12px;
        border-radius: 5px;
        font-size: 0.85em;
        pointer-events: none;
        z-index: 100;
    }
</style>

<!-- Charger Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<!-- Adaptateur de date pour les axes temporels -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<script>
    // Donn√©es pass√©es depuis Django
    const classificationData = {{ classification_data|safe }};
    let performanceData = {{ performance_data|safe }};
    
    // V√©rifier que les donn√©es sont bien charg√©es
    console.log('Classification Data:', classificationData);
    console.log('Performance Data:', performanceData);
    
    // Donn√©es de performances multi-p√©riodes (sera charg√© via API)
    let multiPeriodData = {};
    
    // Instances des graphiques
    let scatterChart = null;
    let rendementChart = null;

    // === FONCTIONS UTILITAIRES ===
    
    function toggleSection(header) {
        const subsection = header.parentElement;
        subsection.classList.toggle('collapsed');
    }

    function showLoading(show) {
        const loadingIndicator = document.getElementById('loading-indicator');
        if (loadingIndicator) {
            loadingIndicator.style.display = show ? 'flex' : 'none';
        }
    }

    // Obtenir les noms des FCP s√©lectionn√©s
    function getSelectedFcpNames() {
        return Array.from(document.querySelectorAll('.fcp-checkbox:checked'))
            .map(cb => cb.dataset.nom);
    }

    // Obtenir les IDs des FCP s√©lectionn√©s
    function getSelectedFcpIds() {
        return Array.from(document.querySelectorAll('.fcp-checkbox:checked'))
            .map(cb => parseInt(cb.value));
    }

    // Obtenir les types de fond s√©lectionn√©s
    function getSelectedTypes() {
        const checked = Array.from(document.querySelectorAll('.type-fond-checkbox:checked'))
            .map(cb => cb.value);
        return checked;
    }

    // Obtenir les profils de risque s√©lectionn√©s
    function getSelectedProfils() {
        const checked = Array.from(document.querySelectorAll('.profil-risque-checkbox:checked'))
            .map(cb => cb.value);
        return checked;
    }

    // V√©rifier si un FCP passe les filtres (pour classification)
    function fcpPassesFilters(item, selectedFcpIds, selectedTypes, selectedProfils) {
        if (!selectedFcpIds.includes(item.id)) return false;
        
        if (selectedTypes.length > 0) {
            const itemType = item.type_fcp || '';
            if (!selectedTypes.some(type => itemType.includes(type))) return false;
        }
        
        if (selectedProfils.length > 0) {
            if (!selectedProfils.includes(item.profil_risque)) return false;
        }
        
        return true;
    }

    // V√©rifier si un item de performance passe les filtres
    function performancePassesFilters(item, selectedFcpNames, selectedTypes, selectedProfils) {
        if (!selectedFcpNames.includes(item.nom)) return false;
        
        if (selectedTypes.length > 0) {
            const itemType = item.type || '';
            if (!selectedTypes.some(type => itemType.includes(type))) return false;
        }
        
        if (selectedProfils.length > 0) {
            if (!selectedProfils.includes(item.profil)) return false;
        }
        
        return true;
    }

    // Formater les benchmarks en pourcentage
    function formatBenchmark(value) {
        if (value === '-' || value === null || value === undefined) return '-';
        return (value * 100).toFixed(0) + '%';
    }

    // Obtenir la classe de couleur pour une performance (heatmap)
    function getPerformanceClass(value) {
        if (value === null || value === undefined || isNaN(value)) return 'perf-na';
        if (value === 0) return 'perf-neutral';
        
        const absValue = Math.abs(value);
        let level = 1;
        if (absValue >= 20) level = 5;
        else if (absValue >= 10) level = 4;
        else if (absValue >= 5) level = 3;
        else if (absValue >= 2) level = 2;
        
        return value > 0 ? `perf-positive-${level}` : `perf-negative-${level}`;
    }

    // Formater une valeur de performance
    function formatPerformance(value) {
        if (value === null || value === undefined || isNaN(value)) return 'N/A';
        const sign = value >= 0 ? '+' : '';
        return `${sign}${value.toFixed(2)}%`;
    }

    // === API CALLS ===

    async function fetchPerformanceData() {
        const periode = document.getElementById('periode-analyse').value;
        const dateDebut = document.getElementById('date-debut').value;
        const dateFin = document.getElementById('date-fin').value;
        
        const params = new URLSearchParams();
        params.append('periode', periode);
        if (periode === 'personnalise') {
            if (dateDebut) params.append('date_debut', dateDebut);
            if (dateFin) params.append('date_fin', dateFin);
        }
        
        try {
            showLoading(true);
            const response = await fetch(`/api/performance-data/?${params.toString()}`);
            const data = await response.json();
            
            performanceData = data.performance_data;
            updatePeriodDisplay(data.periode_info);
            applyFilters();
        } catch (error) {
            console.error('Erreur lors du chargement des donn√©es:', error);
        } finally {
            showLoading(false);
        }
    }

    async function fetchMultiPeriodData() {
        const periodes = ['wtd', 'mtd', 'qtd', 'std', 'ytd', '1m', '3m', '6m', '1y', '5y', 'origine'];
        
        try {
            showLoading(true);
            // Limiter les requ√™tes parall√®les √† 3 pour ne pas surcharger le serveur
            const batchSize = 3;
            for (let i = 0; i < periodes.length; i += batchSize) {
                const batch = periodes.slice(i, i + batchSize);
                const promises = batch.map(periode => 
                    fetch(`/api/performance-data/?periode=${periode}`)
                        .then(res => res.json())
                        .then(data => ({ periode, data: data.performance_data }))
                        .catch(err => {
                            console.error(`Erreur pour p√©riode ${periode}:`, err);
                            return { periode, data: [] };
                        })
                );
                
                const results = await Promise.all(promises);
                
                results.forEach(({ periode, data }) => {
                    if (data) {
                        multiPeriodData[periode] = data;
                    }
                });
            }
            
            fillPerformancesCalendaires();
            fillPerformancesGlissantes();
        } catch (error) {
            console.error('Erreur lors du chargement des donn√©es multi-p√©riodes:', error);
        } finally {
            showLoading(false);
        }
    }

    function updatePeriodDisplay(periodeInfo) {
        const periodDisplay = document.getElementById('period-display');
        if (periodDisplay && periodeInfo) {
            let text = periodeInfo.type.toUpperCase();
            if (periodeInfo.date_debut && periodeInfo.date_fin) {
                text = `${periodeInfo.date_debut} ‚Üí ${periodeInfo.date_fin}`;
            } else if (periodeInfo.type === 'origine') {
                text = 'Origine';
            }
            periodDisplay.textContent = text;
        }
    }

    // === REMPLISSAGE DES TABLEAUX ===

    function fillClassificationTable() {
        const tbody = document.getElementById('classification-tbody');
        
        const selectedFcpIds = getSelectedFcpIds();
        const selectedTypes = getSelectedTypes();
        const selectedProfils = getSelectedProfils();
        
        const filteredData = classificationData.filter(item => 
            fcpPassesFilters(item, selectedFcpIds, selectedTypes, selectedProfils)
        );
        
        if (filteredData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#333333;">Aucun FCP s√©lectionn√©</td></tr>';
            return;
        }
        
        // Construire le HTML en une seule passe
        let html = filteredData.map(item => `
            <tr>
                <td><strong>${item.nom}</strong></td>
                <td>${item.type_fcp}</td>
                <td>${item.echelle_risque}</td>
                <td>${item.profil_risque}</td>
                <td>${formatBenchmark(item.benchmark_obligataire)}</td>
                <td>${formatBenchmark(item.benchmark_brvmc)}</td>
                <td>${item.horizon}</td>
            </tr>
        `).join('');
        
        tbody.innerHTML = html;
    }

    function fillPerformanceTable() {
        const tbody = document.getElementById('performance-tbody');
        
        const selectedFcpNames = getSelectedFcpNames();
        const selectedTypes = getSelectedTypes();
        const selectedProfils = getSelectedProfils();
        
        const filteredData = performanceData
            .filter(item => performancePassesFilters(item, selectedFcpNames, selectedTypes, selectedProfils))
            .sort((a, b) => b.performance - a.performance);
        
        if (filteredData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#333333;">Aucune donn√©e</td></tr>';
            return;
        }
        
        // Construire le HTML en une seule passe
        let html = filteredData.map(item => {
            const perfClass = item.performance >= 0 ? 'positive' : 'negative';
            return `
                <tr>
                    <td><strong>${item.nom}</strong></td>
                    <td class="${perfClass}">${item.performance.toFixed(2)}%</td>
                    <td>${item.volatilite.toFixed(2)}%</td>
                </tr>
            `;
        }).join('');
        
        tbody.innerHTML = html;
    }

    function fillRendementAnnualise() {
        const tbody = document.getElementById('rendement-annualise-tbody');
        const chartContainer = document.getElementById('rendement-chart-container');
        const canvas = document.getElementById('rendement-annualise-chart');
        
        const selectedFcpNames = getSelectedFcpNames();
        const selectedTypes = getSelectedTypes();
        const selectedProfils = getSelectedProfils();
        
        const filteredData = performanceData.filter(item => 
            performancePassesFilters(item, selectedFcpNames, selectedTypes, selectedProfils)
        );
        
        // Calculer le rendement annualis√©
        const rendementData = filteredData.map(item => {
            const nbJours = item.nb_jours || 0;
            let rendementAnnualise = 0;
            if (nbJours > 0) {
                const rendementDecimal = item.performance / 100;
                rendementAnnualise = (Math.pow(1 + rendementDecimal, 365 / nbJours) - 1) * 100;
            }
            return {
                nom: item.nom,
                rendement_annualise: rendementAnnualise,
                nb_jours: nbJours
            };
        }).sort((a, b) => b.rendement_annualise - a.rendement_annualise);
        
        // Remplir le tableau
        tbody.innerHTML = '';
        rendementData.forEach(item => {
            const tr = document.createElement('tr');
            const colorClass = item.rendement_annualise >= 0 ? 'positive' : 'negative';
            tr.innerHTML = `
                <td><strong>${item.nom}</strong></td>
                <td class="${colorClass}">${formatPerformance(item.rendement_annualise)}</td>
                <td>${item.nb_jours}</td>
            `;
            tbody.appendChild(tr);
        });
        
        if (rendementData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#333333;">Aucune donn√©e</td></tr>';
            return;
        }
        
        // Ajuster la hauteur du conteneur
        const minHeight = Math.max(350, rendementData.length * 28);
        chartContainer.style.height = minHeight + 'px';
        
        // Cr√©er le graphique
        if (rendementChart) {
            rendementChart.destroy();
        }
        
        const ctx = canvas.getContext('2d');
        const labels = rendementData.map(item => item.nom);
        const values = rendementData.map(item => item.rendement_annualise);
        const colors = values.map(v => v >= 0 ? 'rgba(39, 174, 96, 0.8)' : 'rgba(231, 76, 60, 0.8)');
        const borderColors = values.map(v => v >= 0 ? 'rgba(39, 174, 96, 1)' : 'rgba(231, 76, 60, 1)');
        
        rendementChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Rendement Annualis√© (%)',
                    data: values,
                    backgroundColor: colors,
                    borderColor: borderColors,
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: `Rendement Annualis√© (${rendementData.length} FCP)`,
                        font: { size: 14, weight: 'bold' }
                    },
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: ctx => formatPerformance(ctx.raw)
                        }
                    }
                },
                scales: {
                    x: {
                        title: { display: true, text: 'Rendement (%)', font: { size: 12, weight: 'bold' } },
                        grid: {
                            color: ctx => ctx.tick.value === 0 ? 'rgba(0,0,0,0.3)' : 'rgba(0,0,0,0.1)',
                            lineWidth: ctx => ctx.tick.value === 0 ? 2 : 1
                        }
                    },
                    y: {
                        ticks: { font: { size: 10 } }
                    }
                }
            }
        });
    }

    function fillPerformancesCalendaires() {
        const tbody = document.getElementById('perf-calendaires-tbody');
        
        const selectedFcpNames = getSelectedFcpNames();
        const selectedTypes = getSelectedTypes();
        const selectedProfils = getSelectedProfils();
        const periodes = ['wtd', 'mtd', 'qtd', 'std', 'ytd'];
        
        // Cr√©er un map de FCP -> performances par p√©riode
        const fcpPerfs = {};
        
        periodes.forEach(periode => {
            const data = multiPeriodData[periode] || [];
            data.forEach(item => {
                if (!fcpPerfs[item.nom]) {
                    fcpPerfs[item.nom] = { nom: item.nom, type: item.type, profil: item.profil };
                }
                fcpPerfs[item.nom][periode] = item.performance;
            });
        });
        
        // Filtrer et trier
        const filteredFcps = Object.values(fcpPerfs)
            .filter(item => performancePassesFilters(item, selectedFcpNames, selectedTypes, selectedProfils))
            .sort((a, b) => (b.ytd || 0) - (a.ytd || 0));
        
        if (filteredFcps.length === 0) {
            tbody.innerHTML = `<tr><td colspan="${periodes.length + 1}" style="text-align:center; color:#333333;">Aucune donn√©e</td></tr>`;
            return;
        }
        
        // Construire le HTML en une seule passe
        let html = filteredFcps.map(fcp => {
            let row = `<tr><td><strong>${fcp.nom}</strong></td>`;
            
            periodes.forEach(periode => {
                const value = fcp[periode];
                const perfClass = getPerformanceClass(value);
                row += `<td class="perf-cell ${perfClass}">${formatPerformance(value)}</td>`;
            });
            
            row += '</tr>';
            return row;
        }).join('');
        
        tbody.innerHTML = html;
    }

    function fillPerformancesGlissantes() {
        const tbody = document.getElementById('perf-glissantes-tbody');
        
        const selectedFcpNames = getSelectedFcpNames();
        const selectedTypes = getSelectedTypes();
        const selectedProfils = getSelectedProfils();
        const periodes = ['1m', '3m', '6m', '1y', '5y', 'origine'];
        
        // Cr√©er un map de FCP -> performances par p√©riode
        const fcpPerfs = {};
        
        periodes.forEach(periode => {
            const data = multiPeriodData[periode] || [];
            data.forEach(item => {
                if (!fcpPerfs[item.nom]) {
                    fcpPerfs[item.nom] = { nom: item.nom, type: item.type, profil: item.profil };
                }
                fcpPerfs[item.nom][periode] = item.performance;
            });
        });
        
        // Filtrer et trier
        const filteredFcps = Object.values(fcpPerfs)
            .filter(item => performancePassesFilters(item, selectedFcpNames, selectedTypes, selectedProfils))
            .sort((a, b) => (b['1y'] || b.origine || 0) - (a['1y'] || a.origine || 0));
        
        if (filteredFcps.length === 0) {
            tbody.innerHTML = `<tr><td colspan="${periodes.length + 1}" style="text-align:center; color:#333333;">Aucune donn√©e</td></tr>`;
            return;
        }
        
        // Construire le HTML en une seule passe
        let html = filteredFcps.map(fcp => {
            let row = `<tr><td><strong>${fcp.nom}</strong></td>`;
            
            periodes.forEach(periode => {
                const value = fcp[periode];
                const perfClass = getPerformanceClass(value);
                row += `<td class="perf-cell ${perfClass}">${formatPerformance(value)}</td>`;
            });
            
            row += '</tr>';
            return row;
        }).join('');
        
        tbody.innerHTML = html;
    }

    function updateScatterChart() {
        const ctx = document.getElementById('performance-volatility-chart');
        
        const selectedFcpIds = getSelectedFcpIds();
        const selectedTypes = getSelectedTypes();
        const selectedProfils = getSelectedProfils();
        
        const classificationMap = {};
        classificationData.forEach(item => {
            classificationMap[item.id] = item;
        });
        
        const filteredData = [];
        const unfilteredData = [];
        
        performanceData.forEach(item => {
            const classInfo = classificationMap[item.id] || {};
            const fullItem = { ...item, ...classInfo };
            
            if (fcpPassesFilters(fullItem, selectedFcpIds, selectedTypes, selectedProfils)) {
                filteredData.push(item);
            } else {
                unfilteredData.push(item);
            }
        });
        
        const datasets = [];
        
        if (unfilteredData.length > 0) {
            datasets.push({
                label: 'Autres FCP',
                data: unfilteredData.map(item => ({ x: item.volatilite, y: item.performance, label: item.nom })),
                backgroundColor: 'rgba(189, 195, 199, 0.4)',
                borderColor: 'rgba(189, 195, 199, 0.6)',
                borderWidth: 1,
                pointRadius: 5,
                pointHoverRadius: 7,
            });
        }
        
        if (filteredData.length > 0) {
            datasets.push({
                label: 'FCP s√©lectionn√©s',
                data: filteredData.map(item => ({ x: item.volatilite, y: item.performance, label: item.nom })),
                backgroundColor: 'rgba(52, 152, 219, 0.8)',
                borderColor: 'rgba(41, 128, 185, 1)',
                borderWidth: 2,
                pointRadius: 8,
                pointHoverRadius: 10,
            });
        }
        
        if (scatterChart) {
            scatterChart.destroy();
        }
        
        scatterChart = new Chart(ctx, {
            type: 'scatter',
            data: { datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 2,
                plugins: {
                    title: {
                        display: true,
                        text: `Performance vs Volatilit√© (${filteredData.length} FCP)`,
                        font: { size: 14, weight: 'bold' }
                    },
                    legend: { display: true, position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: ctx => `${ctx.raw.label}: Perf. ${ctx.raw.y.toFixed(2)}%, Vol. ${ctx.raw.x.toFixed(2)}%`
                        }
                    }
                },
                scales: {
                    x: {
                        title: { display: true, text: 'Volatilit√© (%)', font: { size: 12, weight: 'bold' } },
                        beginAtZero: true
                    },
                    y: {
                        title: { display: true, text: 'Performance (%)', font: { size: 12, weight: 'bold' } }
                    }
                }
            }
        });
    }

    // === FONCTION PRINCIPALE ===
    
    let filterTimeout = null;
    
    function applyFilters() {
        // Debounce les appels rapides de filtres
        if (filterTimeout) {
            clearTimeout(filterTimeout);
        }
        
        filterTimeout = setTimeout(() => {
            fillClassificationTable();
            fillPerformanceTable();
            updateScatterChart();
            fillRendementAnnualise();
            fillPerformancesCalendaires();
            fillPerformancesGlissantes();
            // Section 3 : Statistiques descriptives
            if (typeof fetchStatsDescriptives === 'function') {
                fetchStatsDescriptives();
            }
        }, 300); // Attendre 300ms avant de mettre √† jour
    }

    // === EVENT LISTENERS ===

    document.getElementById('periode-analyse').addEventListener('change', function() {
        const datesPersonnalisees = document.getElementById('dates-personnalisees');
        if (this.value === 'personnalise') {
            datesPersonnalisees.style.display = 'block';
        } else {
            datesPersonnalisees.style.display = 'none';
            fetchPerformanceData();
        }
    });

    document.getElementById('date-debut').addEventListener('change', function() {
        if (document.getElementById('periode-analyse').value === 'personnalise') {
            fetchPerformanceData();
        }
    });

    document.getElementById('date-fin').addEventListener('change', function() {
        if (document.getElementById('periode-analyse').value === 'personnalise') {
            fetchPerformanceData();
        }
    });

    document.getElementById('select-all-fcps').addEventListener('click', function() {
        document.querySelectorAll('.fcp-checkbox').forEach(cb => cb.checked = true);
        applyFilters();
    });

    document.getElementById('deselect-all-fcps').addEventListener('click', function() {
        document.querySelectorAll('.fcp-checkbox').forEach(cb => cb.checked = false);
        applyFilters();
    });

    document.getElementById('reinitialiser-filtres').addEventListener('click', function() {
        document.querySelectorAll('.fcp-checkbox').forEach(cb => cb.checked = true);
        document.querySelectorAll('.type-fond-checkbox').forEach(cb => cb.checked = false);
        document.querySelectorAll('.profil-risque-checkbox').forEach(cb => cb.checked = false);
        document.getElementById('periode-analyse').value = 'origine';
        document.getElementById('dates-personnalisees').style.display = 'none';
        fetchPerformanceData();
    });

    document.querySelectorAll('.filter-checkbox').forEach(cb => {
        cb.addEventListener('change', applyFilters);
    });

    // Navigation fluide
    document.querySelectorAll('.nav-link, .sub-nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                // Mettre √† jour la classe active
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                if (this.classList.contains('nav-link')) {
                    this.classList.add('active');
                } else {
                    this.closest('li').parentElement.previousElementSibling?.classList.add('active');
                }
            }
        });
    });

    // === √âVOLUTION VL ===

    let evolutionChart = null;

    async function fetchEvolutionData() {
        const fcpSelect = document.getElementById('evolution-fcp-select');
        const fcpId = fcpSelect.value;
        const periode = document.querySelector('input[name="evolution-periode"]:checked')?.value || 'tout';
        
        if (!fcpId) {
            // Afficher placeholder si aucun FCP s√©lectionn√©
            document.getElementById('evolution-placeholder').style.display = 'flex';
            document.getElementById('evolution-vl-chart').style.display = 'none';
            document.getElementById('benchmark-info').style.display = 'none';
            document.getElementById('derniere-vl-card').style.display = 'none';
            if (evolutionChart) {
                evolutionChart.destroy();
                evolutionChart = null;
            }
            return;
        }
        
        try {
            const response = await fetch(`/api/evolution-vl/?fcp_id=${fcpId}&periode=${periode}`);
            const data = await response.json();
            
            if (data.error) {
                console.error('Erreur API:', data.error);
                return;
            }
            
            updateEvolutionChart(data);
            updateBenchmarkInfo(data.benchmark_info);
            updateDerniereVL(data.derniere_vl);
            
        } catch (error) {
            console.error('Erreur lors du chargement des donn√©es d\'√©volution:', error);
        }
    }

    function updateEvolutionChart(data) {
        const ctx = document.getElementById('evolution-vl-chart').getContext('2d');
        const showBenchmark = document.getElementById('show-benchmark').checked;
        
        // Masquer placeholder, afficher canvas
        document.getElementById('evolution-placeholder').style.display = 'none';
        document.getElementById('evolution-vl-chart').style.display = 'block';
        
        // Pr√©parer les datasets
        const datasets = [{
            label: data.fcp_nom,
            data: data.evolution_fcp.map(item => ({ x: item.date, y: item.valeur })),
            borderColor: '#004080',
            backgroundColor: 'rgba(0, 64, 128, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 0,
            pointHoverRadius: 5,
            borderWidth: 2
        }];
        
        if (showBenchmark && data.evolution_benchmark && data.evolution_benchmark.length > 0) {
            datasets.push({
                label: 'Benchmark composite',
                data: data.evolution_benchmark.map(item => ({ x: item.date, y: item.valeur })),
                borderColor: '#333333',
                backgroundColor: 'rgba(51, 51, 51, 0.05)',
                fill: false,
                tension: 0.3,
                pointRadius: 0,
                pointHoverRadius: 5,
                borderWidth: 2,
                borderDash: [5, 5]
            });
        }
        
        if (evolutionChart) {
            evolutionChart.destroy();
        }
        
        evolutionChart = new Chart(ctx, {
            type: 'line',
            data: { datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    title: {
                        display: true,
                        text: `√âvolution cumul√©e - ${data.fcp_nom}`,
                        font: { size: 14, weight: 'bold' }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${context.parsed.y.toFixed(2)}%`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'month',
                            displayFormats: {
                                day: 'dd MMM',
                                month: 'MMM yyyy',
                                year: 'yyyy'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Date',
                            font: { size: 12, weight: 'bold' }
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Performance cumul√©e (%)',
                            font: { size: 12, weight: 'bold' }
                        },
                        ticks: {
                            callback: function(value) {
                                return value.toFixed(1) + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    function updateBenchmarkInfo(info) {
        const container = document.getElementById('benchmark-info');
        const composition = document.getElementById('benchmark-composition');
        
        if (!info) {
            container.style.display = 'none';
            composition.innerHTML = '';
            return;
        }
        
        const obligLabel = info.benchmark_obligataire || 'Benchmark Obligataire';
        const actionsLabel = info.benchmark_actions || 'Benchmark Actions';
        
        composition.innerHTML = `
            <span>${obligLabel} (${(info.poids_obligataire * 100).toFixed(0)}%)</span> + 
            <span>${actionsLabel} (${(info.poids_actions * 100).toFixed(0)}%)</span>
        `;
        container.style.display = 'block';
    }

    function updateDerniereVL(vlInfo) {
        const card = document.getElementById('derniere-vl-card');
        const dateEl = document.getElementById('derniere-vl-date');
        const valeurEl = document.getElementById('derniere-vl-valeur');
        const perfEl = document.getElementById('derniere-vl-perf');
        
        if (!vlInfo) {
            card.style.display = 'none';
            return;
        }
        
        // Formater la date
        const date = new Date(vlInfo.date);
        const options = { day: '2-digit', month: 'short', year: 'numeric' };
        dateEl.textContent = date.toLocaleDateString('fr-FR', options);
        
        // Formater la valeur
        valeurEl.textContent = vlInfo.valeur.toLocaleString('fr-FR', { 
            minimumFractionDigits: 2, 
            maximumFractionDigits: 4 
        }) + ' FCFA';
        
        // Formater la performance avec couleur
        const perf = vlInfo.performance;
        perfEl.textContent = (perf >= 0 ? '+' : '') + perf.toFixed(2) + '%';
        perfEl.className = 'vl-card-value ' + (perf >= 0 ? 'perf-positive' : 'perf-negative');
        
        card.style.display = 'block';
    }

    // Event listeners pour l'√©volution VL
    document.getElementById('evolution-fcp-select')?.addEventListener('change', fetchEvolutionData);
    
    document.querySelectorAll('input[name="evolution-periode"]').forEach(radio => {
        radio.addEventListener('change', fetchEvolutionData);
    });
    
    document.getElementById('show-benchmark')?.addEventListener('change', function() {
        // Si d√©j√† des donn√©es, juste recharger le graphique pour afficher/masquer le benchmark
        fetchEvolutionData();
    });

    // === SECTION 3 : STATISTIQUES DESCRIPTIVES ===

    let boxplotChart = null;
    let statsData = null;

    async function fetchStatsDescriptives() {
        const periode = document.getElementById('periode-analyse').value;
        const selectedFcps = Array.from(document.querySelectorAll('.fcp-checkbox:checked'))
            .map(cb => cb.value);
        
        console.log('fetchStatsDescriptives appel√©e:', {
            periode,
            selectedFcpsCount: selectedFcps.length,
            selectedFcps: selectedFcps.slice(0, 3)
        });
        
        if (selectedFcps.length === 0) {
            console.log('Aucun FCP s√©lectionn√©');
            clearStatsSection();
            return;
        }
        
        try {
            const params = new URLSearchParams();
            params.append('periode', periode);
            selectedFcps.forEach(id => params.append('fcp_ids', id));
            
            const url = `/api/stats-descriptives/?${params.toString()}`;
            console.log('Appel API:', url);
            
            const response = await fetch(url);
            statsData = await response.json();
            
            console.log('R√©ponse re√ßue:', {
                statsCount: statsData.stats ? statsData.stats.length : 0,
                hasCorrelation: !!statsData.correlation
            });
            
            if (statsData.stats && statsData.stats.length > 0) {
                console.log('Rendu des statistiques...');
                renderBoxplot(statsData.stats);
                renderStatsTable(statsData.stats);
                renderCorrelationHeatmap(statsData.correlation);
            } else {
                console.log('Aucune donn√©e de stat re√ßue');
                clearStatsSection();
            }
        } catch (error) {
            console.error('Erreur lors du chargement des statistiques:', error);
        }
    }

    function clearStatsSection() {
        if (boxplotChart) {
            boxplotChart.destroy();
            boxplotChart = null;
        }
        document.getElementById('stats-tbody').innerHTML = 
            '<tr><td colspan="8" style="text-align:center; color:#333333;">Aucune donn√©e disponible</td></tr>';
        document.getElementById('correlation-heatmap').innerHTML = '';
    }

    function renderBoxplot(stats) {
        const ctx = document.getElementById('boxplot-chart').getContext('2d');
        
        if (boxplotChart) {
            boxplotChart.destroy();
        }
        
        // Pr√©parer les donn√©es pour le boxplot
        const labels = stats.map(s => s.fcp_nom.length > 20 ? s.fcp_nom.substring(0, 17) + '...' : s.fcp_nom);
        const boxplotData = stats.map(s => ({
            min: s.boxplot.min,
            q1: s.boxplot.q1,
            median: s.boxplot.median,
            q3: s.boxplot.q3,
            max: s.boxplot.max
        }));
        
        // Cr√©er un graphique √† barres horizontales pour simuler le boxplot
        const datasets = [
            {
                label: 'Min-Q1',
                data: boxplotData.map(d => d.q1 - d.min),
                backgroundColor: 'rgba(0, 64, 128, 0.2)',
                borderColor: '#004080',
                borderWidth: 1,
                stack: 'box'
            },
            {
                label: 'Q1-M√©diane',
                data: boxplotData.map(d => d.median - d.q1),
                backgroundColor: 'rgba(0, 64, 128, 0.5)',
                borderColor: '#004080',
                borderWidth: 1,
                stack: 'box'
            },
            {
                label: 'M√©diane-Q3',
                data: boxplotData.map(d => d.q3 - d.median),
                backgroundColor: 'rgba(0, 64, 128, 0.7)',
                borderColor: '#004080',
                borderWidth: 1,
                stack: 'box'
            },
            {
                label: 'Q3-Max',
                data: boxplotData.map(d => d.max - d.q3),
                backgroundColor: 'rgba(0, 64, 128, 0.3)',
                borderColor: '#004080',
                borderWidth: 1,
                stack: 'box'
            }
        ];
        
        // Offset pour les valeurs n√©gatives
        const minValues = boxplotData.map(d => d.min);
        
        boxplotChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Offset',
                    data: minValues,
                    backgroundColor: 'transparent',
                    borderColor: 'transparent',
                    stack: 'box'
                }, ...datasets]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: {
                        display: true,
                        text: 'Distribution des Rendements Journaliers (%)',
                        font: { size: 14, weight: 'bold' }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const idx = context.dataIndex;
                                const stat = stats[idx];
                                return [
                                    `Min: ${stat.boxplot.min.toFixed(3)}%`,
                                    `Q1: ${stat.boxplot.q1.toFixed(3)}%`,
                                    `M√©diane: ${stat.boxplot.median.toFixed(3)}%`,
                                    `Q3: ${stat.boxplot.q3.toFixed(3)}%`,
                                    `Max: ${stat.boxplot.max.toFixed(3)}%`
                                ];
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                        title: {
                            display: true,
                            text: 'Rendement journalier (%)',
                            font: { weight: 'bold' }
                        }
                    },
                    y: {
                        stacked: true,
                        ticks: {
                            font: { size: 10 }
                        }
                    }
                }
            }
        });
    }

    function renderStatsTable(stats) {
        const tbody = document.getElementById('stats-tbody');
        
        if (!stats || stats.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:#333333;">Aucune donn√©e</td></tr>';
            return;
        }
        
        let html = '';
        stats.forEach(stat => {
            const meanClass = stat.mean >= 0 ? 'positive' : 'negative';
            const medianClass = stat.median >= 0 ? 'positive' : 'negative';
            
            html += `
                <tr>
                    <td><strong>${stat.fcp_nom}</strong></td>
                    <td class="${meanClass}">${stat.mean.toFixed(4)}</td>
                    <td class="${medianClass}">${stat.median.toFixed(4)}</td>
                    <td>${stat.std.toFixed(4)}</td>
                    <td class="negative">${stat.min.toFixed(4)}</td>
                    <td class="positive">${stat.max.toFixed(4)}</td>
                    <td>${stat.skewness.toFixed(4)}</td>
                    <td>${stat.kurtosis.toFixed(4)}</td>
                </tr>
            `;
        });
        
        tbody.innerHTML = html;
    }

    function renderCorrelationHeatmap(correlation) {
        const container = document.getElementById('correlation-heatmap');
        
        if (!correlation || !correlation.labels || correlation.labels.length < 2) {
            container.innerHTML = '<p style="text-align:center; color:#333333;">S√©lectionnez au moins 2 FCP pour afficher les corr√©lations</p>';
            return;
        }
        
        const labels = correlation.labels;
        const matrix = correlation.matrix;
        const n = labels.length;
        
        // Cr√©er la grille
        let html = `<div style="display: grid; grid-template-columns: 120px repeat(${n}, 60px); gap: 2px;">`;
        
        // En-t√™te vide + colonnes
        html += '<div class="heatmap-header"></div>';
        labels.forEach(label => {
            const shortLabel = label.length > 10 ? label.substring(0, 8) + '..' : label;
            html += `<div class="heatmap-header" title="${label}">${shortLabel}</div>`;
        });
        
        // Lignes
        for (let i = 0; i < n; i++) {
            const shortLabel = labels[i].length > 15 ? labels[i].substring(0, 13) + '..' : labels[i];
            html += `<div class="heatmap-row-header" title="${labels[i]}">${shortLabel}</div>`;
            
            for (let j = 0; j < n; j++) {
                const corr = matrix[i][j];
                const color = getCorrelationColor(corr);
                const textColor = Math.abs(corr) > 0.5 ? 'white' : '#333333';
                
                html += `<div class="heatmap-cell" style="background-color: ${color}; color: ${textColor};" 
                         title="${labels[i]} vs ${labels[j]}: ${corr.toFixed(3)}">
                    ${corr.toFixed(2)}
                </div>`;
            }
        }
        
        html += '</div>';
        container.innerHTML = html;
    }

    function getCorrelationColor(corr) {
        // Palette de couleurs : rouge n√©gatif -> blanc neutre -> bleu positif
        if (corr >= 0.8) return '#004080';
        if (corr >= 0.6) return '#3366aa';
        if (corr >= 0.4) return '#6699cc';
        if (corr >= 0.2) return '#99bbdd';
        if (corr >= -0.2) return '#f1f1f1';
        if (corr >= -0.4) return '#f5b7b1';
        if (corr >= -0.6) return '#f1948a';
        if (corr >= -0.8) return '#e74c3c';
        return '#c0392b';
    }

    // === INITIALISATION ===

    // Tab Navigation Management
    function initializeTabs() {
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');

                // Remove active class from all buttons and contents
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));

                // Add active class to clicked button and corresponding content
                this.classList.add('active');
                const tabContent = document.getElementById(tabId);
                if (tabContent) {
                    tabContent.classList.add('active');
                }

                // Save the active tab to localStorage
                localStorage.setItem('activeTab', tabId);
            });
        });

        // Restore the last active tab from localStorage (only if not on first load)
        if (document.readyState === 'loading') {
            // Still loading, don't restore yet
            return;
        }
        
        const savedTab = localStorage.getItem('activeTab');
        if (savedTab && savedTab !== 'tab-section-1') {
            const savedButton = document.querySelector(`[data-tab="${savedTab}"]`);
            if (savedButton) {
                savedButton.click();
            }
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        initializeTabs();
        // Charger les donn√©es avant d'appliquer les filtres
        Promise.all([
            fetchMultiPeriodData(),
        ]).then(() => {
            applyFilters();
        }).catch(error => {
            console.error('Erreur lors du chargement initial:', error);
            applyFilters(); // Appliquer les filtres m√™me en cas d'erreur
        });
    });
</script>

{% endblock %}
