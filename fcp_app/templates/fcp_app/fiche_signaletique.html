{% extends 'fcp_app/base.html' %}
{% load static %}

{% block title %}Fiche Signalétique - FCP Reporting{% endblock %}

{% block extra_css %}
<style>
    /* FCP Selector Header */
    .fcp-selector-header {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 20px 24px;
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 16px;
    }
    
    .fcp-selector-header .select-label {
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: 4px;
    }
    
    .fcp-main-select {
        min-width: 300px;
        padding: 12px 40px 12px 16px;
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
        border: 2px solid var(--border-color);
        border-radius: 10px;
        background: var(--bg-primary);
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .fcp-main-select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px rgba(0, 64, 128, 0.1);
    }
    
    /* Risk Scale */
    .risk-scale-container {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 16px;
    }
    
    .risk-scale {
        display: flex;
        gap: 3px;
        margin: 12px 0 8px;
    }
    
    .risk-level {
        flex: 1;
        height: 32px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 12px;
        color: white;
        transition: all 0.3s ease;
        opacity: 0.4;
    }
    
    .risk-level.active {
        opacity: 1;
        transform: scaleY(1.15);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .risk-level-1 { background: #22c55e; }
    .risk-level-2 { background: #84cc16; }
    .risk-level-3 { background: #eab308; }
    .risk-level-4 { background: #f97316; }
    .risk-level-5 { background: #ef4444; }
    .risk-level-6 { background: #dc2626; }
    .risk-level-7 { background: #991b1b; }
    
    .risk-labels {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        color: var(--text-muted);
    }
    
    .risk-current-inline {
        text-align: right;
    }
    
    .risk-value-inline {
        font-size: 20px;
        font-weight: 700;
        color: var(--text-primary);
        display: block;
        line-height: 1;
    }
    
    .risk-label-inline {
        font-size: 11px;
        color: var(--text-secondary);
    }
    
    /* Info Cards Mini */
    .info-card-mini {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 12px;
        display: flex;
        align-items: center;
        gap: 10px;
        height: 100%;
        transition: all 0.2s ease;
    }
    
    .info-card-mini:hover {
        box-shadow: var(--shadow-sm);
    }
    
    .card-icon-mini {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        flex-shrink: 0;
    }
    
    .card-label-mini {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        color: var(--text-muted);
        margin-bottom: 2px;
    }
    
    .card-value-mini {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
        line-height: 1.2;
    }

    /* Info Cards */
    .info-card-compact {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 20px;
        height: 100%;
        transition: all 0.2s ease;
    }
    
    .info-card-compact:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }
    
    .info-card-compact .card-icon {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
        margin-bottom: 16px;
    }
    
    .info-card-compact .card-label {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-muted);
        margin-bottom: 6px;
    }
    
    .info-card-compact .card-value {
        font-size: 20px;
        font-weight: 700;
        color: var(--text-primary);
    }
    
    .info-card-compact .card-subtitle {
        font-size: 13px;
        color: var(--text-secondary);
        margin-top: 4px;
    }
    
    /* Benchmark Allocation - Donut Chart Style */
    .benchmark-allocation-card {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 16px;
    }
    
    .benchmark-donut-container {
        display: flex;
        align-items: center;
        gap: 20px;
    }
    
    .donut-wrapper {
        position: relative;
        width: 90px;
        height: 90px;
        flex-shrink: 0;
    }
    
    .donut-chart {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        transform: rotate(-90deg);
    }
    
    .donut-center {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }
    
    .donut-center-value {
        font-size: 14px;
        font-weight: 700;
        color: var(--text-primary);
        line-height: 1;
    }
    
    .donut-center-label {
        font-size: 9px;
        color: var(--text-muted);
        text-transform: uppercase;
    }
    
    .benchmark-details {
        flex: 1;
    }
    
    .benchmark-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        background: var(--bg-secondary);
        border-radius: 8px;
        margin-bottom: 6px;
    }
    
    .benchmark-item:last-child {
        margin-bottom: 0;
    }
    
    .benchmark-item-left {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .benchmark-color-indicator {
        width: 12px;
        height: 12px;
        border-radius: 3px;
        flex-shrink: 0;
    }
    
    .benchmark-item-name {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-primary);
    }
    
    .benchmark-item-value {
        font-size: 15px;
        font-weight: 700;
        color: var(--text-primary);
    }
    
    /* FCP Table */
    .fcp-table-container {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        overflow: hidden;
    }
    
    .fcp-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .fcp-table thead {
        background: var(--bg-secondary);
    }
    
    .fcp-table th {
        padding: 14px 16px;
        text-align: left;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-secondary);
        border-bottom: 1px solid var(--border-color);
    }
    
    .fcp-table td {
        padding: 14px 16px;
        font-size: 14px;
        color: var(--text-primary);
        border-bottom: 1px solid var(--border-light);
        vertical-align: middle;
    }
    
    .fcp-table tbody tr {
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .fcp-table tbody tr:hover {
        background: var(--third-color);
    }
    
    .fcp-table tbody tr.selected {
        background: var(--primary-light);
    }
    
    .fcp-name-cell {
        font-weight: 600;
        color: var(--primary-color);
    }
    
    .type-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
    }
    
    .risk-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        border-radius: 6px;
        font-weight: 700;
        font-size: 13px;
        color: white;
    }
    
    .horizon-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        color: var(--text-secondary);
        font-size: 13px;
    }
    
    /* Filter Pills for Table */
    .table-filters {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 20px;
        border-bottom: 1px solid var(--border-color);
        flex-wrap: wrap;
    }
    
    .filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .filter-label {
        font-size: 13px;
        color: var(--text-muted);
    }
    
    .mini-pill {
        padding: 4px 12px;
        border-radius: 16px;
        font-size: 12px;
        font-weight: 500;
        border: 1px solid var(--border-color);
        background: var(--bg-primary);
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .mini-pill:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
    }
    
    .mini-pill.active {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }
    
    /* Section Title */
    .section-title-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
    }
    
    .section-title-bar h3 {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .section-title-bar h3 i {
        color: var(--primary-color);
    }
    
    /* Stats Summary */
    .stats-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 16px;
        padding: 16px 20px;
        background: var(--bg-secondary);
        border-radius: 0 0 12px 12px;
    }
    
    .stat-item {
        text-align: center;
    }
    
    .stat-item .stat-number {
        font-size: 24px;
        font-weight: 700;
        color: var(--primary-color);
    }
    
    .stat-item .stat-label {
        font-size: 11px;
        text-transform: uppercase;
        color: var(--text-muted);
        margin-top: 4px;
    }
</style>
{% endblock %}

{% block content %}
<!-- FCP Selector Header -->
<div class="fcp-selector-header">
    <div>
        <div class="select-label">Sélectionner un FCP</div>
        <select class="fcp-main-select" id="fcpMainSelector">
            {% for fcp_name in fcp_list %}
            <option value="{{ fcp_name }}" {% if fcp_name == selected_fcp %}selected{% endif %}>{{ fcp_name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary">
            <i class="bi bi-printer me-1"></i> Imprimer
        </button>
        <button class="btn btn-primary">
            <i class="bi bi-download me-1"></i> Télécharger PDF
        </button>
    </div>
</div>

<!-- Main Content Grid -->
<div class="row">
    <!-- Left Column - Selected FCP Details -->
    <div class="col-lg-5 mb-4">
        <!-- Risk Scale Card - Compact -->
        <div class="risk-scale-container mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0" style="font-weight: 600; color: var(--text-primary);">
                    <i class="bi bi-speedometer2 me-2" style="color: var(--primary-color);"></i>
                    Échelle de Risque
                </h6>
                <div class="risk-current-inline">
                    <span class="risk-value-inline">{{ selected_fcp_data.echelle_risque }}/7</span>
                    <span class="risk-label-inline">{{ selected_fcp_data.risk_label }}</span>
                </div>
            </div>
            
            <div class="risk-scale">
                <div class="risk-level risk-level-1 {% if selected_fcp_data.echelle_risque == 1 %}active{% endif %}">1</div>
                <div class="risk-level risk-level-2 {% if selected_fcp_data.echelle_risque == 2 %}active{% endif %}">2</div>
                <div class="risk-level risk-level-3 {% if selected_fcp_data.echelle_risque == 3 %}active{% endif %}">3</div>
                <div class="risk-level risk-level-4 {% if selected_fcp_data.echelle_risque == 4 %}active{% endif %}">4</div>
                <div class="risk-level risk-level-5 {% if selected_fcp_data.echelle_risque == 5 %}active{% endif %}">5</div>
                <div class="risk-level risk-level-6 {% if selected_fcp_data.echelle_risque == 6 %}active{% endif %}">6</div>
                <div class="risk-level risk-level-7 {% if selected_fcp_data.echelle_risque == 7 %}active{% endif %}">7</div>
            </div>
            
            <div class="risk-labels">
                <span>Risque faible</span>
                <span>Risque élevé</span>
            </div>
        </div>
        
        <!-- Info Cards Grid - 2x2 Compact -->
        <div class="row g-2 mb-3">
            <div class="col-6">
                <div class="info-card-mini">
                    <div class="card-icon-mini" style="background: var(--primary-light); color: var(--primary-color);">
                        <i class="{{ selected_fcp_data.type_icon }}"></i>
                    </div>
                    <div>
                        <div class="card-label-mini">Type</div>
                        <div class="card-value-mini">{{ selected_fcp_data.type_fond }}</div>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="info-card-mini">
                    <div class="card-icon-mini" style="background: #d4edda; color: #28a745;">
                        <i class="bi bi-calendar-range"></i>
                    </div>
                    <div>
                        <div class="card-label-mini">Horizon</div>
                        <div class="card-value-mini">{{ selected_fcp_data.horizon }} ans</div>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="info-card-mini">
                    <div class="card-icon-mini" style="background: #fff3cd; color: #e6a800;">
                        <i class="bi bi-currency-exchange"></i>
                    </div>
                    <div>
                        <div class="card-label-mini">Devise</div>
                        <div class="card-value-mini">{{ selected_fcp_data.devise }}</div>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="info-card-mini">
                    <div class="card-icon-mini" style="background: #d1ecf1; color: #17a2b8;">
                        <i class="bi bi-building"></i>
                    </div>
                    <div>
                        <div class="card-label-mini">Gestionnaire</div>
                        <div class="card-value-mini" style="font-size: 13px;">{{ selected_fcp_data.gestionnaire }}</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Benchmark Allocation Card - Donut Chart -->
        <div class="benchmark-allocation-card">
            <h6 style="font-weight: 600; color: var(--text-primary); margin-bottom: 12px; font-size: 14px;">
                <i class="bi bi-pie-chart-fill me-2" style="color: var(--primary-color);"></i>
                Allocation Benchmark
            </h6>
            
            <div class="benchmark-donut-container">
                <!-- Donut Chart SVG -->
                <div class="donut-wrapper">
                    <svg class="donut-chart" viewBox="0 0 36 36" id="benchmarkDonut">
                        <!-- Background circle -->
                        <circle cx="18" cy="18" r="15.915" fill="none" stroke="#e9ecef" stroke-width="3"/>
                        <!-- Segments will be added by JS -->
                    </svg>
                    <div class="donut-center">
                        <div class="donut-center-value">100%</div>
                        <div class="donut-center-label">Total</div>
                    </div>
                </div>
                
                <!-- Legend Details -->
                <div class="benchmark-details">
                    <div class="benchmark-item">
                        <div class="benchmark-item-left">
                            <div class="benchmark-color-indicator" style="background: #004080;"></div>
                            <span class="benchmark-item-name">Obligataire</span>
                        </div>
                        <span class="benchmark-item-value" style="color: #004080;">{{ selected_fcp_data.benchmark_oblig }}%</span>
                    </div>
                    <div class="benchmark-item">
                        <div class="benchmark-item-left">
                            <div class="benchmark-color-indicator" style="background: #28a745;"></div>
                            <span class="benchmark-item-name">BRVM C</span>
                        </div>
                        <span class="benchmark-item-value" style="color: #28a745;">{{ selected_fcp_data.benchmark_brvmc }}%</span>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
        // Initialize donut chart
        document.addEventListener('DOMContentLoaded', function() {
            const oblig = {{ selected_fcp_data.benchmark_oblig }};
            const brvm = {{ selected_fcp_data.benchmark_brvmc }};
            const svg = document.getElementById('benchmarkDonut');
            const circumference = 2 * Math.PI * 15.915;
            
            // Create segments
            if (oblig > 0) {
                const segment1 = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                segment1.setAttribute('cx', '18');
                segment1.setAttribute('cy', '18');
                segment1.setAttribute('r', '15.915');
                segment1.setAttribute('fill', 'none');
                segment1.setAttribute('stroke', '#004080');
                segment1.setAttribute('stroke-width', '3.5');
                segment1.setAttribute('stroke-dasharray', `${oblig * circumference / 100} ${circumference}`);
                segment1.setAttribute('stroke-dashoffset', '0');
                svg.appendChild(segment1);
            }
            
            if (brvm > 0) {
                const segment2 = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                segment2.setAttribute('cx', '18');
                segment2.setAttribute('cy', '18');
                segment2.setAttribute('r', '15.915');
                segment2.setAttribute('fill', 'none');
                segment2.setAttribute('stroke', '#28a745');
                segment2.setAttribute('stroke-width', '3.5');
                segment2.setAttribute('stroke-dasharray', `${brvm * circumference / 100} ${circumference}`);
                segment2.setAttribute('stroke-dashoffset', `-${oblig * circumference / 100}`);
                svg.appendChild(segment2);
            }
        });
        </script>
    </div>
    
    <!-- Right Column - FCP Table -->
    <div class="col-lg-7 mb-4">
        <div class="section-title-bar">
            <h3>
                <i class="bi bi-list-ul"></i>
                Liste des FCP
            </h3>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-download me-1"></i> Exporter
                </button>
            </div>
        </div>
        
        <div class="fcp-table-container">
            <!-- Filters -->
            <div class="table-filters">
                <div class="filter-group">
                    <span class="filter-label">Type:</span>
                    <button class="mini-pill active" data-filter="all">Tous</button>
                    <button class="mini-pill" data-filter="Diversifié">Diversifié</button>
                    <button class="mini-pill" data-filter="Obligataire">Obligataire</button>
                    <button class="mini-pill" data-filter="Actions">Actions</button>
                    <button class="mini-pill" data-filter="Monétaire">Monétaire</button>
                </div>
            </div>
            
            <!-- Table -->
            <div style="max-height: 500px; overflow-y: auto;">
                <table class="fcp-table" id="fcpTable">
                    <thead>
                        <tr>
                            <th>Nom du FCP</th>
                            <th>Type</th>
                            <th style="text-align: center;">Risque</th>
                            <th style="text-align: center;">Horizon</th>
                            <th style="text-align: center;">Benchmark</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for fcp_name, data in fcp_data.items %}
                        <tr data-fcp="{{ fcp_name }}" data-type="{{ data.type_fond }}" class="{% if fcp_name == selected_fcp %}selected{% endif %}">
                            <td class="fcp-name-cell">{{ fcp_name }}</td>
                            <td>
                                <span class="type-badge" style="background: {{ data.type_color }}15; color: {{ data.type_color }};">
                                    <i class="{{ data.type_icon }}"></i>
                                    {{ data.type_fond }}
                                </span>
                            </td>
                            <td style="text-align: center;">
                                <span class="risk-badge risk-level-{{ data.echelle_risque }}">{{ data.echelle_risque }}</span>
                            </td>
                            <td style="text-align: center;">
                                <span class="horizon-badge">
                                    <i class="bi bi-clock"></i>
                                    {{ data.horizon }} ans
                                </span>
                            </td>
                            <td style="text-align: center;">
                                <small style="color: var(--text-muted);">
                                    <span style="color: #004080; font-weight: 600;">{{ data.benchmark_oblig }}%</span> / 
                                    <span style="color: #28a745; font-weight: 600;">{{ data.benchmark_brvmc }}%</span>
                                </small>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Stats Summary -->
            <div class="stats-summary">
                <div class="stat-item">
                    <div class="stat-number">{{ fcp_list|length }}</div>
                    <div class="stat-label">Total FCP</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="diversifiedCount">-</div>
                    <div class="stat-label">Diversifiés</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="obligataireCount">-</div>
                    <div class="stat-label">Obligataires</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="actionsCount">-</div>
                    <div class="stat-label">Actions</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Count FCP by type from table rows
    let counts = { 'Diversifié': 0, 'Obligataire': 0, 'Actions': 0, 'Monétaire': 0, 'Capital-Risque': 0 };
    document.querySelectorAll('#fcpTable tbody tr').forEach(row => {
        const type = row.dataset.type;
        if (counts.hasOwnProperty(type)) {
            counts[type]++;
        }
    });
    
    document.getElementById('diversifiedCount').textContent = counts['Diversifié'];
    document.getElementById('obligataireCount').textContent = counts['Obligataire'];
    document.getElementById('actionsCount').textContent = counts['Actions'];
    
    // Main FCP Selector
    const mainSelector = document.getElementById('fcpMainSelector');
    mainSelector.addEventListener('change', function() {
        window.location.href = '?fcp=' + encodeURIComponent(this.value);
    });
    
    // Table row click
    document.querySelectorAll('#fcpTable tbody tr').forEach(row => {
        row.addEventListener('click', function() {
            const fcpName = this.dataset.fcp;
            mainSelector.value = fcpName;
            window.location.href = '?fcp=' + encodeURIComponent(fcpName);
        });
    });
    
    // Filter pills
    document.querySelectorAll('.table-filters .mini-pill').forEach(pill => {
        pill.addEventListener('click', function() {
            // Update active state
            document.querySelectorAll('.table-filters .mini-pill').forEach(p => p.classList.remove('active'));
            this.classList.add('active');
            
            const filterType = this.dataset.filter;
            
            // Filter table rows
            document.querySelectorAll('#fcpTable tbody tr').forEach(row => {
                if (filterType === 'all' || row.dataset.type === filterType) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    });
    
    // Animate risk scale on load
    const activeRisk = document.querySelector('.risk-level.active');
    if (activeRisk) {
        activeRisk.style.transform = 'scaleY(1)';
        setTimeout(() => {
            activeRisk.style.transform = 'scaleY(1.15)';
        }, 300);
    }
});
</script>
{% endblock %}
